
# Read in packages
```
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
```

##########################################################################################################################
######################### SOUTHERN NEWFOUNDLAND CAGE SITE DISTANCES TEMPLATE CODE ########################################
##########################################################################################################################

## for low-res generic mapping
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/atlas/75m_prod/geog/shape/
prov <- readShapeSpatial("C:/Users/keyserf/Documents/R/canvec/pvp/pvp.shp", proj4string=CRS("+proj=longlat +ellps=GRS80 +no_defs"))
#prov <- fortify(model=prov)
```

## Calculate distances between points with boundaries, need fine scale data for raster
## SKIP DOWN IF ENVIRONMENT IS LOADED
### read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
#NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 46.8, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
# NL.low.ocean <- readOGR(dsn="./canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
# r <- raster(ncol=1125, nrow=560)
# extent(r) <- extent(NL.low.ocean)
# NLrast <- rasterize(NL.low.ocean, r, fun="first")

# NLline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Land_shp/shoreline_1_small.shp", "shoreline_1_small")

```

##### START HERE IF ENVIRONMENT IS READY #####
```{r}
# site coords
# read in sites from AQ sites NL script
sitecoords <- unique(select(sites, ID, Lat, Long))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# escaped fish location
escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
str(escapes)

escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")
names(rivers) <- c("code", "V1", "V2")
escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
escapemat <- as.data.frame(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))
escapemat <- rbind(escapemat, as.data.frame(rivers[,2:3]))
escapemat <- as.matrix(escapemat)

```

## River mouths
```{r}
## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
plot(NLrast)
text(escapemat[,1], escapemat[,2])
lines(NLline)
# rivermouths <- SpatialPoints(click(n=12))
rivermouths <- snapPointsToLines(rivermouths, NLline)
rivermouths <- fortify(as.data.frame(rivermouths))
text(rivermouths$X, rivermouths$Y, col="yellow", labels=1:12)

```

# Change values in raster so that land is impassable (i.e. distances would be massive). 
```{r}
# Also get rid of ocean blob
# NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
# NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)
```

# Fix some AQ site coords
```{r}
siterast[2,] <- c(-56.325, 47.708)
siterast[35,] <- c(-55.605, 47.532)

```

# Transition layer, Geocorrection, calculate distance matrix, calculate Cumulative Weighted Distances
```{r}
# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = siterast, toCoords = cbind(rivermouths$X, rivermouths$Y))
d3 
```

### IF ENVIRONMENT LOADED: START HERE!
```{r}
d3 <- as.data.frame(cbind(d3, sitecoords$ID))
colnames(d3)[13] <- "ID"

dist2AQ <- join(d3, inventory, type="left")
```

# Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:12] <- apply(dist2AQ[,1:12], 2, function(x) as.character(x))
dist2AQ[,1:12] <- apply(dist2AQ[,1:12], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$V1
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$V2
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$V3
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$V4
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$V5
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$V6
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$V7
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$V8
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$V9
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$V10
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$V11
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$V12

# sum all pressures for total propagule pressure at a river
prop.press <- apply(as.matrix(dist2AQ[,21:32]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD <- data.frame(lat=rivermouths[,3], long = rivermouths[,2], prop.press = prop.press)

# match rivermouths to sampling sites
#plot(NLrast)
#text(escapemat[21:26,1], escapemat[21:26,2])
escapelocs <- as.data.frame(escapemat)
escapelocs$rivermouth <- c(6,6,6,10,6,5,3,6,2,3,1,10,11,9,12,3,8,7,6,6,4,5,3,3,4,9)

#text(riverCWD[,2], riverCWD[,1], col="yellow")
riverCWD$rivermouth <- c(1:12)

escapelocs <- join(escapelocs, riverCWD, type="left")

```

# plot propagule pressure
```{r}

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=inventory[inventory$totalfish >0,], aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 47.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(1,4000000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000, 4000000))

plot2 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=unique(escapelocs[,3:6]), aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 47.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  scale_size_continuous(name="Propagule\npressure=\n\u03A3(total fish/dist)", range = c(0.5,10), limits=c(100,6000), breaks=c(500, 1000, 3000, 6000))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))

```
names(sites)
# NEXT: proportion of escapees (or number of escapes) vs. propagule pressure for those 3 rivers
```{r}
names(escapelocs) <- c("Longitude..E.", "Latitude..N.", "rivermouth", "lat", "long", "prop.press")

escapes <- join(escapes, escapelocs, type="left")

farmed <- subset(escapes, Life.Stage=="Farmed")

proportions_f <- ddply(.data=farmed, .(rivermouth),
                     summarize,
                    farmed = length(Sample.ID))

total <- ddply(.data=escapes, .(rivermouth, prop.press),
                       summarize,
                       total=length(Sample.ID))

proportions <- join(total, proportions_f, type="left")
proportions$farmed <- ifelse(is.na(proportions$farmed)=="TRUE", 0, proportions$farmed)

proportions$prop <- proportions$farmed/proportions$total

require(ggrepel)

proportions$name <- c("Little", "Simm's", "Northwest", "Garnish")

ggplot() + 
  geom_smooth(data=proportions, aes(prop.press, prop), method="lm", se=FALSE) +
  geom_point(data=proportions, aes(prop.press, prop)) +
  geom_text_repel(data=proportions, aes(prop.press, prop, label=name), nudge_y=0.1) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  xlab("Propagule Pressure") +
  ylab("Proportion of escapees")+
  xlim(c(750, 3500)) +
<<<<<<< HEAD
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0)
=======
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0) +
>>>>>>> b8e4f4fe676046702f504ca7e479f0dbc897d893

model1 <- lm(data=proportions, prop ~ prop.press)
summary(model1)
```

# Yes but which is greater driver - distance or nfish?

```{r}
## calculate average distance to AQ sites
## calculate nfish within 20KM

# distances
avgdists <- apply(dist2AQ[,1:12], 2, mean)
avgdists <- data.frame(rivermouth = 1:12, avgdist=avgdists)

# nfish within 20km
melted <- melt(data=dist2AQ[,c(1:13, 16)], id.vars=c("ID", "totalfish"))
closefish <- subset(melted, value < 20000)
closecounts <- ddply(.data=closefish, .(variable),
                     summarize,
                     count = sum(totalfish, na.rm=TRUE))
closecounts <- rbind(data.frame(variable="V1", count=0), closecounts, data.frame(variable=c("V9", "V10", "V11", "V12"), count=0))
colnames(closecounts)[1] <- "rivermouth"
closecounts[1] <- 1:12

expanded <- join(avgdists, closecounts, type="left")

proportions <- join(proportions, expanded, type="left")

ggplot() + 
  geom_point(data=proportions, aes(avgdist, prop)) +
  geom_smooth(data=proportions, aes(avgdist, prop), method="lm", se=FALSE) + 
  geom_text_repel(data=proportions, aes(avgdist, prop, label=name), nudge_y=0.1) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(0, 1.2) +
  annotate(geom="text", x=76000, y=1, label="R-squared = 0.1359\np-value = 0.292", hjust=0) +
  xlab("Mean distance to aquaculture sites") +
  ylab("Proportion of escapees")

ggplot() + 
  geom_point(data=proportions, aes(count, prop)) +
    geom_smooth(data=proportions, aes(count, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(count, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.1) +
  annotate(geom="text", x=0, y=1, label="R-squared = 0.9825\np-value = 0.00585", hjust=0) +
  xlab("Number of aquaculture fish within 20km") +
  ylab("Proportion of escapees")

model2 <- lm(data=proportions, prop ~ count)
summary(model2)

model3 <- lm(data=proportions, prop ~ avgdist)
summary(model3)
### OK BUT WHY ARE THERE MULTIPLE ROWS OF THE SAME SITE? ARE THEY GETTING ADDED TWICE? PROBABLY.
```

### Escape events
```{r}
# events dataframe from AQ sites script
names(events)
events <- unique(select(events, ID, ReportYear, NEscape))

events2 <- ddply(.data=events, .(ID),
                 summarize,
                 totalescape = sum(NEscape))

melted <- join(melted, events2, type="left")

escape.press <- ddply(.data=melted, .(variable),
                       summarize,
                      e.press = sum(totalescape/value, na.rm=TRUE))
####### Come back to this later. I need lat/longs for the sites that had escapes. #######

```

### Sampling effort
```{r}
sets <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Set Details.csv")
head(sets)

sets$Date.Time.Start <- paste(sets$Date, sets$Set.Time..UTC.)
sets$Date.Time.End <- paste(sets$Date, sets$Retrieval.Time..UTC.)

sets$Date.Time.Start <- dmy_hms(sets$Date.Time.Start)
sets$Date.Time.End <- dmy_hms(sets$Date.Time.End)
sets$Duration <- sets$Date.Time.End - sets$Date.Time.Start

sets$Duration <- ifelse(is.na(sets$Duration)==TRUE, mean(sets$Duration, na.rm=TRUE), sets$Duration)

sets <- select(sets, Set.ID, River.Name, Date.Time.Start, Date.Time.End, Latitude..N., Longitude..E., Duration)

sets$rivermouth[sets$River.Name=="Simm's Brook"] <- 5
sets$rivermouth[sets$River.Name=="Bay du Nord River"] <- 6
sets$rivermouth[sets$River.Name=="Little River"] <- 3
sets$rivermouth[sets$River.Name=="Garnish River"] <- 10
sets$rivermouth[sets$River.Name=="Northwest River"] <- 6

effort <- ddply(.data=sets, .(rivermouth),
                summarize,
                effort = sum(Duration),
                nsets = length(unique(Set.ID)))

colnames(melted)[3] <- "rivermouth"
melted$rivermouth <- as.character(melted$rivermouth)
melted$rivermouth <- sub(melted$rivermouth, pattern="V", replacement="")

melted <- join(melted, effort, type="left")
melted$effort <- ifelse(is.na(melted$effort)==TRUE, 0, melted$effort)
melted$nsets <- ifelse(is.na(melted$nsets)==TRUE, 0, melted$nsets)

melted <- unique(select(melted, rivermouth, effort, nsets))

proportions <- join(proportions, melted, type="left")

ggplot() + 
  geom_point(data=proportions, aes(effort, prop)) +
    geom_smooth(data=proportions, aes(effort, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(effort, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=1400, y=0, label="R-squared = 0.0594\np-value = 0.3893", hjust=0) +
  xlab("Duration of sampling effort (minutes)") +
  ylab("Proportion of escapees")


ggplot() + 
  geom_point(data=proportions, aes(nsets, prop)) +
    geom_smooth(data=proportions, aes(nsets, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(nsets, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=9.5, y=0, label="R-squared = 0.07723\np-value = 0.380", hjust=0) +
  xlab("Number of gill net sets") +
  ylab("Proportion of escapees")


model4 <- lm(data=proportions, prop~effort)
summary(model4)

model5 <- lm(data=proportions, prop~nsets)
summary(model5)

```

### more models
```{r}

```
