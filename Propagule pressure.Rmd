
# Read in packages
```
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
```

##########################################################################################################################
######################### SOUTHERN NEWFOUNDLAND CAGE SITE DISTANCES TEMPLATE CODE ########################################
##########################################################################################################################

## for low-res generic mapping
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/atlas/75m_prod/geog/shape/
prov <- readShapeSpatial("C:/Users/keyserf/Documents/R/canvec/pvp/pvp.shp", proj4string=CRS("+proj=longlat +ellps=GRS80 +no_defs"))
#prov <- fortify(model=prov)
```

## Calculate distances between points with boundaries, need fine scale data for raster
## SKIP DOWN IF ENVIRONMENT IS LOADED
### read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
#NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "./canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 47, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
# NL.low.ocean <- readOGR(dsn="C:/Users/keyserf/Documents/R/canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
# r <- raster(ncol=1125, nrow=560)
# extent(r) <- extent(NL.low.ocean)
# NLrast <- rasterize(NL.low.ocean, r, fun="first")

```

##### START HERE IF ENVIRONMENT IS READY #####
```{r}
# site coords
x <- sites$Long
y <- sites$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# escaped fish location
escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
str(escapes)

escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")

escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
escapemat <- as.matrix(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))

```

## River mouths
```{r}
## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
plot(NLrast)
text(escapelocs$Longitude..E., escapelocs$Latitude..N.)
lines(NLline)
# rivermouths <- SpatialPoints(click(n=5))
rivermouths <- snapPointsToLines(rivermouths, NLline)
rivermouths <- fortify(as.data.frame(rivermouths))
text(rivermouths$X, rivermouths$Y, col="yellow")

```

# SKIP IF ENVIRONMENT LOADED! change values in raster so that land is impassable (i.e. distances would be massive). 
```{r}
# Also get rid of ocean blob
# NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
# NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)
```

# Transition layer, Geocorrection, calculate distance matrix, calculate Cumulative Weighted Distances
```{r}
# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")
plot(NLrast)

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = siterast, toCoords = cbind(rivermouths$X, rivermouths$Y))
d3 

d3 <- as.data.frame(cbind(d3, sites$ID))
names(d3) <- c("river1", "river2", "river3", "river4", "river5", "ID")

dist2AQ <- join(d3, inventory, type="left")
```

# Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:5] <- apply(dist2AQ[,1:5], 2, function(x) as.character(x))
dist2AQ[,1:5] <- apply(dist2AQ[,1:5], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$river1
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$river2
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$river3
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$river4
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$river5

# sum all pressures for total propagule pressure at a river
prop.press <- apply(as.matrix(dist2AQ[,13:17]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD <- data.frame(lat=rivermouths[,3], long = rivermouths[,2], prop.press = prop.press)

# match rivermouths to sampling sites
plot(NLrast)
text(escapelocs[,2], escapelocs[,1])
escapelocs$rivermouth <- c(3,3,3,5,3,2,1,4)

text(riverCWD[,2], riverCWD[,1], col="yellow")
riverCWD$rivermouth <- c(1,2,3,4,5)

escapelocs <- join(escapelocs, riverCWD, type="left")

```

# plot propagule pressure
```{r}

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

plot1 <- ggplot() + 
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=47.1, ymax= 47.3, fill="grey") +
  geom_point(data=inventory, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.4, -55.0), ylim=c(47.15, 47.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="totalfish")

plot2 <- ggplot() + 
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=47.1, ymax= 47.3, fill="grey") +
  geom_point(data=escapelocs, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +
  coord_map(xlim=c(-56.4, -55.0), ylim=c(47.15, 47.9)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="\u03A3(totalfish/d)")

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(rbind(gA, gB))

```

# NEXT: proportion of escapees (or number of escapes) vs. propagule pressure for those 3 rivers
```{r}
escapes <- join(escapes,escapelocs, type="left")
str(escapes)
unique(escapes$Life.Stage)
farmed <- subset(escapes, Life.Stage=="Farmed")

proportions_f <- ddply(.data=farmed, .(rivermouth),
                     summarize,
                    farmed = length(Sample.ID))

total <- ddply(.data=escapes, .(rivermouth, prop.press),
                       summarize,
                       total=length(Sample.ID))

proportions <- join(total, proportions_f, type="left")
proportions$farmed <- ifelse(is.na(proportions$farmed)=="TRUE", 0, proportions$farmed)

proportions$prop <- proportions$farmed/proportions$total
 
ggplot() + geom_point(data=proportions, aes(prop.press, prop)) + 
  geom_smooth(data=proportions, aes(prop.press, prop), method="lm") +
  theme_bw() +
  xlab("Propagule Pressure") +
  ylab("Number of escapees detected")
