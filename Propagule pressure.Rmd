
# Read in packages
```
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
```

##########################################################################################################################
######################### SOUTHERN NEWFOUNDLAND CAGE SITE DISTANCES TEMPLATE CODE ########################################
##########################################################################################################################

## for low-res generic mapping
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/atlas/75m_prod/geog/shape/
prov <- readShapeSpatial("C:/Users/keyserf/Documents/R/canvec/pvp/pvp.shp", proj4string=CRS("+proj=longlat +ellps=GRS80 +no_defs"))
#prov <- fortify(model=prov)
```

## Calculate distances between points with boundaries, need fine scale data for raster
## SKIP DOWN IF ENVIRONMENT IS LOADED
### read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
# NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 46.8, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
NL.low.ocean <- readOGR(dsn="./canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
r <- raster(ncol=1125, nrow=560)
extent(r) <- extent(NL.low.ocean)
NLrast <- rasterize(NL.low.ocean, r, fun="first")

# if shoreline needed:
# NLline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Land_shp/shoreline_1_small.shp", "shoreline_1_small")

# Change values in raster so that land is impassable (i.e. distances would be massive). 

# Also get rid of ocean blob
NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)

# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")

```

## Newfoundland AQ site coordinates and river mouths
```{r}
# site coords
# read in sites from AQ sites NL script
sitecoords <- unique(subset(totfishall, is.na(Lat)=="FALSE", select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# # escaped fish location
# escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# str(escapes)
# 
# escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")
# names(rivers) <- c("code", "V1", "V2")
# escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
# escapemat <- as.data.frame(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))
# escapemat <- rbind(escapemat, as.data.frame(rivers[,2:3]))
# escapemat <- as.matrix(escapemat)

## Newfoundland River mouths

## Details for above:
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# 
# ## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
# plot(NLrast)
# text(rivers[,2], rivers[,3])
# lines(NLline)
# # rivermouths <- SpatialPoints(click(n=18))
# rivermouths <- snapPointsToLines(rivermouths, NLline)
# rivermouths <- fortify(as.data.frame(rivermouths))
# text(rivermouths$X, rivermouths$Y, col="red", labels=1:18)

# For Brendan's river sites:

Bsites <- read.csv("C:/Users/keyserf/Documents/Data/sites_lat_long_brendan.csv", header=TRUE)
# plot(NLrast)
# head(Bsites)
# points(Bsites$V1, Bsites$V2, pch=21, bg="black")
# Bsites <- Bsites[1:18,] 
# Bsites[,1:3] <- apply(Bsites[,1:3], 2, function(x) as.character(x))
# Bsites[,2:3] <- apply(Bsites[,2:3], 2, function(x) as.numeric(x))
#   
# x <- Bsites$V1
# y <- Bsites$V2
# xy <-cbind(x, y)
# Bsiterast <- as.matrix(xy)

## For precise PARR project sampling locations in rivers:

# sampling <- read.csv("C:/Users/keyserf/Documents/Data/Salmon sampling summary 2014.csv", header=TRUE)
# sampling <- select(sampling[1:20,], Location, Latitude, Longitude)
# sampling$code <- c("BTB", "CNR", "CNR", "DLR", "GAR", "GBB", "GLP", "LMS", "LTR", "LHR", "MAL", "NET", "NEB", "FBN", "OBB", "SMB", "SEB", "TRB", "TBB", "TEB")
# sampling <- sampling[-c(2,12),]
# sampling
# 
# plot(NLrast)
# points(sampling$Longitude, sampling$Latitude)
# 
# #rivermouths<- SpatialPoints(click(n=18))
# rivermouths <- data.frame(rivermouths)
# rivermouths <- cbind(rivermouths, Bsites$X)

# write.csv(rivermouths, "C:/Users/keyserf/Documents/Data/NL river mouth coords_2016-11-18.csv")
rivermouths <- read.csv("C:/Users/keyserf/Documents/Data/NL river mouth coords_2016-11-18.csv", header=TRUE)
```

# Newfoundland - Fix some AQ site coords
```{r}
# for 2013 only:
# plot(NLrast, xlim=c(-56.0, -55.5), ylim=c(47.4, 47.6))
# points(siterast[12,1], siterast[12,2], col="blue")
# siterast[12,] <- click()
# make site 12 = -55.58610 and 47.51435

# for 2010-2015 years:
# plot(NLrast)
# points(siterast[17,1], siterast[17,2])
# siterast[17,] <- click()
## make site 17 = -56.06074 and 47.77717
# siterast[17,] <- c(-56.06074, 47.77717)
# points(siterast[30,1], siterast[30,2])
# siterast[30,] <- click()
# siterast[30,] <- c(-55.78194, 47.57588)
## make site 30 = -55.78194 and 47.57588

# for 2002-2015 years:
plot(NLrast, xlim=c(-56.25, -55.75), ylim=c(47.6, 48))
points(siterast[19,1], siterast[19,2])
siterast[19,] <- c(-56.02246, 47.80103)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[37,1], siterast[37,2])
siterast[37,] <- c(-55.77543, 47.59184)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[48,1], siterast[48,2])
siterast[48,] <- c(-55.77543, 47.59184)

```

# Newfoundland - calculate distance matrix
```{r}
# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(rivermouths[,1]), as.numeric(rivermouths[,2])))

d3 
```

### Newfoundland - merge with site coords and inventory data
```{r}
d3 <- as.data.frame(cbind(d3, sitecoords$ID))
colnames(d3)[19] <- "ID"
colnames(d3)[1:18] <- as.list(as.character(Bsites$X))

dist2AQ <- join(d3, totfishall, type="left")
```

# Newfoundland - Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.character(x))
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.numeric(x))

#dist2AQ[46,]$SMB <-1000

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BTB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$DLR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GBB
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$GLP
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$LMS
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$LTR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$MAL
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$NEB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$FBN
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$OBB
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$SMB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$SEB
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$TRB
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$TBB
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$TEB

## via decay function
# dist2AQ$P1 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$BTB/1000))
# dist2AQ$P2 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$CNR/1000))
# dist2AQ$P3 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$DLR/1000))
# dist2AQ$P4 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GAR/1000))
# dist2AQ$P5 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GBB/1000))
# dist2AQ$P6 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GLP/1000))
# dist2AQ$P7 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LMS/1000))
# dist2AQ$P8 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LTR/1000))
# dist2AQ$P9 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LHR/1000))
# dist2AQ$P10 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$MAL/1000))
# dist2AQ$P11 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$NEB/1000))
# dist2AQ$P12 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$FBN/1000))
# dist2AQ$P13 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$OBB/1000))
# dist2AQ$P14 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$SMB/1000))
# dist2AQ$P15 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$SEB/1000))
# dist2AQ$P16 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TRB/1000))
# dist2AQ$P17 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TBB/1000))
# dist2AQ$P18 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TEB/1000))

#dist2AQ[,26:43] <- apply(dist2AQ[,26:43], 2, function(x) replace(x, is.infinite(x), 0))

# sum all pressures for total propagule pressure at a river
prop.press_all <- apply(as.matrix(dist2AQ[,26:43]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_all <- data.frame(code=Bsites[,1], lat=rivermouths[,2], long = rivermouths[,1], prop.press = prop.press_all)

write.csv(prop.press_all, "C:/Users/keyserf/Documents/Data/Propagule Pressure_lin_all years_2016-11-09.csv")

```

# Newfoundland - plot propagule pressure
```{r}
totfishall <- subset(totfishall, totalfish > 0)
totfishall$Lat <- as.numeric(totfishall$Lat)
totfishall$Long <- as.numeric(totfishall$Long)

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

totfishall <- arrange(totfishall, -totalfish)
prop.press_all <- arrange(prop.press_all, -prop.press)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=totfishall, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(1,4000000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000, 4000000))

plot2 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.press_all, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  #scale_size_continuous(name="Propagule pressure=\n\u03A3(total fish^-0.0012*dist)", range = c(0.5,8), limits=c(5,25), breaks=c(5,10,15,20,25))
  scale_size_continuous(name="Propagule pressure=\n\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,10000), breaks=c(500, 1000, 3000, 5000, 7000, 10000))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))

```





### Newfoundland - comparing escapees and escape events with propagule pressure
# proportion of escapees (or number of escapes) vs. propagule pressure for those 3 rivers
```{r}
names(escapelocs) <- c("Longitude..E.", "Latitude..N.", "rivermouth", "lat", "long", "prop.press")

escapes <- join(escapes, escapelocs, type="left")

farmed <- subset(escapes, Life.Stage=="Farmed")

proportions_f <- ddply(.data=farmed, .(rivermouth),
                     summarize,
                    farmed = length(Sample.ID))

total <- ddply(.data=escapes, .(rivermouth, prop.press),
                       summarize,
                       total=length(Sample.ID))

proportions <- join(total, proportions_f, type="left")
proportions$farmed <- ifelse(is.na(proportions$farmed)=="TRUE", 0, proportions$farmed)

proportions$prop <- proportions$farmed/proportions$total

require(ggrepel)

proportions$name <- c("Little", "Simm's", "Northwest", "Garnish")

ggplot() + 
  geom_smooth(data=proportions, aes(prop.press, prop), method="lm", se=FALSE) +
  geom_point(data=proportions, aes(prop.press, prop)) +
  geom_text_repel(data=proportions, aes(prop.press, prop, label=name), nudge_y=0.1) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  xlab("Propagule Pressure") +
  ylab("Proportion of escapees")+
  xlim(c(750, 3500)) +
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0)
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0)

model1 <- lm(data=proportions, prop ~ prop.press)
summary(model1)
```
# Yes but which is greater driver - distance or nfish?
```{r}
## calculate average distance to AQ sites
## calculate nfish within 20KM

# distances
avgdists <- apply(dist2AQ[,1:12], 2, mean)
avgdists <- data.frame(rivermouth = 1:12, avgdist=avgdists)

# nfish within 20km
melted <- melt(data=dist2AQ[,c(1:13, 16)], id.vars=c("ID", "totalfish"))
closefish <- subset(melted, value < 20000)
closecounts <- ddply(.data=closefish, .(variable),
                     summarize,
                     count = sum(totalfish, na.rm=TRUE))
closecounts <- rbind(data.frame(variable="V1", count=0), closecounts, data.frame(variable=c("V9", "V10", "V11", "V12"), count=0))
colnames(closecounts)[1] <- "rivermouth"
closecounts[1] <- 1:12

expanded <- join(avgdists, closecounts, type="left")

proportions <- join(proportions, expanded, type="left")

ggplot() + 
  geom_point(data=proportions, aes(avgdist, prop)) +
  geom_smooth(data=proportions, aes(avgdist, prop), method="lm", se=FALSE) + 
  geom_text_repel(data=proportions, aes(avgdist, prop, label=name), nudge_y=0.1) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(0, 1.2) +
  annotate(geom="text", x=76000, y=1, label="R-squared = 0.1359\np-value = 0.292", hjust=0) +
  xlab("Mean distance to aquaculture sites") +
  ylab("Proportion of escapees")

ggplot() + 
  geom_point(data=proportions, aes(count, prop)) +
    geom_smooth(data=proportions, aes(count, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(count, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.1) +
  annotate(geom="text", x=0, y=1, label="R-squared = 0.9825\np-value = 0.00585", hjust=0) +
  xlab("Number of aquaculture fish within 20km") +
  ylab("Proportion of escapees")

model2 <- lm(data=proportions, prop ~ count)
summary(model2)

model3 <- lm(data=proportions, prop ~ avgdist)
summary(model3)
### OK BUT WHY ARE THERE MULTIPLE ROWS OF THE SAME SITE? ARE THEY GETTING ADDED TWICE? PROBABLY.
```
### Escape events
```{r}
# events dataframe from AQ sites script
names(events)
events <- unique(select(events, ID, ReportYear, NEscape))
names(events)
events2 <- ddply(.data=events, .(ID, Bay),
                 summarize,
                 totalescape = sum(NEscape))

melted <- join(melted, events2, type="left")

escape.press <- ddply(.data=melted, .(variable),
                       summarize,
                      e.press = sum(totalescape/value, na.rm=TRUE))
####### Come back to this later. I need lat/longs for the sites that had escapes. #######

```
### Sampling effort
```{r}
sets <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Set Details.csv")
head(sets)

sets$Date.Time.Start <- paste(sets$Date, sets$Set.Time..UTC.)
sets$Date.Time.End <- paste(sets$Date, sets$Retrieval.Time..UTC.)

sets$Date.Time.Start <- dmy_hms(sets$Date.Time.Start)
sets$Date.Time.End <- dmy_hms(sets$Date.Time.End)
sets$Duration <- sets$Date.Time.End - sets$Date.Time.Start

sets$Duration <- ifelse(is.na(sets$Duration)==TRUE, mean(sets$Duration, na.rm=TRUE), sets$Duration)

sets <- select(sets, Set.ID, River.Name, Date.Time.Start, Date.Time.End, Latitude..N., Longitude..E., Duration)

sets$rivermouth[sets$River.Name=="Simm's Brook"] <- 5
sets$rivermouth[sets$River.Name=="Bay du Nord River"] <- 6
sets$rivermouth[sets$River.Name=="Little River"] <- 3
sets$rivermouth[sets$River.Name=="Garnish River"] <- 10
sets$rivermouth[sets$River.Name=="Northwest River"] <- 6

effort <- ddply(.data=sets, .(rivermouth),
                summarize,
                effort = sum(Duration),
                nsets = length(unique(Set.ID)))

colnames(melted)[3] <- "rivermouth"
melted$rivermouth <- as.character(melted$rivermouth)
melted$rivermouth <- sub(melted$rivermouth, pattern="V", replacement="")

melted <- join(melted, effort, type="left")
melted$effort <- ifelse(is.na(melted$effort)==TRUE, 0, melted$effort)
melted$nsets <- ifelse(is.na(melted$nsets)==TRUE, 0, melted$nsets)

melted <- unique(select(melted, rivermouth, effort, nsets))

proportions <- join(proportions, melted, type="left")

ggplot() + 
  geom_point(data=proportions, aes(effort, prop)) +
    geom_smooth(data=proportions, aes(effort, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(effort, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=1400, y=0, label="R-squared = 0.0594\np-value = 0.3893", hjust=0) +
  xlab("Duration of sampling effort (minutes)") +
  ylab("Proportion of escapees")


ggplot() + 
  geom_point(data=proportions, aes(nsets, prop)) +
    geom_smooth(data=proportions, aes(nsets, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(nsets, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=9.5, y=0, label="R-squared = 0.07723\np-value = 0.380", hjust=0) +
  xlab("Number of gill net sets") +
  ylab("Proportion of escapees")


model4 <- lm(data=proportions, prop~effort)
summary(model4)

model5 <- lm(data=proportions, prop~nsets)
summary(model5)

```





### Newfoundland - Annual propagule pressure for each river
```{r}
dist2AQ_annual <- join(d3, annual, type="left")
head(dist2AQ_annual)

dist2AQ_annual[,1:18] <- apply(dist2AQ_annual[,1:18], 2, function(x) as.character(x))
dist2AQ_annual[,1:18] <- apply(dist2AQ_annual[,1:18], 2, function(x) as.numeric(x))

dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BTB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$DLR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GBB
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$GLP
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$LMS
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$LTR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$MAL
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$NEB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$FBN
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$OBB
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$SMB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$SEB
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$TRB
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$TBB
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$TEB

dist2AQ_annual$P1 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$BTB/1000))
dist2AQ_annual$P2 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$CNR/1000))
dist2AQ_annual$P3 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$DLR/1000))
dist2AQ_annual$P4 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$GAR/1000))
dist2AQ_annual$P5 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$GBB/1000))
dist2AQ_annual$P6 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$GLP/1000))
dist2AQ_annual$P7 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$LMS/1000))
dist2AQ_annual$P8 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$LTR/1000))
dist2AQ_annual$P9 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$LHR/1000))
dist2AQ_annual$P10 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$MAL/1000))
dist2AQ_annual$P11 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$NEB/1000))
dist2AQ_annual$P12 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$FBN/1000))
dist2AQ_annual$P13 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$OBB/1000))
dist2AQ_annual$P14 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$SMB/1000))
dist2AQ_annual$P15 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$SEB/1000))
dist2AQ_annual$P16 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$TRB/1000))
dist2AQ_annual$P17 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$TBB/1000))
dist2AQ_annual$P18 <- dist2AQ_annual$totalfish^(-0.0012*(dist2AQ_annual$TEB/1000))

dist2AQ_annual <- subset(dist2AQ_annual, totalfish >0)
ppannual <- select(dist2AQ_annual, 19:39)

ppannual <- melt(data=ppannual, id.vars=c("ID", "ReportYear", "totalfish"))

# sum all pressures for total propagule pressure at a river
prop.press.annual <- ddply(.data=ppannual, .(ReportYear, variable), 
                                      summarise, 
                                      prop.press.annual = sum(value))

# match to river mouth coords
prop.press.annual$River <- rep(Bsites$X, 6)

```






### Cleaning up Morris et al. data
```{r}
setwd("C:/Users/keyserf/Documents")
morris_clean <- read.csv("./Data/morris_clean.csv")
morris_clean <- as.data.frame(sapply(morris_clean,gsub,pattern="~",replacement=""))
morris_clean[,c(5:8)] <- apply(morris_clean[,c(5:8)], 2, function(x) as.character(x))
morris_clean[,c(5:8)] <- apply(morris_clean[,c(5:8)], 2, function(x) as.numeric(x))
morris_clean$TotalWild[is.na(morris_clean$TotalWild)==TRUE] <- 0
morris_clean$TotalCombined <- morris_clean$TotalWild + morris_clean$TotalFarmed

morris_river_summary <- ddply(.data=morris_clean, .(River, ProvState),
                              summarize,
                              total=sum(TotalCombined),
                              farmed=sum(TotalFarmed),
                              nyears=length(unique(Year)))

morris_river_summary$totalprop <- morris_river_summary$farmed/morris_river_summary$total

morris_summary_NL <- subset(morris_river_summary, ProvState=="NL")

morris_clean_NL <- subset(morris_clean, ProvState=="NL")


```







### for 2002-2012
## Newfoundland 2002-2012 - AQ sites
```{r}
# site coords
# read in sites from AQ sites NL script
sitecoords <- unique(subset(totfish0212, is.na(Lat)=="FALSE", select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# use rivermouths from ALL years section

# Fix some AQ site coords
# for 2002-2012 years:
plot(NLrast, xlim=c(-56.25, -55.75), ylim=c(47.6, 48))
points(siterast[18,1], siterast[18,2])
siterast[18,] <- c(-56.02246, 47.80103)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[32,1], siterast[32,2])
siterast[32,] <- c(-55.77543, 47.59184)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[43,1], siterast[43,2])
siterast[43,] <- c(-55.77543, 47.59184)

```
### Newfoundland 2002-2012 - propagule pressure for ALL rivers from 2002 to 2012 (for qval plot)
```{r}

## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
# NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

#cropping shapefile to the area and details I need
NLprov <- crop(NLlab, extent(-59.7, -52.4, 46.6, 51.8))
writeOGR(obj=NLprov, dsn="canvec", layer="NLprov", driver="ESRI Shapefile")
# rm(NL.low)
# rm(NLlab)

# NLline_all <- subset(NLline_all, perm_en=="Permanent" & dsc_en=="Coast")
# writeOGR(obj=NLline_all, dsn="canvec", layer="NLline_all", driver="ESRI Shapefile")

plot(NLprov)

# # read in cropped shapefile: NL.low.ocean
# NLlab <- readOGR(dsn="./canvec/NLlab.dbf", layer="NLlab")

# creating raster
r <- raster(ncol=553, nrow=585)
extent(r) <- extent(NLprov)
NLprovrast <- rasterize(NLprov, r, fun="first")
NLprovrasttest <- NLprovrast

# adjust values to make lines impassable
NLprovrasttest@data@values <- ifelse(is.na(NLprovrasttest@data@values)=="TRUE", 10000, 1)

# create transition layer for raster (likelihood of presence within cell). 
tr4 <- transition(1/NLprovrasttest, transitionFunction=mean, directions=8)
tr4c <- geoCorrection(tr4, type="c")
# plot(raster(tr4c))

# read in sites
qsites <- read.csv("C:/Users/keyserf/Documents/Data/Qvalues_All NL_2016-11-10.csv")
qsites <- qsites[,1:3]

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Moore_Salmon_Coords.csv")

qsites <- join(qsites, qsitecoords, type="left")

qsites[qsites$Code=="LHR",]$Long <- -54.94830
qsites[qsites$Code=="LHR",]$Lat <- 47.77960 

qsites[qsites$Code=="BSB",]$Long <- -53.282374
qsites[qsites$Code=="BSB",]$Lat <- 46.756687

# nudge AQ sites
# for 2002-2012 years:
plot(NLrast, xlim=c(-56.25, -55.75), ylim=c(47.6, 48))
points(siterast[18,1], siterast[18,2])
siterast[18,] <- c(-56.02246, 47.80103)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[32,1], siterast[32,2])
siterast[32,] <- c(-55.77543, 47.59184)
plot(NLrast, xlim=c(-56, -55.5), ylim=c(47.4, 47.6))
points(siterast[43,1], siterast[43,2])
siterast[43,] <- c(-55.77543, 47.59184)

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d4 <- costDistance(tr4c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(qsites$Long, qsites$Lat))

d4 <- cbind(d4, sitecoords$ID)

colnames(d4)[16] <- "ID"
colnames(d4)[1:15] <- as.list(as.character(qsites$Code))
d4 <- as.data.frame(d4)

dist2AQ_prov <- join(d4, totfish0212, type="left")

dist2AQ_prov[,1:15] <- apply(dist2AQ_prov[,1:15], 2, function(x) as.character(x))
dist2AQ_prov[,1:15] <- apply(dist2AQ_prov[,1:15], 2, function(x) as.numeric(x))

dist2AQ_prov$P1 <- dist2AQ_prov$totalfish/dist2AQ_prov$GAR
dist2AQ_prov$P2 <- dist2AQ_prov$totalfish/dist2AQ_prov$BDN
dist2AQ_prov$P3 <- dist2AQ_prov$totalfish/dist2AQ_prov$CNR
dist2AQ_prov$P4 <- dist2AQ_prov$totalfish/dist2AQ_prov$LHR
dist2AQ_prov$P5 <- dist2AQ_prov$totalfish/dist2AQ_prov$GRR
dist2AQ_prov$P6 <- dist2AQ_prov$totalfish/dist2AQ_prov$LPR
dist2AQ_prov$P7 <- dist2AQ_prov$totalfish/dist2AQ_prov$NPR
dist2AQ_prov$P8 <- dist2AQ_prov$totalfish/dist2AQ_prov$RKR
dist2AQ_prov$P9 <- dist2AQ_prov$totalfish/dist2AQ_prov$LSR
dist2AQ_prov$P10 <- dist2AQ_prov$totalfish/dist2AQ_prov$NBT
dist2AQ_prov$P11 <- dist2AQ_prov$totalfish/dist2AQ_prov$BSB
dist2AQ_prov$P12 <- dist2AQ_prov$totalfish/dist2AQ_prov$STP
dist2AQ_prov$P13 <- dist2AQ_prov$totalfish/dist2AQ_prov$SGR
dist2AQ_prov$P14 <- dist2AQ_prov$totalfish/dist2AQ_prov$WAB
dist2AQ_prov$P15 <- dist2AQ_prov$totalfish/dist2AQ_prov$CMP

# sum all pressures for total propagule pressure at a river
prop.press_prov <- apply(as.matrix(dist2AQ_prov[,20:34]), 2, function(x) sum(x, na.rm=TRUE))

prop.press_prov <- as.data.frame(cbind(code=as.character(qsites$Code), long=qsites$Long, lat=qsites$Lat, prop.press=prop.press_prov))


# plot against Q values and create map of PP

qsites$Code <- as.character(qsites$Code)

prop.press_prov$Code <- as.character(prop.press_prov$code)
prop.press_prov$long <- as.numeric(as.character(prop.press_prov$long))
prop.press_prov$lat <- as.numeric(as.character(prop.press_prov$lat))
prop.press_prov$prop.press <- as.numeric(as.character(prop.press_prov$prop.press))

qsites <- join(qsites, prop.press_prov, type="left")

ggplot() + 
  geom_smooth(data=qsites, aes(prop.press, Q), method="lm", se=TRUE) +
  geom_point(data=qsites, aes(prop.press, Q)) +
  geom_label_repel(data=qsites, aes(prop.press, Q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  ggtitle("2002-2012")+
  xlab("Propagule pressure") +
  ylab("Q value") 

summary(lm(data=qsites, Q~prop.press))

prov2 <- fortify(NLprov)

prov2$group <- ifelse(prov2$long < -56.2 & prov2$lat < 47.375, 4771.1, prov2$group)

totfish0212 <- arrange(totfish0212, -totalfish)
prop.press0212<- arrange(prop.press0212, -prop.press)

ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov2, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-59.7, xmax=-56, ymin=46.6, ymax= 47.45, fill="grey") +
  annotate(geom="rect", xmin=-54, xmax=-52.6, ymin=50, ymax= 51.8, fill="grey") +
  annotate(geom="rect", xmin=-56, xmax=-55.5, ymin=46.6, ymax= 46.8, fill="grey") +
  geom_point(data=prop.press0212, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  geom_label_repel(data=prop.press0212, aes(long, lat, label=code), size=3, point.padding = unit(0.5,"lines"))+
  coord_map(xlim=c(-59.7, -52.6), ylim=c(46.6, 51.8)) +
  theme_classic() +
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  scale_size_continuous(name="Propagule pressure=\n\u03A3(total fish/dist)", range = c(1,8), limits=c(0,2500), breaks=c(1, 100, 500, 1000, 1500, 2000))

```







### for 2013 only (Brendan's paper)
## Newfoundland 2013 - join distance matrix with 2013 inventory data
```{r}
#colnames(d3)[1:18] <- as.list(as.character(Bsites$X))
dist2AQ_2013 <- join(d3, totfish2013, type="left")

dist2AQ_2013[,1:18] <- apply(dist2AQ_2013[,1:18], 2, function(x) as.character(x))
dist2AQ_2013[,1:18] <- apply(dist2AQ_2013[,1:18], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
# original method of calculation
dist2AQ_2013$P1 <- dist2AQ_2013$totalfish/dist2AQ_2013$BTB
dist2AQ_2013$P2 <- dist2AQ_2013$totalfish/dist2AQ_2013$CNR
dist2AQ_2013$P3 <- dist2AQ_2013$totalfish/dist2AQ_2013$DLR
dist2AQ_2013$P4 <- dist2AQ_2013$totalfish/dist2AQ_2013$GAR
dist2AQ_2013$P5 <- dist2AQ_2013$totalfish/dist2AQ_2013$GBB
dist2AQ_2013$P6 <- dist2AQ_2013$totalfish/dist2AQ_2013$GLP
dist2AQ_2013$P7 <- dist2AQ_2013$totalfish/dist2AQ_2013$LMS
dist2AQ_2013$P8 <- dist2AQ_2013$totalfish/dist2AQ_2013$LTR
dist2AQ_2013$P9 <- dist2AQ_2013$totalfish/dist2AQ_2013$LHR
dist2AQ_2013$P10 <- dist2AQ_2013$totalfish/dist2AQ_2013$MAL
dist2AQ_2013$P11 <- dist2AQ_2013$totalfish/dist2AQ_2013$NEB
dist2AQ_2013$P12 <- dist2AQ_2013$totalfish/dist2AQ_2013$FBN
dist2AQ_2013$P13 <- dist2AQ_2013$totalfish/dist2AQ_2013$OBB
dist2AQ_2013$P14 <- dist2AQ_2013$totalfish/dist2AQ_2013$SMB
dist2AQ_2013$P15 <- dist2AQ_2013$totalfish/dist2AQ_2013$SEB
dist2AQ_2013$P16 <- dist2AQ_2013$totalfish/dist2AQ_2013$TRB
dist2AQ_2013$P17 <- dist2AQ_2013$totalfish/dist2AQ_2013$TBB
dist2AQ_2013$P18 <- dist2AQ_2013$totalfish/dist2AQ_2013$TEB

## via decay function
# dist2AQ_2013$P1 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$BTB/1000))
# dist2AQ_2013$P2 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$CNR/1000))
# dist2AQ_2013$P3 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$DLR/1000))
# dist2AQ_2013$P4 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GAR/1000))
# dist2AQ_2013$P5 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GBB/1000))
# dist2AQ_2013$P6 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GLP/1000))
# dist2AQ_2013$P7 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LMS/1000))
# dist2AQ_2013$P8 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LTR/1000))
# dist2AQ_2013$P9 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LHR/1000))
# dist2AQ_2013$P10 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$MAL/1000))
# dist2AQ_2013$P11 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$NEB/1000))
# dist2AQ_2013$P12 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$FBN/1000))
# dist2AQ_2013$P13 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$OBB/1000))
# dist2AQ_2013$P14 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$SMB/1000))
# dist2AQ_2013$P15 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$SEB/1000))
# dist2AQ_2013$P16 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TRB/1000))
# dist2AQ_2013$P17 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TBB/1000))
# dist2AQ_2013$P18 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TEB/1000))

# ggplot() + 
#   geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
#   geom_point(data=Bsites[10,], aes(V1, V2), colour="red") + 
#   geom_point(data=rivermouths[10,], aes(x, y), colour="blue") +
#   coord_fixed()

# sum all pressures for total propagule pressure at a river
prop.press2013 <- apply(as.matrix(dist2AQ_2013[,23:40]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press2013 <- data.frame(code=rivermouths[,3], lat=rivermouths[,2], long = rivermouths[,1], prop.press = prop.press2013)

prop.press2013$name <- c("Bottom Brook", "Conne River", "Dollard's Brook",
                         "Garnish River", "Grand Bank Brook", "Grand LaPierre Brook",
                         "Salmonier River", "Little River", "Long Harbour River",
                         "Mal Bay Brook", "Northeast Brook", "Northwest Brook",
                         "Old Bay Brook", "Simm's Brook", "Southeast Brook",
                         "Tailrace Brook", "Taylor Bay Brook", "Terrenceville Brook")

prop.press2013 <- select(prop.press2013, code, lat, long, prop.press, name)
prop.press2013
write.csv(prop.press2013, file="C:/Users/keyserf/Documents/Data/Propagule pressures_lin_2013_sampling_2016-11-09.csv")
```

# Newfoundland - plot propagule pressure 2013
```{r}
totfish2013 <- subset(totfish2013, totalfish > 0)
totfish2013$Lat <- as.numeric(totfish2013$Lat)
totfish2013$Long <- as.numeric(totfish2013$Long)

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

totfish2013 <- arrange(totfish2013, -totalfish)
prop.press2013 <- arrange(prop.press2013, -prop.press)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=totfish2013, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,7), limits=c(1,1200000), breaks=c(100, 1000, 10000, 100000, 500000, 1000000, 1200000))

plot2 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.press2013, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  # annotate(geom="point", x=-55.8222, y=47.6223, colour="blue") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  #annotate(geom="point", x=-55.77313, y=47.50711)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  #scale_size_continuous(name="Propagule\npressure=\n\u03A3(total fish/dist)", range = c(0.5,8), limits=c(4,18), breaks=c(4,6,10,14,18))
  scale_size_continuous(name="Propagule\npressure=\n\u03A3(total fish/dist)", range = c(1,8), limits=c(10,1500), breaks=c(10, 100, 500, 1000, 1500))


gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))


```


### Escape from site 1072 analysis/testing?
```{r}
escapesite <- subset(dist2AQ_2013, ID==1072) 
distances <- melt(escapesite)[1:18,]
names(distances) <- c("ID", "River", "DistanceToRiver.m.")
distances
distances$DistanceToRiver.km. <- distances$DistanceToRiver.m./1000
pressures <- melt(escapesite)[22:39,]
names(pressures) <- c("ID", "River", "TotalFish..Distance")
pressures
escapesite <- cbind(distances[,1:4], pressures[,3])
escapesite[,3] <- round(escapesite[,3], 0)
escapesite[,4] <- round(escapesite[,4], 3)
names(escapesite) <- c("ID", "River", "DistanceToRiver.m.", "DistanceToRiver.km.", "SpecificPressure")
escapesite
write.csv(escapesite, file="C:/Users/keyserf/Documents/Data/2013 escape site 1072_exp_sampling_2016-11-03.csv")

require(ggrepel)
ggplot() + geom_point(data=escapesite, aes(DistanceToRiver.km., 1)) + 
  geom_text_repel(data=escapesite, aes(DistanceToRiver.km., 1, label=River), min.segment.length=unit(0.1, "lines"))

# orderedlist <- arrange(escapesite, DistanceToRiver.km.)

# ## trying CBC point
# dCBC <- costDistance(tr3c, fromCoords = cbind(-55.77313, 47.50711), toCoords = cbind(as.numeric(Bsiterast[,1]), as.numeric(Bsiterast[,2])))
# dCBC
# distances2 <- melt(dCBC)
# distances2 <- distances2[,2:3]
# names(distances2) <- c("RiverNumber", "DistanceToRiver.m.")
# distances2
# distances2$DistanceToRiver.km. <- distances2$DistanceToRiver.m./1000
# distances2$River <- Bsites$X
# write.csv(distances2, file="C:/Users/keyserf/Documents/Data/2013 CBC distances to sites.csv")
# 
# orderedlist2 <- arrange(distances2, DistanceToRiver.km.)
# 
# orderedlist <- select(orderedlist, River, DistanceToRiver.km.)
# orderedlist2 <- select(orderedlist2, River, DistanceToRiver.km.)
# orderedlist <- cbind(orderedlist, 1:18)
# orderedlist2 <- cbind(orderedlist2, 1:18)
# orderchange <- rbind(orderedlist, orderedlist2)
# orderchange <- cbind(orderchange, c(rep("GP", 18), rep("CBC", 18)))
# names(orderchange) <- c("River", "Distance", "Order", "Site")
# ggplot() + geom_point(data=orderchange, aes(Site, Distance, colour=River))+
#   geom_line(data=orderchange, aes(Site, Distance, colour=River, group=River)) +
#   geom_text_repel(data=orderchange, aes(Site, Distance, label=River, colour=River), size=3)
```


### Nova scotia propagule pressures
## shapefile prep
```{r}
# Use size instead of total fish proxy

# read in cropped shapefile: NL.low.ocean
# NS.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NS_Hydro_shp/waterbody_2.shp", layer="waterbody_2")
NS.low <- crop(NS.low, extent(-66.4, -59.5, 43.4, 47.5))
plot(NS.low)

# creating raster
r <- raster(ncol=534, nrow=415)
extent(r) <- extent(NS.low)
NSrast <- rasterize(NS.low, r, fun="first")

# site coords
# read in sites from AQ file
NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/NS Salmon Sites.csv", header=TRUE)
names(NSsitecoords)
x <- NSsitecoords$Longitude
y <- NSsitecoords$Latitude
xy <- cbind(x, y)
NSsiterast <- as.matrix(xy)
plot(NSrast)
points(NSsiterast[,1], NSsiterast[,2], col="red")

# # escaped fish location from Escapes_2016-10-07 morris df
# nsrivers_all

# convert rasterized values
NSrast@data@values <- ifelse(is.na(NSrast@data@values)=="TRUE", 10000, 1)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -64.5 & coordinates(NSrast)[,2] < 44, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -61 & coordinates(NSrast)[,2] < 45, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,2] >47.2, 1, NSrast@data@values)
```

# Fix some river coords
```{r}
# make nictaux = to annapolis
nsrivers_all[8,3] <- nsrivers_all[1,3]
nsrivers_all[8,2] <- nsrivers_all[1,2]

# for all years:
# plot(NSrast, xlim=c(-61, -60), ylim=c(46, 47))
# points(nsrivers_all[9,3], nsrivers_all[9,2], col="red")
nsrivers_all[9,2:3] <- c(46.26345, -60.59543)
plot(NSrast, xlim=c(-62.5, -62), ylim=c(44.75, 45.25))
# points(nsrivers_all[22,3], nsrivers_all[22,2], col="red")
nsrivers_all[22,2:3] <- c(44.97533, -62.08651)

```

# Transition layer, Geocorrection, calculate distance matrix, calculate Cumulative Weighted Distances
```{r}
# for q-values
NSQ <- read.csv("C:/Users/keyserf/Documents/Data/NS Q values.csv", header=TRUE) 
head(NSQ)

names(NSQ) <- c("Code", "Q", "Distance")

NSQ <- join(NSQ, qsitecoords, type="left")
NSQ <- NSQ[!is.na(NSQ$Lat)==TRUE,]
NSQ <- subset(NSQ, !Region %in% c("Southern Quebec", "Gaspesie", "Anticosti", "North Shore upper", "North Shore Lower"))
NSQ <- subset(NSQ, !Site %in% c("Cap Chat", "Cross", "Big Salmon", "Jacquet", "Miramichi", "Nashwaak", "Tobique"))

NSQ[1, 5:6] <- c(-61.957673, 45.623055)
NSQ[2, 5:6] <- c(-60.586089, 45.954479)
NSQ[3, 5:6] <- c(-64.273080, 45.111435)
NSQ[4, 5:6] <- c(-64.385449, 44.307135)
NSQ[7, 5:6] <- c(-63.384861, 45.358871)
NSQ[8, 5:6] <- c(-60.611916, 46.291407)
NSQ[9, 5:6] <- c(-61.931604, 45.075335)
NSQ[10, 5:6] <- c(-63.478616, 45.306643)

# create transition layer for raster (likelihood of presence within cell). 
tr5 <- transition(1/NSrast, transitionFunction=mean, directions=8)
tr5c <- geoCorrection(tr5, type="c")

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d5 <- costDistance(tr5c, fromCoords = cbind(as.numeric(NSsiterast[,1]), as.numeric(NSsiterast[,2])), toCoords = cbind(as.numeric(nsrivers_all[,3]), as.numeric(nsrivers_all[,2])))

d5 

d6 <- costDistance(tr5c, fromCoords = cbind(as.numeric(NSsiterast[,1]), as.numeric(NSsiterast[,2])), toCoords = cbind(as.numeric(NSQ[,5]), as.numeric(NSQ[,6])))

d6

```

### IF ENVIRONMENT LOADED: START HERE!
```{r}
colnames(NSsitecoords)[1] <- "ID"
d6 <- as.data.frame(cbind(d6, NSsitecoords$ID))
colnames(d6)[11] <- "ID"

dist2AQ_NS <- join(d6, NSsitecoords, type="left")
```

# Calculate propagule pressure for each river. 
```{r}
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.character(x))
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ_NS$P1 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V1
dist2AQ_NS$P2 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V2
dist2AQ_NS$P3 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V3
dist2AQ_NS$P4 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V4
dist2AQ_NS$P5 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V5
dist2AQ_NS$P6 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V6
dist2AQ_NS$P7 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V7
dist2AQ_NS$P8 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V8
dist2AQ_NS$P9 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V9
dist2AQ_NS$P10 <- dist2AQ_NS$Site.Size..HA./dist2AQ_NS$V10


# sum all pressures for total propagule pressure at a river
prop.press_NS <- apply(as.matrix(dist2AQ_NS[,20:29]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD <- data.frame(code=NSQ[,1], lat=NSQ[,6], long = NSQ[,5], prop.press = prop.press_NS, Q=NSQ[,2])

prop.press_NS <- riverCWD
write.csv(prop.press_NS, "C:/Users/keyserf/Documents/Data/Propagule Pressure NS_lin_all years_2016-11-13.csv")
#comp <- read.csv("C:/Users/keyserf/Documents/Data/Propagule Pressure NS_lin_all years_2016-11-13.csv")
#prop.press_NS


## or if sizes are negligble
dist2AQ_NS$D1 <- 1/dist2AQ_NS$V1
dist2AQ_NS$D2 <- 1/dist2AQ_NS$V2
dist2AQ_NS$D3 <- 1/dist2AQ_NS$V3
dist2AQ_NS$D4 <- 1/dist2AQ_NS$V4
dist2AQ_NS$D5 <- 1/dist2AQ_NS$V5
dist2AQ_NS$D6 <- 1/dist2AQ_NS$V6
dist2AQ_NS$D7 <- 1/dist2AQ_NS$V7
dist2AQ_NS$D8 <- 1/dist2AQ_NS$V8
dist2AQ_NS$D9 <- 1/dist2AQ_NS$V9
dist2AQ_NS$D10 <- 1/dist2AQ_NS$V10
dist2AQ_NS$D11 <- 1/dist2AQ_NS$V11
dist2AQ_NS$D12 <- 1/dist2AQ_NS$V12
dist2AQ_NS$D13 <- 1/dist2AQ_NS$V13
dist2AQ_NS$D14 <- 1/dist2AQ_NS$V14
dist2AQ_NS$D15 <- 1/dist2AQ_NS$V15
dist2AQ_NS$D16 <- 1/dist2AQ_NS$V16
dist2AQ_NS$D17 <- 1/dist2AQ_NS$V17
dist2AQ_NS$D18 <- 1/dist2AQ_NS$V18
dist2AQ_NS$D19 <- 1/dist2AQ_NS$V19
dist2AQ_NS$D20 <- 1/dist2AQ_NS$V20
dist2AQ_NS$D21 <- 1/dist2AQ_NS$V21
dist2AQ_NS$D22 <- 1/dist2AQ_NS$V22
dist2AQ_NS$D23 <- 1/dist2AQ_NS$V23
dist2AQ_NS$D24 <- 1/dist2AQ_NS$V24
dist2AQ_NS$D25 <- 1/dist2AQ_NS$V25


# sum all pressures for total propagule pressure at a river
prop.press_NS_2 <- apply(as.matrix(dist2AQ_NS[,60:84]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD2 <- data.frame(code=nsrivers_all[,1], lat=nsrivers_all[,2], long = nsrivers_all[,3], prop.press = prop.press_NS_2)

prop.press_NS_2 <- riverCWD2

```

# plot propagule pressure
```{r}
NSprov <- fortify(NS.low)

NSsitecoords <- arrange(NSsitecoords, -Site.Size..HA.)
prop.press_NS <- arrange(prop.press_NS, -prop.press)

plot(NSrast, xlim=c(-67, -62), ylim=c(44, 48))
coverpoints <- click(n=10)
cover <- data.frame(coverpoints)
cover

plot3 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=NSprov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-66.4, xmax=-66, ymin=45, ymax= 47, fill="grey") +
  geom_polygon(data=cover, aes(x, y), fill="grey") +
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.25, ymax=44, fill="grey") +
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=44, ymax=45, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-59.5, ymin=43.25, ymax=43.4, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-66.4, ymin=43.25, ymax=47.25, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-61, ymin=47, ymax=47.25, fill="grey") +
  annotate(geom="rect", xmin=-63, xmax=-61.9, ymin=46, ymax=47.25, fill="grey") +
  geom_point(data=NSsitecoords, aes(Longitude, Latitude, size=Site.Size..HA.), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-66.75, -59.5), ylim=c(43.25, 47.25)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Site size (ha)", range = c(0.5,10), limits=c(0,45), breaks=c(1, 5, 10, 15, 25, 35, 45))

plot4 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=NSprov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-66.4, xmax=-66, ymin=45, ymax= 47, fill="grey") +
  geom_polygon(data=cover, aes(x, y), fill="grey") +
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.25, ymax=44, fill="grey") +
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=44, ymax=45, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-59.5, ymin=43.25, ymax=43.4, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-66.4, ymin=43.25, ymax=47.25, fill="grey") +
  annotate(geom="rect", xmin=-66.75, xmax=-61, ymin=47, ymax=47.25, fill="grey") +
  annotate(geom="rect", xmin=-63, xmax=-61.9, ymin=46, ymax=47.25, fill="grey") +
  geom_point(data=prop.press_NS, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-66.75, -59.5), ylim=c(43.25, 47.25)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Propagule\npressure=\n\u03A3(ha/dist)", range = c(0.5,10), limits=c(0,0.009), breaks=c(0.001, 0.003, 0.005, 0.007, 0.009))
  
  

gA <- ggplotGrob(plot3)
gB <- ggplotGrob(plot4)
grid.newpage()
grid.draw(cbind(gA, gB))

```

## NS q-values vs. propagule pressure
```{r}
ggplot() + 
  geom_smooth(data=prop.press_NS, aes(prop.press, Q), method="lm", se=TRUE) +
  geom_point(data=prop.press_NS, aes(prop.press, Q)) +
  geom_label_repel(data=prop.press_NS, aes(prop.press, Q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  xlab("Propagule pressure") +
  ylab("Q value") 

ggplot() + geom_text(data=prop.press_NS, aes(long, lat, label=code))

``

## NS morris escapes vs. propagule pressure
```{r}
nsclean <- subset(morris_clean, ProvState=="NS")

nsclean_summ <- ddply(.data=nsclean, .(River),
                      summarize,
                      totalF = sum(as.numeric(as.character(TotalFarmed)), na.rm=TRUE),
                      totalC = sum(as.numeric(as.character(TotalCombined)), na.rm=TRUE))

nsclean_summ$prop <- nsclean_summ$totalF/nsclean_summ$totalC
nsclean_summ[c(4,10), 4] <- 0

names(prop.press_NS) <- c("River", "lat", "long", "prop.press")

nsescaperel <- join(nsclean_summ, prop.press_NS, type="left")

nsescaperel$cnty <- c("Bay of Fundy", "Cape Breton", "Bay of Fundy", "Cape Breton", "South Shore", "South Shore", "Cape Breton", "Bay of Fundy", "Cape Breton", "Yarmouth", "Bay of Fundy", "Cape Breton")

ggplot() + 
  geom_smooth(data=nsescaperel, aes(prop.press, prop), method="lm") + 
  geom_point(data=nsescaperel, aes(prop.press, prop, colour=cnty), size=3) + 
  theme_classic() + 
  theme(panel.border=element_rect(colour="black", fill=NA)) +
  xlab("\nPropagule pressure = \u03A3(ha/dist)") + 
  ylab("Likelihood of detecting escapees\n") +
  scale_colour_discrete(name=NULL)

## or vs. distance?
names(prop.press_NS_2) <- c("River", "lat", "long", "prop.press")

nsescaperel_2 <- join(nsclean_summ, prop.press_NS_2, type="left")

nsescaperel_2$cnty <- c("Bay of Fundy", "Cape Breton", "Bay of Fundy", "Cape Breton", "South Shore", "South Shore", "Cape Breton", "Bay of Fundy", "Cape Breton", "Yarmouth", "Bay of Fundy", "Cape Breton")

ggplot() + 
  geom_smooth(data=nsescaperel_2, aes(prop.press, prop), method="lm") + 
  geom_point(data=nsescaperel_2, aes(prop.press, prop, colour=cnty), size=3) + 
  theme_classic() + 
  theme(panel.border=element_rect(colour="black", fill=NA)) +
  xlab("\nPropagule pressure = \u03A3(1/dist)") + 
  ylab("Likelihood of detecting escapees\n") +
  scale_colour_discrete(name=NULL)
