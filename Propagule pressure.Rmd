
# Read in packages
```
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
```

##########################################################################################################################
######################### SOUTHERN NEWFOUNDLAND CAGE SITE DISTANCES TEMPLATE CODE ########################################
##########################################################################################################################

## for low-res generic mapping
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/atlas/75m_prod/geog/shape/
prov <- readShapeSpatial("C:/Users/keyserf/Documents/R/canvec/pvp/pvp.shp", proj4string=CRS("+proj=longlat +ellps=GRS80 +no_defs"))
#prov <- fortify(model=prov)
```

## Calculate distances between points with boundaries, need fine scale data for raster
## SKIP DOWN IF ENVIRONMENT IS LOADED
### read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
#NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 46.8, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
# NL.low.ocean <- readOGR(dsn="./canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
# r <- raster(ncol=1125, nrow=560)
# extent(r) <- extent(NL.low.ocean)
# NLrast <- rasterize(NL.low.ocean, r, fun="first")

# NLline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Land_shp/shoreline_1_small.shp", "shoreline_1_small")

```

##### START HERE IF ENVIRONMENT IS READY #####
```{r}
# site coords
# read in sites from AQ sites NL script
sitecoords <- unique(subset(inventory, is.na(Lat)=="FALSE", select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# escaped fish location
escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
str(escapes)

escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")
names(rivers) <- c("code", "V1", "V2")
escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
escapemat <- as.data.frame(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))
escapemat <- rbind(escapemat, as.data.frame(rivers[,2:3]))
escapemat <- as.matrix(escapemat)

```

## River mouths
```{r}
rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")

## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
plot(NLrast)
text(rivers[,2], rivers[,3])
lines(NLline)
# rivermouths <- SpatialPoints(click(n=18))
rivermouths <- snapPointsToLines(rivermouths, NLline)
rivermouths <- fortify(as.data.frame(rivermouths))
text(rivermouths$X, rivermouths$Y, col="red", labels=1:18)



Bsites <- read.csv("C:/Users/keyserf/Documents/Data/sites_lat_long_brendan.csv", header=TRUE)
# plot(NLrast)
# head(Bsites)
# points(Bsites$V1, Bsites$V2, pch=21, bg="black")
Bsites <- Bsites[1:18,] 
Bsites[,1:3] <- apply(Bsites[,1:3], 2, function(x) as.character(x))
Bsites[,2:3] <- apply(Bsites[,2:3], 2, function(x) as.numeric(x))
  
x <- Bsites$V1
y <- Bsites$V2
xy <-cbind(x, y)
Bsiterast <- as.matrix(xy)

```

# Change values in raster so that land is impassable (i.e. distances would be massive). 
```{r}
# Also get rid of ocean blob
# NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
# NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)
```

# Fix some AQ site coords
```{r}
# for 2013 only:
# plot(NLrast, xlim=c(-56.0, -55.5), ylim=c(47.4, 47.6))
# points(siterast[12,1], siterast[12,2], col="blue")
# siterast[12,] <- click()
# make site 12 = -55.58610 and 47.51435

# for all years:
# plot(NLrast)
# points(siterast[17,1], siterast[17,2])
# siterast[17,] <- click()
## make site 17 = -56.06074 and 47.77717
# points(siterast[30,1], siterast[30,2])
# siterast[30,] <- click()
## make site 30 = -55.78194 and 47.57588
```

# Transition layer, Geocorrection, calculate distance matrix, calculate Cumulative Weighted Distances
```{r}
# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(Bsiterast[,1]), as.numeric(Bsiterast[,2])))
d3 
```

### IF ENVIRONMENT LOADED: START HERE!
```{r}
d3 <- as.data.frame(cbind(d3, sitecoords$ID))
colnames(d3)[19] <- "ID"
colnames(d3)[1:18] <- as.list(as.character(rivers$code))

dist2AQ <- join(d3, inventory, type="left")
```

# Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.character(x))
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.numeric(x))

dist2AQ[46,]$SMB <-1000

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BTB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$DLR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GBB
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$GLP
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$LMS
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$LTR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$MAL
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$NEB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$FBN
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$OBB
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$SMB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$SEB
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$TRB
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$TBB
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$TEB

## via decay function
dist2AQ$P1 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$BTB/1000))
dist2AQ$P2 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$CNR/1000))
dist2AQ$P3 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$DLR/1000))
dist2AQ$P4 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GAR/1000))
dist2AQ$P5 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GBB/1000))
dist2AQ$P6 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$GLP/1000))
dist2AQ$P7 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LMS/1000))
dist2AQ$P8 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LTR/1000))
dist2AQ$P9 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$LHR/1000))
dist2AQ$P10 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$MAL/1000))
dist2AQ$P11 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$NEB/1000))
dist2AQ$P12 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$FBN/1000))
dist2AQ$P13 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$OBB/1000))
dist2AQ$P14 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$SMB/1000))
dist2AQ$P15 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$SEB/1000))
dist2AQ$P16 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TRB/1000))
dist2AQ$P17 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TBB/1000))
dist2AQ$P18 <- dist2AQ$totalfish^(-0.0012*(dist2AQ$TEB/1000))

dist2AQ[,26:43] <- apply(dist2AQ[,26:43], 2, function(x) replace(x, is.infinite(x), 0))

# sum all pressures for total propagule pressure at a river
prop.press <- apply(as.matrix(dist2AQ[,26:43]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD <- data.frame(code=Bsites[,1], lat=Bsites[,3], long = Bsites[,2], prop.press = prop.press)

# match rivermouths to sampling sites
# zoomed <- crop(NLrast, extent(-55.5,-55.3, 47.6, 47.8))
# plot(zoomed)

# plot(NLrast)
# #text(escapemat[,1], escapemat[,2])
# escapelocs <- escapemat
# escapelocs$rivermouth <- c(6,6,6,11,6,5,3,6,2,3,1,11,12,10,13,3,9,8,7,7,4,5,3,3,4,10)
# 
# #text(riverCWD[,2], riverCWD[,1], col="yellow")
# riverCWD$rivermouth <- c(1:13)
# 

prop.press <- riverCWD
write.csv(prop.press, "C:/Users/keyserf/Documents/Data/Propagule Pressure_exp_all years_2016-11-02.csv")

```

# plot propagule pressure
```{r}
inventory <- subset(inventory, totalfish > 0)
inventory$Lat <- as.numeric(inventory$Lat)
inventory$Long <- as.numeric(inventory$Long)

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=inventory, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(1,4000000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000, 4000000))

plot2 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.pressALL, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  scale_size_continuous(name="Propagule\npressure=\n\u03A3(total fish/dist)", range = c(0.5,10), limits=c(100,10000), breaks=c(500, 1000, 2500, 5000, 10000))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))

```

# NEXT: proportion of escapees (or number of escapes) vs. propagule pressure for those 3 rivers
```{r}
names(escapelocs) <- c("Longitude..E.", "Latitude..N.", "rivermouth", "lat", "long", "prop.press")

escapes <- join(escapes, escapelocs, type="left")

farmed <- subset(escapes, Life.Stage=="Farmed")

proportions_f <- ddply(.data=farmed, .(rivermouth),
                     summarize,
                    farmed = length(Sample.ID))

total <- ddply(.data=escapes, .(rivermouth, prop.press),
                       summarize,
                       total=length(Sample.ID))

proportions <- join(total, proportions_f, type="left")
proportions$farmed <- ifelse(is.na(proportions$farmed)=="TRUE", 0, proportions$farmed)

proportions$prop <- proportions$farmed/proportions$total

require(ggrepel)

proportions$name <- c("Little", "Simm's", "Northwest", "Garnish")

ggplot() + 
  geom_smooth(data=proportions, aes(prop.press, prop), method="lm", se=FALSE) +
  geom_point(data=proportions, aes(prop.press, prop)) +
  geom_text_repel(data=proportions, aes(prop.press, prop, label=name), nudge_y=0.1) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  xlab("Propagule Pressure") +
  ylab("Proportion of escapees")+
  xlim(c(750, 3500)) +
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0)
  annotate(geom="text", x=2750, y=0.2, label="R-squared = 0.5762\np-value = 0.153", hjust=0)

model1 <- lm(data=proportions, prop ~ prop.press)
summary(model1)
```

# Yes but which is greater driver - distance or nfish?

```{r}
## calculate average distance to AQ sites
## calculate nfish within 20KM

# distances
avgdists <- apply(dist2AQ[,1:12], 2, mean)
avgdists <- data.frame(rivermouth = 1:12, avgdist=avgdists)

# nfish within 20km
melted <- melt(data=dist2AQ[,c(1:13, 16)], id.vars=c("ID", "totalfish"))
closefish <- subset(melted, value < 20000)
closecounts <- ddply(.data=closefish, .(variable),
                     summarize,
                     count = sum(totalfish, na.rm=TRUE))
closecounts <- rbind(data.frame(variable="V1", count=0), closecounts, data.frame(variable=c("V9", "V10", "V11", "V12"), count=0))
colnames(closecounts)[1] <- "rivermouth"
closecounts[1] <- 1:12

expanded <- join(avgdists, closecounts, type="left")

proportions <- join(proportions, expanded, type="left")

ggplot() + 
  geom_point(data=proportions, aes(avgdist, prop)) +
  geom_smooth(data=proportions, aes(avgdist, prop), method="lm", se=FALSE) + 
  geom_text_repel(data=proportions, aes(avgdist, prop, label=name), nudge_y=0.1) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(0, 1.2) +
  annotate(geom="text", x=76000, y=1, label="R-squared = 0.1359\np-value = 0.292", hjust=0) +
  xlab("Mean distance to aquaculture sites") +
  ylab("Proportion of escapees")

ggplot() + 
  geom_point(data=proportions, aes(count, prop)) +
    geom_smooth(data=proportions, aes(count, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(count, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.1) +
  annotate(geom="text", x=0, y=1, label="R-squared = 0.9825\np-value = 0.00585", hjust=0) +
  xlab("Number of aquaculture fish within 20km") +
  ylab("Proportion of escapees")

model2 <- lm(data=proportions, prop ~ count)
summary(model2)

model3 <- lm(data=proportions, prop ~ avgdist)
summary(model3)
### OK BUT WHY ARE THERE MULTIPLE ROWS OF THE SAME SITE? ARE THEY GETTING ADDED TWICE? PROBABLY.
```

### Escape events
```{r}
# events dataframe from AQ sites script
names(events)
events <- unique(select(events, ID, ReportYear, NEscape))
names(events)
events2 <- ddply(.data=events, .(ID, Bay),
                 summarize,
                 totalescape = sum(NEscape))

melted <- join(melted, events2, type="left")

escape.press <- ddply(.data=melted, .(variable),
                       summarize,
                      e.press = sum(totalescape/value, na.rm=TRUE))
####### Come back to this later. I need lat/longs for the sites that had escapes. #######

```

### Sampling effort
```{r}
sets <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Set Details.csv")
head(sets)

sets$Date.Time.Start <- paste(sets$Date, sets$Set.Time..UTC.)
sets$Date.Time.End <- paste(sets$Date, sets$Retrieval.Time..UTC.)

sets$Date.Time.Start <- dmy_hms(sets$Date.Time.Start)
sets$Date.Time.End <- dmy_hms(sets$Date.Time.End)
sets$Duration <- sets$Date.Time.End - sets$Date.Time.Start

sets$Duration <- ifelse(is.na(sets$Duration)==TRUE, mean(sets$Duration, na.rm=TRUE), sets$Duration)

sets <- select(sets, Set.ID, River.Name, Date.Time.Start, Date.Time.End, Latitude..N., Longitude..E., Duration)

sets$rivermouth[sets$River.Name=="Simm's Brook"] <- 5
sets$rivermouth[sets$River.Name=="Bay du Nord River"] <- 6
sets$rivermouth[sets$River.Name=="Little River"] <- 3
sets$rivermouth[sets$River.Name=="Garnish River"] <- 10
sets$rivermouth[sets$River.Name=="Northwest River"] <- 6

effort <- ddply(.data=sets, .(rivermouth),
                summarize,
                effort = sum(Duration),
                nsets = length(unique(Set.ID)))

colnames(melted)[3] <- "rivermouth"
melted$rivermouth <- as.character(melted$rivermouth)
melted$rivermouth <- sub(melted$rivermouth, pattern="V", replacement="")

melted <- join(melted, effort, type="left")
melted$effort <- ifelse(is.na(melted$effort)==TRUE, 0, melted$effort)
melted$nsets <- ifelse(is.na(melted$nsets)==TRUE, 0, melted$nsets)

melted <- unique(select(melted, rivermouth, effort, nsets))

proportions <- join(proportions, melted, type="left")

ggplot() + 
  geom_point(data=proportions, aes(effort, prop)) +
    geom_smooth(data=proportions, aes(effort, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(effort, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=1400, y=0, label="R-squared = 0.0594\np-value = 0.3893", hjust=0) +
  xlab("Duration of sampling effort (minutes)") +
  ylab("Proportion of escapees")


ggplot() + 
  geom_point(data=proportions, aes(nsets, prop)) +
    geom_smooth(data=proportions, aes(nsets, prop), method="lm", se=FALSE) +
  geom_text_repel(data=proportions, aes(nsets, prop, label=name), nudge_y=0.15) + 
   theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ylim(-0.1, 1.2) +
  annotate(geom="text", x=9.5, y=0, label="R-squared = 0.07723\np-value = 0.380", hjust=0) +
  xlab("Number of gill net sets") +
  ylab("Proportion of escapees")


model4 <- lm(data=proportions, prop~effort)
summary(model4)

model5 <- lm(data=proportions, prop~nsets)
summary(model5)

```

### for 2013 only
```{r}
colnames(d3)[1:18] <- as.list(as.character(Bsites$X))
dist2AQ_2013 <- join(d3, totfish2013, type="left")

dist2AQ_2013[,1:18] <- apply(dist2AQ_2013[,1:18], 2, function(x) as.character(x))
dist2AQ_2013[,1:18] <- apply(dist2AQ_2013[,1:18], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
# original method of calculation
dist2AQ_2013$P1 <- dist2AQ_2013$totalfish/dist2AQ_2013$BTB
dist2AQ_2013$P2 <- dist2AQ_2013$totalfish/dist2AQ_2013$CNR
dist2AQ_2013$P3 <- dist2AQ_2013$totalfish/dist2AQ_2013$DLR
dist2AQ_2013$P4 <- dist2AQ_2013$totalfish/dist2AQ_2013$GAR
dist2AQ_2013$P5 <- dist2AQ_2013$totalfish/dist2AQ_2013$GBB
dist2AQ_2013$P6 <- dist2AQ_2013$totalfish/dist2AQ_2013$GLP
dist2AQ_2013$P7 <- dist2AQ_2013$totalfish/dist2AQ_2013$LMS
dist2AQ_2013$P8 <- dist2AQ_2013$totalfish/dist2AQ_2013$LTR
dist2AQ_2013$P9 <- dist2AQ_2013$totalfish/dist2AQ_2013$LHR
dist2AQ_2013$P10 <- dist2AQ_2013$totalfish/dist2AQ_2013$MAL
dist2AQ_2013$P11 <- dist2AQ_2013$totalfish/dist2AQ_2013$NEB
dist2AQ_2013$P12 <- dist2AQ_2013$totalfish/dist2AQ_2013$FBN
dist2AQ_2013$P13 <- dist2AQ_2013$totalfish/dist2AQ_2013$OBB
dist2AQ_2013$P14 <- dist2AQ_2013$totalfish/dist2AQ_2013$SMB
dist2AQ_2013$P15 <- dist2AQ_2013$totalfish/dist2AQ_2013$SEB
dist2AQ_2013$P16 <- dist2AQ_2013$totalfish/dist2AQ_2013$TRB
dist2AQ_2013$P17 <- dist2AQ_2013$totalfish/dist2AQ_2013$TBB
dist2AQ_2013$P18 <- dist2AQ_2013$totalfish/dist2AQ_2013$TEB

## via decay function
dist2AQ_2013$P1 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$BTB/1000))
dist2AQ_2013$P2 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$CNR/1000))
dist2AQ_2013$P3 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$DLR/1000))
dist2AQ_2013$P4 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GAR/1000))
dist2AQ_2013$P5 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GBB/1000))
dist2AQ_2013$P6 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$GLP/1000))
dist2AQ_2013$P7 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LMS/1000))
dist2AQ_2013$P8 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LTR/1000))
dist2AQ_2013$P9 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$LHR/1000))
dist2AQ_2013$P10 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$MAL/1000))
dist2AQ_2013$P11 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$NEB/1000))
dist2AQ_2013$P12 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$FBN/1000))
dist2AQ_2013$P13 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$OBB/1000))
dist2AQ_2013$P14 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$SMB/1000))
dist2AQ_2013$P15 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$SEB/1000))
dist2AQ_2013$P16 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TRB/1000))
dist2AQ_2013$P17 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TBB/1000))
dist2AQ_2013$P18 <- dist2AQ_2013$totalfish^(-0.0012*(dist2AQ_2013$TEB/1000))

# sum all pressures for total propagule pressure at a river
prop.press <- apply(as.matrix(dist2AQ_2013[,23:40]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
riverCWD <- data.frame(code=Bsites[,1], lat=Bsites[,3], long = Bsites[,2], prop.press = prop.press)

# match rivermouths to sampling sites
# zoomed <- crop(NLrast, extent(-55.7,-55.2, 47.6, 47.8))
# plot(zoomed)

# plot(NLrast)
# #text(rivers[,2], rivers[,3])
# escapelocs <- as.data.frame(escapemat)
# rivers$rivermouth <- 1:18


# #text(rivermouths[,2], rivermouths[,3], col="yellow")
# riverCWD$rivermouth <- 1:18
# rivermouths$rivermouth <- 1:18
# prop.press2013 <- join(riverCWD, rivermouths, type="left")
prop.press2013 <- riverCWD

prop.press2013$name <- c("Bottom Brook", "Conne River", "Dollard's Brook",
                         "Garnish River", "Grand Bank Brook", "Grand LaPierre Brook",
                         "Salmonier River", "Little River", "Long Harbour River",
                         "Mal Bay Brook", "Northeast Brook", "Northwest Brook",
                         "Old Bay Brook", "Simm's Brook", "Southeast Brook",
                         "Tailrace Brook", "Taylor Bay Brook", "Terrenceville Brook")

prop.press2013 <- select(prop.press2013, code, lat, long, prop.press, name)
prop.press2013
write.csv(prop.press2013, file="C:/Users/keyserf/Documents/Data/2013 propagule pressures_exp_2016-11-01.csv")
```

# plot propagule pressure
```{r}
totfish2013 <- subset(totfish2013, totalfish > 0)
totfish2013$Lat <- as.numeric(totfish2013$Lat)
totfish2013$Long <- as.numeric(totfish2013$Long)

prov <- fortify(NL.low.ocean)
prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

totfish2013 <- arrange(totfish2013, -totalfish)
prop.press2013 <- arrange(prop.press2013, -prop.press)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=totfish2013, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,7), limits=c(1,1200000), breaks=c(100, 1000, 10000, 100000, 500000, 1000000, 1200000))

plot2 <- ggplot() + 
  ggtitle("Salmon rivers")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.press2013, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  annotate(geom="point", x=-55.8222, y=47.6223, colour="blue") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  #annotate(geom="point", x=-55.77313, y=47.50711)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  scale_size_continuous(name="Propagule\npressure=\n\u03A3(total fish/dist)", range = c(0.5,7), limits=c(0,550), breaks=c(50, 150, 250, 350, 450, 550))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))


```



### so we think that the escape came from ID 1072
```{r}
escapesite <- subset(dist2AQ_2013, ID==1072) 
distances <- melt(escapesite)[1:18,]
names(distances) <- c("ID", "River", "DistanceToRiver.m.")
distances
distances$DistanceToRiver.km. <- distances$DistanceToRiver.m./1000
pressures <- melt(escapesite)[22:39,]
names(pressures) <- c("ID", "River", "TotalFish..Distance")
pressures
escapesite <- cbind(distances[,1:4], pressures[,3])
escapesite[,3] <- round(escapesite[,3], 0)
escapesite[,4] <- round(escapesite[,4], 3)
names(escapesite) <- c("ID", "River", "DistanceToRiver.m.", "DistanceToRiver.km.", "SpecificPressure")
escapesite
write.csv(escapesite, file="C:/Users/keyserf/Documents/Data/2013 escape site 1072_2016-11-01.csv")

ggplot() + geom_point(data=escapesite, aes(DistanceToRiver.km., 1)) + 
  geom_text_repel(data=escapesite, aes(DistanceToRiver.km., 1, label=River), min.segment.length=unit(0.1, "lines"))
require(ggrepel)
orderedlist <- arrange(escapesite, DistanceToRiver.km.)

## trying CBC point
dCBC <- costDistance(tr3c, fromCoords = cbind(-55.77313, 47.50711), toCoords = cbind(as.numeric(Bsiterast[,1]), as.numeric(Bsiterast[,2])))
dCBC
distances2 <- melt(dCBC)
distances2 <- distances2[,2:3]
names(distances2) <- c("RiverNumber", "DistanceToRiver.m.")
distances2
distances2$DistanceToRiver.km. <- distances2$DistanceToRiver.m./1000
distances2$River <- Bsites$X
write.csv(distances2, file="C:/Users/keyserf/Documents/Data/2013 cbc green point distances.csv")

orderedlist2 <- arrange(distances2, DistanceToRiver.km.)

orderedlist <- select(orderedlist, River, DistanceToRiver.km.)
orderedlist2 <- select(orderedlist2, River, DistanceToRiver.km.)
orderedlist <- cbind(orderedlist, 1:18)
orderedlist2 <- cbind(orderedlist2, 1:18)
orderchange <- rbind(orderedlist, orderedlist2)
orderchange <- cbind(orderchange, c(rep("GP", 18), rep("CBC", 18)))
names(orderchange) <- c("River", "Distance", "Order", "Site")
ggplot() + geom_point(data=orderchange, aes(Site, Distance, colour=River))+
  geom_line(data=orderchange, aes(Site, Distance, colour=River, group=River)) +
  geom_text_repel(data=orderchange, aes(Site, Distance, label=River, colour=River), size=3)
