
# Read in packages
```{r}
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
require(ggrepel)
require(scales)
require(ggspatial)
require(AQpress)
```

-------------------------------------------------------------------------------------------------------------
# SOUTHERN NEWFOUNDLAND CAGE SITE PROPAGULE PRESSSURES 
-------------------------------------------------------------------------------------------------------------

## Newfoundland - read in shapefiles, create raster file
```{r}
annual <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NL annual inventory and coords_summary_2016-11-29.csv")

## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
# NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 46.8, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
NL.low.ocean <- readOGR(dsn="C:/Users/keyserf/Documents/R/Escapes/canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
r <- raster(ncol=1125, nrow=560)
extent(r) <- extent(NL.low.ocean)
NLrast <- rasterize(NL.low.ocean, r, fun="first")

# if shoreline needed:
# NLline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Land_shp/shoreline_1_small.shp", "shoreline_1_small")

# Change values in raster so that land is impassable (i.e. distances would be massive). 

# Also get rid of ocean blob
NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)

# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")


# for q value analysis
# creating raster
# r <- raster(ncol=1100, nrow=1160) #(1 grid square ~ 0.5 km2)
# extent(r) <- extent(NLprov)
# NLprovrast <- rasterize(NLprov, r, fun="first")
# 
# # adjust values to make lines impassable
# NLprovrast@data@values <- ifelse(is.na(NLprovrast@data@values)=="TRUE", 10000, 1)
# 
# # create transition layer for raster (likelihood of presence within cell).
# tr3q <- transition(1/NLprovrast, transitionFunction=mean, directions=8)
# tr3cq <- geoCorrection(tr3q, type="c")

# for SFA 10 and 11 scheduled rivers
# read in cropped shapefile: NL.low.ocean
NL.south <- crop(NL.low, extent(-59, -53, 46, 49))

plot(NL.south)

# # creating raster
r <- raster(ncol=920, nrow=552) ## 1 cell = 500m2
extent(r) <- extent(NL.south)
NLsouthrast <- rasterize(NL.south, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive). 

# Also get rid of ocean blob
NLsouthrast@data@values <- ifelse(is.na(NLsouthrast@data@values)=="TRUE", 10000, 1)
NLsouthrast@data@values <- ifelse(coordinates(NLsouthrast)[,1] < -56 & coordinates(NLsouthrast)[,2] < 47.4, 1, NLsouthrast@data@values)
NLsouthrast@data@values <- ifelse(coordinates(NLsouthrast)[,1] < -55 & coordinates(NLsouthrast)[,2] < 46.85, 1, NLsouthrast@data@values)

plot(NLsouthrast)

# create transition layer for raster (likelihood of presence within cell). 
tr3s <- transition(1/NLsouthrast, transitionFunction=mean, directions=8)
tr3cs <- geoCorrection(tr3s, type="c")
```
## Newfoundland - AQ site coordinates and river mouths
```{r}
# site coords

# read in sites from annual NL inventory. Adjust years as desired. Min for NL is 2005, max is 2015. 
sitecoords <- unique(subset(annual, is.na(Lat)=="FALSE", select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# for q values
sitecoords <- unique(subset(annual, is.na(Lat)=="FALSE" & ReportYear<2013, select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# # escaped fish location
# escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# str(escapes)
# 
# escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")
# names(rivers) <- c("code", "V1", "V2")
# escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
# escapemat <- as.data.frame(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))
# escapemat <- rbind(escapemat, as.data.frame(rivers[,2:3]))
# escapemat <- as.matrix(escapemat)

## Newfoundland River mouths

## Details for above:
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# 
# ## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
# plot(NLrast)
# text(rivers[,2], rivers[,3])
# lines(NLline)
# # rivermouths <- SpatialPoints(click(n=18))
# rivermouths <- snapPointsToLines(rivermouths, NLline)
# rivermouths <- fortify(as.data.frame(rivermouths))
# text(rivermouths$X, rivermouths$Y, col="red", labels=1:18)

# For Brendan's river sites:

Bsites <- read.csv("C:/Users/keyserf/Documents/Data/sites_lat_long_brendan.csv", header=TRUE)
# plot(NLrast)
# head(Bsites)
# points(Bsites$V1, Bsites$V2, pch=21, bg="black")
# Bsites <- Bsites[1:18,] 
# Bsites[,1:3] <- apply(Bsites[,1:3], 2, function(x) as.character(x))
# Bsites[,2:3] <- apply(Bsites[,2:3], 2, function(x) as.numeric(x))
#   
# x <- Bsites$V1
# y <- Bsites$V2
# xy <-cbind(x, y)
# Bsiterast <- as.matrix(xy)

## For precise PARR project sampling locations in rivers:

# sampling <- read.csv("C:/Users/keyserf/Documents/Data/Salmon sampling summary 2014.csv", header=TRUE)
# sampling <- select(sampling[1:20,], Location, Latitude, Longitude)
# sampling$code <- c("BTB", "CNR", "CNR", "DLR", "GAR", "GBB", "GLP", "LMS", "LTR", "LHR", "MAL", "NET", "NEB", "FBN", "OBB", "SMB", "SEB", "TRB", "TBB", "TEB")
# sampling <- sampling[-c(2,12),]
# sampling
# 
# plot(NLrast)
# points(sampling$Longitude, sampling$Latitude)
# 
# #rivermouths<- SpatialPoints(click(n=18))
# rivermouths <- data.frame(rivermouths)
# rivermouths <- cbind(rivermouths, Bsites$X)

# write.csv(rivermouths, "C:/Users/keyserf/Documents/Data/Rivers/NL river mouth coords_2016-11-18.csv")
rivermouths <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NL river mouth coords_2016-11-18.csv", header=TRUE)

# for 2015 sampling

# sampling2015 <- rivermouths[rivermouths$code %in%c("GAR", "LTR", "FBN", "SMB"),]
bdn <- data.frame(X=NA, x=-55.42002, y=47.7079, code="BDN")
sampling2015 <- rbind(rivermouths, bdn)

# for SFA 10 and 11 
sched <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NL Scheduled Coordinates.csv")

```
## Newfoundland - Q values coords
```{r}
# read in sites
qsites <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Qvalues_All NL_2016-11-10.csv")
qsites <- qsites[,1:3]

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

qsites <- join(qsites, qsitecoords, type="left")

qsites[qsites$Code=="LHR",]$Long <- -54.94830
qsites[qsites$Code=="LHR",]$Lat <- 47.77960 

qsites[qsites$Code=="BSB",]$Long <- -53.282374
qsites[qsites$Code=="BSB",]$Lat <- 46.756687

qsites[qsites$Code=="WAB",]$Long <- -56.77375
qsites[qsites$Code=="WAB",]$Lat <- 51.21244

qsites[qsites$Code=="NBT",]$Long <- -53.36932
qsites[qsites$Code=="NBT",]$Lat <- 46.74945

qsites[qsites$Code=="NPR",]$Long <- -53.99326
qsites[qsites$Code=="NPR",]$Lat <- 47.24506

qsites[qsites$Code=="GRR",]$Long <- -57.09784
qsites[qsites$Code=="GRR",]$Lat <- 47.56489

qsites[qsites$Code=="CNR",]$Long <- -55.77851
qsites[qsites$Code=="CNR",]$Lat <- 47.86362

qsites[qsites$Code=="RKR",]$Long <- -53.58221
qsites[qsites$Code=="RKR",]$Lat <- 47.18433

# plot(NLprovrast, xlim=c(-57.5, -55.5), ylim=c(47.5, 48))
# text(qsites$Long, qsites$Lat)
```
### Newfoundland - for SFA 10 and 11. Fixing river coords
```{r}
sched <- arrange(sched, Long)

plot(NLsouthrast, xlim=c(-56.2, -55), ylim=c(47.4, 48))
text(sched$Long, sched$Lat)
click(n=3)

southcoords <- rbind(c(-58.12693,47.69343),# cinq cerf 1
c(-58.04176,47.7074),# couteau 2
c(-57.91504,47.706),# connoire 3
c(-57.83610,47.64454),# middle 4
c(-57.68445,47.63476),# grandy 5
c(-57.56812,47.63616),# kingsharbour 6
c(-57.54735,47.64734),# kelly 7
c(-57.54527,47.65013),# bay deloup 8
c(-57.29806,47.76048),# white bear 9
c(-57.10626,47.57051),# grey 10
c(-56.54329,47.70321),# dollard 11
c(-56.51836,47.70740),# morgan 12
c(-56.32932,47.69902),# brent cove 13
c(-56.32101,47.76886),# bottom 14
c(-56.29400,47.70181),# allans cove 15
c(-56.16313,47.86384),# despoir 16
c(-56.15274,47.83451),#hughes 17
c(-56.09250,47.74371),#long reach 18
c(-56.06645,47.77865),# salmon 19
c(-55.86821,46.87000),# pierceys 20
c(-55.83767,47.88911 ),# northwest 21 
c(-55.82535,47.08279),#fortune 22
c(-55.77261,46.86104),# salmonier river 23
c(-55.74623,47.10743),# grand bank 24
c(-55.76058,47.91923 ),#southeast 25
c(-55.71657,46.86776),#taylor bay brook 26
c(-55.80285,47.79706 ),# little brook 27
c(-55.76804,47.86400 ),# conne 28
c(-55.67354,47.66986),# salmonier 29
c(-55.63624,47.54434 ),# taylors bay 30
c(-55.60889,47.55438 ),#old brook 31
c(-55.54844,46.91255),#little lawn 32
c(-55.49240,46.91927),#lawn 33
c(-55.45720,47.63639),#simms 34
c(-55.45720,47.63639 ),# salmon 35
c(-55.46466,47.61965),# southwest 36
c(-55.42238,47.70501),#bay du nord 37
c(-55.39005,47.72007 ),#northwest 38 
c(-55.34075,46.91031),#little st. lawrence 39
c(-55.37016,47.72007),#north east 40
c(-55.35724,47.23734),#garnish 41
c(-55.32097,47.26870),# devil 42
c(-55.32789,47.65982),#belle harbour 43
c(-55.12977,47.17238),#west 44
c(-55.12977,47.17238),#tides 45
c(-55.18252,47.04919),#big salmonier 46
c(-55.21101,47.62635),#Rencontre 47
c(-55.13392,47.65982),#mal bay 48
c(-54.98913,47.27766),#red harbour 49
c(-54.98913,47.27766),#northeast 50
c(-54.96263,47.76526),# long harbour 51
c(-54.96263,47.76526),#southwest 52
c(-54.91001,47.33814),#rushoon 53 
c(-54.81112,47.39189),#bay de leau 54
c(-54.78110,47.66819),#grande la pierre 55
c(-54.73200,47.37845),#cape roger 56
c(-54.72390,47.67154),#terrenceville 57
c(-54.68914,47.38965),#nonsuch 58
c(-54.44787,47.57112),#black 59
c(-54.44787,47.57112),#paradise 60
c(-54.30613,47.67656),#sandy harbour 61
c(-54.21163,47.87405),#pipers hole 62
c(-54.18476,46.95063),#cuslett 63
c(-54.18428,47.87405),#black 64
c(-54.08508,47.87512),#watsons 65
c(-54.08508,47.87512),#north harbour 66
c(-54.07927,47.12758),#great barasway 67
c(-54.05394,47.18806),#little barasway 68
c(-54.00662,47.82529),#come by chance 69
c(-53.97812,47.24182),#southeast 70
c(-53.97812,47.24182),#shalloway 71
c(-53.90230,47.34486),#ship harbour 72
c(-53.92867,47.31126),#placentia sound 73
c(-53.96823,47.24854))# northeast 74

sched <- cbind(sched, southcoords)
names(sched) <-c("Prov", "SFA", "Name", "Long.1", "Lat.1", "Long", "Lat")
sched$Number <- c(1:74)
```
### Newfoundland - Fix some AQ site coords
```{r}
# for 2013 only:
# plot(NLrast, xlim=c(-56.0, -55.5), ylim=c(47.4, 47.6))
# points(siterast[12,1], siterast[12,2], col="blue")
# siterast[12,] <- c(-55.58610, 47.51435)
# make site 12 = -55.58610 and 47.51435

# for 2010-2015 years:
# plot(NLrast)
# points(siterast[17,1], siterast[17,2])
# siterast[17,] <- click()
## make site 17 = -56.06074 and 47.77717
# siterast[17,] <- c(-56.06074, 47.77717)
# points(siterast[30,1], siterast[30,2])
# siterast[30,] <- click()
# siterast[30,] <- c(-55.78194, 47.57588)
## make site 30 = -55.78194 and 47.57588

# for all years (2005-2015):
plot(NLrast, xlim=c(-56.25, -55.5), ylim=c(47.5, 47.8))
points(siterast[19,1], siterast[19,2])

siterast[19,] <- c(-56.0205, 47.80122) 
siterast[37,] <- c(-55.76244, 47.59899)
siterast[48,] <- c(-55.76244, 47.59899)

# for q values (2005-2013) entire prov:
# plot(NLprovrast, xlim=c(-56.5, -55.5), ylim=c(47.5, 48))
# text(siterast[,1], siterast[,2])
siterast[18,] <- c(-56.06056, 47.77635)
# siterast[32,] <- c(-55.79204, 47.58395)
# siterast[43,] <- c(-55.79204, 47.58395)
# siterast[35,] <- c(-55.77543, 47.59184)
# siterast[48,] <- c(-55.77543, 47.59184)


```
## Newfoundland - calculate distance matrix
```{r}
# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(rivermouths[,2]), as.numeric(rivermouths[,3])))

d3

# Q value coords
# d3q <- costDistance(tr3cq, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(qsites[,5]), as.numeric(qsites[,6])))
# 
# d3q

# SFA coords
# d3s <- costDistance(tr3cs, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(sched$Long), as.numeric(sched$Lat)))
# 
# d3s
```
## Newfoundland - merge with site coords and inventory data
```{r}
d3 <- as.data.frame(cbind(d3, sitecoords$ID))
colnames(d3)[19] <- "ID"
colnames(d3)[1:18] <- as.list(as.character(rivermouths$code))


# q values
# d3q <- as.data.frame(cbind(d3q, sitecoords$ID))
# colnames(d3q)[16] <- "ID"
# colnames(d3q)[1:15] <- as.list(as.character(qsites$Code))

# sfa values
# d3s <- as.data.frame(cbind(d3s, sitecoords$ID))
# colnames(d3s)[75] <- "ID"

```
## Newfoundland - pick the years you want and summarize
```{r}
dist2AQ_sub <- subset(annual, ReportYear >2003 & ReportYear<2016 & is.na(Lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(ID, Lat, Long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d3, dist2AQ_sub, type="left")
#dist2AQ <- join(d3s, dist2AQ_sub, type="left")
#dist2AQ <- join(d3q, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub <- subset(annual, ReportYear >2001 & ReportYear<2013 & is.na(Lat)==FALSE)
dist2AQ_sub_NL <- ddply(.data=dist2AQ_sub, .(ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(ReportYear)))
dist2AQ <- join(d3q, dist2AQ_sub_NL, type="left")
dist2AQ_NL <- subset(dist2AQ, is.na(totalfish)==FALSE)

```
## Newfoundland - Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.character(x))
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.numeric(x))

# q values
# dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.character(x))
# dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BTB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$DLR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GBB
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$GLP
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$LMS
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$LTR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$MAL
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$NEB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$FBN
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$OBB
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$SMB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$SEB
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$TRB
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$TBB
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$TEB

# for sampling 2015 also do
dist2AQ$P19 <- dist2AQ$totalfish/dist2AQ$BDN

# q values
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$BDN
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GRR
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$LPR
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$NPR
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$RKR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LSR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$NBT
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$BSB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$STP
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$SGR
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$WAB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$CMP

# sfa's
dist2AQ[,1:74] <- apply(dist2AQ[,1:74], 2, function(x) as.character(x))
dist2AQ[,1:74] <- apply(dist2AQ[,1:74], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$V1
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$V2
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$V3
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$V4
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$V5
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$V6
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$V7
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$V8
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$V9
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$V10
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$V11
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$V12
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$V13
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$V14
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$V15
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$V16
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$V17
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$V18
dist2AQ$P19 <- dist2AQ$totalfish/dist2AQ$V19
dist2AQ$P20 <- dist2AQ$totalfish/dist2AQ$V20
dist2AQ$P21 <- dist2AQ$totalfish/dist2AQ$V21
dist2AQ$P22 <- dist2AQ$totalfish/dist2AQ$V22
dist2AQ$P23 <- dist2AQ$totalfish/dist2AQ$V23
dist2AQ$P24 <- dist2AQ$totalfish/dist2AQ$V24
dist2AQ$P25 <- dist2AQ$totalfish/dist2AQ$V25
dist2AQ$P26 <- dist2AQ$totalfish/dist2AQ$V26
dist2AQ$P27 <- dist2AQ$totalfish/dist2AQ$V27
dist2AQ$P28 <- dist2AQ$totalfish/dist2AQ$V28
dist2AQ$P29 <- dist2AQ$totalfish/dist2AQ$V29
dist2AQ$P30 <- dist2AQ$totalfish/dist2AQ$V30
dist2AQ$P31 <- dist2AQ$totalfish/dist2AQ$V31
dist2AQ$P32 <- dist2AQ$totalfish/dist2AQ$V32
dist2AQ$P33 <- dist2AQ$totalfish/dist2AQ$V33
dist2AQ$P34 <- dist2AQ$totalfish/dist2AQ$V34
dist2AQ$P35 <- dist2AQ$totalfish/dist2AQ$V35
dist2AQ$P36 <- dist2AQ$totalfish/dist2AQ$V36
dist2AQ$P37 <- dist2AQ$totalfish/dist2AQ$V37
dist2AQ$P38 <- dist2AQ$totalfish/dist2AQ$V38
dist2AQ$P39 <- dist2AQ$totalfish/dist2AQ$V39
dist2AQ$P40 <- dist2AQ$totalfish/dist2AQ$V40
dist2AQ$P41 <- dist2AQ$totalfish/dist2AQ$V41
dist2AQ$P42 <- dist2AQ$totalfish/dist2AQ$V42
dist2AQ$P43 <- dist2AQ$totalfish/dist2AQ$V43
dist2AQ$P44 <- dist2AQ$totalfish/dist2AQ$V44
dist2AQ$P45 <- dist2AQ$totalfish/dist2AQ$V45
dist2AQ$P46 <- dist2AQ$totalfish/dist2AQ$V46
dist2AQ$P47 <- dist2AQ$totalfish/dist2AQ$V47
dist2AQ$P48 <- dist2AQ$totalfish/dist2AQ$V48
dist2AQ$P49 <- dist2AQ$totalfish/dist2AQ$V49
dist2AQ$P50 <- dist2AQ$totalfish/dist2AQ$V50
dist2AQ$P51 <- dist2AQ$totalfish/dist2AQ$V51
dist2AQ$P52 <- dist2AQ$totalfish/dist2AQ$V52
dist2AQ$P53 <- dist2AQ$totalfish/dist2AQ$V53
dist2AQ$P54 <- dist2AQ$totalfish/dist2AQ$V54
dist2AQ$P55 <- dist2AQ$totalfish/dist2AQ$V55
dist2AQ$P56 <- dist2AQ$totalfish/dist2AQ$V56
dist2AQ$P57 <- dist2AQ$totalfish/dist2AQ$V57
dist2AQ$P58 <- dist2AQ$totalfish/dist2AQ$V58
dist2AQ$P59 <- dist2AQ$totalfish/dist2AQ$V59
dist2AQ$P60 <- dist2AQ$totalfish/dist2AQ$V60
dist2AQ$P61 <- dist2AQ$totalfish/dist2AQ$V61
dist2AQ$P62 <- dist2AQ$totalfish/dist2AQ$V62
dist2AQ$P63 <- dist2AQ$totalfish/dist2AQ$V63
dist2AQ$P64 <- dist2AQ$totalfish/dist2AQ$V64
dist2AQ$P65 <- dist2AQ$totalfish/dist2AQ$V65
dist2AQ$P66 <- dist2AQ$totalfish/dist2AQ$V66
dist2AQ$P67 <- dist2AQ$totalfish/dist2AQ$V67
dist2AQ$P68 <- dist2AQ$totalfish/dist2AQ$V68
dist2AQ$P69 <- dist2AQ$totalfish/dist2AQ$V69
dist2AQ$P70 <- dist2AQ$totalfish/dist2AQ$V70
dist2AQ$P71 <- dist2AQ$totalfish/dist2AQ$V71
dist2AQ$P72 <- dist2AQ$totalfish/dist2AQ$V72
dist2AQ$P73 <- dist2AQ$totalfish/dist2AQ$V73
dist2AQ$P74 <- dist2AQ$totalfish/dist2AQ$V74

# sum all pressures for total propagule pressure at a river
prop.press_all <- apply(as.matrix(dist2AQ[,23:40]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_all <- data.frame(code=rivermouths$code, lat=rivermouths[,3], long = rivermouths[,2], prop.press = prop.press_all)

prop.press_201415 <- data.frame(code=sampling2015$code, lat=sampling2015[,3], long = sampling2015[,2], prop.press = prop.press_all)

write.csv(prop.press_all, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_all years_2016-12-01.csv")
write.csv(prop.press_201415, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_20142015_2016-12-15.csv")

# sum all pressures for total propagule pressure at Q value river
# prop.press_q <- apply(as.matrix(dist2AQ[,20:34]), 2, function(x) sum(x, na.rm=TRUE))
# 
# # match to river mouth coords
# prop.press_q <- data.frame(Code=qsites$Code, lat=qsites[,6], long = qsites[,5], prop.press = prop.press_q)
# 
# write.csv(prop.press_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_qvalues_2005-2012_2016-12-06.csv")



# sum all pressures for total propagule pressure at SFA value river
# prop.press_sfa <- apply(as.matrix(dist2AQ[,79:152]), 2, function(x) sum(x, na.rm=TRUE))
# 
# # match to river mouth coords
# prop.press_sfa <- data.frame(Code=sched$Number, lat=sched$Lat, long = sched$Long, prop.press = prop.press_sfa)
# 
# write.csv(prop.press_sfa, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_sfa rivers_2005-2015_2017-01-16.csv")

```
## Newfoundland - plot propagule pressure
```{r}
dist2AQ_sub_plot <- subset(dist2AQ_sub, totalfish > 0)
dist2AQ_sub_plot$Lat <- as.numeric(dist2AQ_sub_plot$Lat)
dist2AQ_sub_plot$Long <- as.numeric(dist2AQ_sub_plot$Long)

prov <- fortify(NL.low.ocean)
#prov <- fortify(NL.south)

prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

dist2AQ_sub_plot <- arrange(dist2AQ_sub_plot, -totalfish)
prop.press_sfa <- arrange(prop.press_sfa, -prop.press)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=dist2AQ_sub_plot, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(1,5250000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000, 5250000))

plot2 <- ggplot() + 
  ggtitle("SFA 10 and 11: Propagule pressure (2005-2015)")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.press_all, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  #scale_size_continuous(name="Propagule pressure=\n\u03A3(total fish^-0.0012*dist)", range = c(0.5,8), limits=c(5,25), breaks=c(5,10,15,20,25))
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,17500), breaks=c(500, 1000, 5000, 10000, 15000, 17500))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))
### PNG 1500*600


```
## Newfoundland - Q value analysis
```{r}
qsites <- join(qsites, prop.press_q[,c(1,4)], type="left") 

require(ggrepel)

ggplot() + 
  geom_smooth(data=qsites, aes(prop.press, Q), method="lm", se=TRUE) +
  geom_point(data=qsites, aes(prop.press, Q)) +
  geom_label_repel(data=qsites, aes(prop.press, Q, label=Code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  ggtitle("2005-2012")+
  xlab("Propagule pressure") +
  ylab("Q value") 

summary(lm(data=qsites, Q~prop.press))

prop.press_q<- arrange(prop.press_q, -prop.press)

ggplot() + 
  ggtitle("Q values") +
  geom_spatial(data=NL.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatial with grey
  #geom_path(data=CA.NL, aes(long, lat, group=group),colour="black") + ### black outline
  annotate(geom="rect", xmin=-60, xmax=-56.5, ymin=46.5, ymax= 47.25, fill="grey") + ### hides stupid white spaces
  annotate(geom="rect", xmin=-60, xmax=-56.1, ymin=46.5, ymax= 47.4, fill="grey") +
  annotate(geom="rect", xmin=-60, xmax=-59.42, ymin=46.5, ymax= 50.21, fill="grey")+
  annotate(geom="rect", xmin=-56.1, xmax=-55.9, ymin=46.5, ymax= 46.83, fill="grey") +
  annotate(geom="rect", xmin=-54, xmax=-52.2, ymin=50, ymax= 51.8, fill="grey") +
  coord_map(xlim=c(-59.9, -52.3), ylim=c(46.52, 51.79)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_point(data=prop.press_q, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  geom_label_repel(data=prop.press_q, aes(long, lat, label=Code), size=3, point.padding = unit(0.5,"lines"))

```
### SFA plots
```{r}

### SFA 10-11 plot
ggplot() + geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-59, xmax=-56.0, ymin=46.5, ymax= 47.4, fill="grey") +
  annotate(geom="rect", xmin=-56, xmax=-55, ymin=46.5, ymax= 46.8, fill="grey") +
  coord_map(xlim=c(-58, -53.5), ylim=c(46.6, 48.2)) +
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_point(data=prop.press_sfa, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  scalebar(data=fortify(NL.south), dist=25, dd2km=TRUE, model="WGS84", location="bottomleft", anchor=c(x = -57.75, y = 46.88), st.size=3) +
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,20000))+
  ggtitle("SFAs 10 and 11")


names(prop.press_sfa) <- c("Number", "lat", "long", "prop.press")

sched

prop.press_sfa <- join(prop.press_sfa, sched, type="left")

prop.press_sfa <- select(prop.press_sfa, Prov, SFA, Name, Number, lat, long, prop.press)

prop.press_sfa$Name <- factor(prop.press_sfa$Name, levels=prop.press_sfa$Name[order(prop.press_sfa$Number)], ordered=TRUE)

ggplot() + geom_point(data=prop.press_sfa, aes(prop.press, Name)) + facet_grid(SFA~., scales="free_y", space="free") +
  theme_bw() + 
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  xlab("Propagule pressure (2005-2015)") +
  ylab("River name")
  
  
```
### Assigning DU's
```{r}
sfalist <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Salmon Fishing Areas and Rivers.csv")

# Get shapefile
atlcan <- getData("GADM", country="CAN", level=1)
extent(atlcan)

# crop it
can <- crop(atlcan, extent(-77, -52, 43, 59))
can <- fortify(can)

colnames(sfalist)[c(2,5,6,7,8)] <- c("SFA", "Number", "Long", "Pos", "Lat")
sfalist$Long <- -sfalist$Long

sfalist <- sfalist[sfalist$Long<0,]

sfalist$COSEWIC.DU <- as.character(sfalist$COSEWIC.DU)

ggplot() + #geom_polygon(data=can, aes(long, lat, group=group)) +
  geom_point(data=sfalist[sfalist$SFA%in%c("Q8", "Q9"),], aes(Long, Lat, colour=SFA)) +
  #geom_text_repel(data=sfalist[sfalist$SFA%in%c("Q8","Q9"),], aes(Long, Lat, colour=SFA, label=River.name)) +
  coord_map(xlim=c(-61, -58)), ylim=c(50, 51))

test <- subset(sfalist, Province =="Labrador" | SFA=="Q9" & Long > -61.60047)
test <- subset(sfalist, SFA=="Q9")

ggplot() + geom_point(data=test, aes(Long, Lat, colour=SFA)) +
  #geom_text_repel(data=sfalist, aes(Long, Lat, colour=SFA, label=River.name))+
  coord_map()

min(sfalist$Long[sfalist$SFA=="Q9"])

## DU 7
sfalist$COSEWIC.DU <- ifelse(sfalist$Long > -61.370021 & sfalist$Long < -58.131350 & sfalist$SFA %in% c("Q8", "Q9"), "DU-7", sfalist$COSEWIC.DU)

# DU 8
sfalist$COSEWIC.DU <- ifelse(sfalist$Long > -69.405171 & sfalist$Long < -61.60047 & sfalist$Lat> 48 & sfalist$Lat < 51 & sfalist$SFA %in% c("Q8", "Q7"), "DU-8", sfalist$COSEWIC.DU)

#DU 2
sfalist$COSEWIC.DU <- ifelse(sfalist$Province =="Labrador" | sfalist$Long > -58.131351 & sfalist$SFA %in% c("Q8", "Q7", "Q9"), "DU-2", sfalist$COSEWIC.DU)

ggplot() + geom_point(data=sfalist, aes(Long,Lat, colour=COSEWIC.DU)) + coord_map()

str(sfalist)

```


---------------------------------------------------------------------------------------------------------------------

# NOVA SCOTIA CAGE SITE PROPAGULE PRESSURES ---------------------------------------------------------------------------------------------------------------------

## Nova Scotia - shapefile prep
```{r}
# NS.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NS_Hydro_shp/waterbody_2.shp", layer="waterbody_2")
NS.low <- crop(NS.low, extent(-67, -59.5, 43.3, 47.5))
#plot(NS.low)

# creating raster
r <- raster(ncol=1110, nrow=930)
extent(r) <- extent(NS.low)
NSrast <- rasterize(NS.low, r, fun="first")

# Also get rid of ocean blob
NSrast@data@values <- ifelse(is.na(NSrast@data@values)=="TRUE", 100000, 1)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -64.5 & coordinates(NSrast)[,2] < 44, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -61 & coordinates(NSrast)[,2] < 45, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,2] >47.2, 1, NSrast@data@values)

# Canso causeway is impassable
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -61.42577 & coordinates(NSrast)[,1] < -61.414002 & coordinates(NSrast)[,2] > 45.641238 & coordinates(NSrast)[,2] < 45.647156, 100000, NSrast@data@values)

# create transition layer for raster (likelihood of presence within cell). 
tr5 <- transition(1/NSrast, transitionFunction=mean, directions=8)
tr5c <- geoCorrection(tr5, type="c")

```
## Nova Scotia - AQ site coordinates and rivermouths
```{r}
# read in sites from I&T file. Adjust years as desired. Min for NS is 1999, max is 2015. 
NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS I&T/NS IT sites_FK_EP_FK.csv", header=TRUE)
sitecoords <- unique(subset(NSsitecoords, is.na(Lat)=="FALSE", select=c("Site.ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)
test <- click()
siterast[13,] <- c(-65.74858, 44.65102)
siterast[1,] <- c(-64.32808,  44.41282)
siterast[6,] <- c(-60.84400, 45.67315)
siterast[10,] <- c(-60.84400, 45.67315)
siterast[2,] <- c(-60.97440, 45.99829)

plot(NSrast) , xlim=c(-61.25, -60.9), ylim=c(45.9, 46.1))
text(siterast[,1], siterast[,2], col="red")

# # escaped fish location from Escapes_2016-10-07 morris df
morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nsrivers <- as.data.frame(unique(morris$River[morris$Prov=="NS"]))
names(nsrivers) <- c("river")
#nsrivers
coords_clean <- rbind(c(-65.59265, 44.69787), # Annap
c(-60.86494, 46.06677),# Baddeck
c(-65.69013, 44.61802), #Bear
c(-60.79996, 45.86143), #BRas
c(-64.22795, 45.12565), #Gasp
c(-60.61312, 45.59906), #Grand
c(-64.09798, 45.39943), #Harr
c(-60.57251, 46.26069), #Indian
c(-64.34167, 44.28720), #Lahave
c(-61.99407, 45.00587), #Liscomb
c(-61.11676, 46.44321), #Marg
c(-64.65848, 44.03053), # Mersey
c(-66.16127, 44.23016), #Meteghan
c(-60.88931, 46.05536), #MIddle
c(-65.60077, 44.69787), #Nict
c(-60.58063, 46.23217), #North
c(-64.30106, 45.37091), # Parrs
c(-63.54560, 44.62372), #Sack
c(-66.18564, 44.05905), #Salmon
c(-60.93805, 46.01543), #skye
c(-63.48874, 45.33098), #Stew
c(-60.50752, 46.36336), #St. Ann
c(-61.86410, 45.02298), #St. mary
c(-65.95007, 43.76246), #Tusket
c(-60.93805, 46.01543)) #Why 

nsrivers <- cbind(nsrivers, coords_clean)
nsrivers$river <- as.character(nsrivers$river)

names(nsrivers) <- c("River", "long", "lat")

nsrivers$code <- as.character(c("APR", "BAD", "BRR", "BRA", "GAK", "GRA", "HAR", "IND", "LAH", "LIS", "MGR", "MER", "MET", "MID", "NIC", "NRV", "PAR", "SAC", "SAD", "SKY", "STW", "STA", "SMA", "TUS", "WHY"))

# nsmorris <- subset(morris, ProvState=="NS")
# nsmorris <- join(nsmorris, nsrivers, type="left")
# 
# unique(nsmorris$TotalFarmed)
# 
# nsmorris_true <- subset(nsmorris, !TotalFarmed =="0", select=c("River", "lat", "long", "TotalFarmed"))
# nsmorris_true <- subset(nsmorris_true, !TotalFarmed =="N/A")
# nsmorris_true <- unique(nsmorris_true[,1:3])


# Q value rivers NS

# for q-values
NSQ <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NS Q values.csv", header=TRUE) 
head(NSQ)

names(NSQ) <- c("Code", "Q", "Distance")

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

NSQ <- join(NSQ, qsitecoords, type="left")
NSQ <- NSQ[!is.na(NSQ$Lat)==TRUE,]
NSQ <- subset(NSQ, !Region %in% c("Southern Quebec", "Gaspesie", "Anticosti", "North Shore upper", "North Shore Lower"))
NSQ <- subset(NSQ, !Site %in% c("Cap Chat", "Cross", "Big Salmon", "Jacquet", "Miramichi", "Nashwaak", "Tobique"))

NSQ[1, 5:6] <- c(-61.91332, 45.64064)
NSQ[2, 5:6] <- c(-60.59093, 45.93392)
NSQ[3, 5:6] <- c(-64.27549, 45.12792)
NSQ[4, 5:6] <- c(-64.34658, 44.27382)
NSQ[5, 5:6] <- c(-64.57827, 44.13918)
NSQ[6, 5:6] <- c(-61.12861, 46.44463)
NSQ[7, 5:6] <- c(-63.38684, 45.35512)
NSQ[8, 5:6] <- c( -60.58367, 46.25754)
NSQ[9, 5:6] <- c(-61.92785, 45.02375)
NSQ[10, 5:6] <- c(-63.48755, 45.32147)

```
### Nova Scotia - Fix some river coords
```{r}
# make nictaux = to annapolis
# nsrivers[15,3] <- nsrivers[1,3]
# nsrivers[15,2] <- nsrivers[1,2]
# 
# # for all years:
# # plot(NSrast, xlim=c(-61, -60), ylim=c(46, 47))
# # text(nsrivers[16,3], nsrivers[16,2], col="red")
# nsrivers[16,2:3] <- c(46.26345, -60.59543)
# plot(NSrast, xlim=c(-62.5, -62), ylim=c(44.75, 45.25))
# # text(nsrivers[,3], nsrivers[,2], col="red")
# nsrivers[10,2:3] <- c(45.024369, -61.989859)
```
## Nova Scotia - Transition layer, Geocorrection, calculate distance matrix
```{r}

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d5 <- costDistance(tr5c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(nsrivers[,2]), as.numeric(nsrivers[,3])))

d5

# for Q value analysis
# d5q <- costDistance(tr5c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(NSQ[,5]), as.numeric(NSQ[,6])))

# d5q

```
## Nova Scotia - Merge with site coords and inventory data
```{r}
colnames(sitecoords)[1] <- "Site.ID"
d5 <- as.data.frame(cbind(d5, sitecoords$Site.ID))
colnames(d5)[26] <- "Site.ID"
colnames(d5)[1:25] <- as.list(as.character(nsrivers$code))

dist2AQ_NS <- join(d5, sitecoords, type="left")


# Add distance to upstream rivers (NS -  Nictaux is 65 km upstream from assigned "rivermouth" location)

dist2AQ_NS$NIC <- dist2AQ_NS$NIC + 65000
# NIC was not a q-value river

# for q values

colnames(sitecoords)[1] <- "Site.ID"
d5q <- as.data.frame(cbind(d5q, sitecoords$Site.ID))
colnames(d5q)[11] <- "Site.ID"
colnames(d5q)[1:10] <- as.list(as.character(NSQ$Code))

dist2AQ_NS <- join(d5q, sitecoords, type="left")

```
## Nova Scotia - pick the years you want and summarize
```{r}
NSinv <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS Inventory.csv")
names(NSinv)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")

dist2AQ_sub_NS <- subset(NSinv, Year >1998 & Year<2016 & is.na(Lat)==FALSE)
dist2AQ_sub_NS <- ddply(.data=dist2AQ_sub_NS, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d5, dist2AQ_sub_NS, type="left")
# q value
dist2AQ <- join(d5q, dist2AQ_sub_NS, type="left")

dist2AQ_NS <- subset(dist2AQ, is.na(totalfish)==FALSE)



# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub_NS <- subset(NSinv, Year >2001 & Year<2013 & is.na(Lat)==FALSE)
dist2AQ_sub_NS <- ddply(.data=dist2AQ_sub_NS, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))
dist2AQ <- join(d5, dist2AQ_sub_NS, type="left")
dist2AQ_NS <- subset(dist2AQ, is.na(totalfish)==FALSE)
```
## Nova Scotia - Calculate propagule pressure for each river. 
```{r}
dist2AQ_NS[,1:25] <- apply(dist2AQ_NS[,1:25], 2, function(x) as.character(x))
dist2AQ_NS[,1:25] <- apply(dist2AQ_NS[,1:25], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ_NS$P1 <- dist2AQ_NS$totalfish/dist2AQ_NS$APR
dist2AQ_NS$P2 <- dist2AQ_NS$totalfish/dist2AQ_NS$BAD
dist2AQ_NS$P3 <- dist2AQ_NS$totalfish/dist2AQ_NS$BRR
dist2AQ_NS$P4 <- dist2AQ_NS$totalfish/dist2AQ_NS$BRA
dist2AQ_NS$P5 <- dist2AQ_NS$totalfish/dist2AQ_NS$GAK
dist2AQ_NS$P6 <- dist2AQ_NS$totalfish/dist2AQ_NS$GRA
dist2AQ_NS$P7 <- dist2AQ_NS$totalfish/dist2AQ_NS$HAR
dist2AQ_NS$P8 <- dist2AQ_NS$totalfish/dist2AQ_NS$IND
dist2AQ_NS$P9 <- dist2AQ_NS$totalfish/dist2AQ_NS$LAH
dist2AQ_NS$P10 <- dist2AQ_NS$totalfish/dist2AQ_NS$LIS
dist2AQ_NS$P11 <- dist2AQ_NS$totalfish/dist2AQ_NS$MGR
dist2AQ_NS$P12 <- dist2AQ_NS$totalfish/dist2AQ_NS$MER
dist2AQ_NS$P13 <- dist2AQ_NS$totalfish/dist2AQ_NS$MET
dist2AQ_NS$P14 <- dist2AQ_NS$totalfish/dist2AQ_NS$MID
dist2AQ_NS$P15 <- dist2AQ_NS$totalfish/dist2AQ_NS$NIC
dist2AQ_NS$P16 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRV
dist2AQ_NS$P17 <- dist2AQ_NS$totalfish/dist2AQ_NS$PAR
dist2AQ_NS$P18 <- dist2AQ_NS$totalfish/dist2AQ_NS$SAC
dist2AQ_NS$P19 <- dist2AQ_NS$totalfish/dist2AQ_NS$SAD
dist2AQ_NS$P20 <- dist2AQ_NS$totalfish/dist2AQ_NS$SKY
dist2AQ_NS$P21 <- dist2AQ_NS$totalfish/dist2AQ_NS$STW
dist2AQ_NS$P22 <- dist2AQ_NS$totalfish/dist2AQ_NS$STA
dist2AQ_NS$P23 <- dist2AQ_NS$totalfish/dist2AQ_NS$SMA
dist2AQ_NS$P24 <- dist2AQ_NS$totalfish/dist2AQ_NS$TUS
dist2AQ_NS$P25 <- dist2AQ_NS$totalfish/dist2AQ_NS$WHY

# q values
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.character(x))
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.numeric(x))

dist2AQ_NS$P1 <- dist2AQ_NS$totalfish/dist2AQ_NS$ANW
dist2AQ_NS$P2 <- dist2AQ_NS$totalfish/dist2AQ_NS$ESK
dist2AQ_NS$P3 <- dist2AQ_NS$totalfish/dist2AQ_NS$GAK
dist2AQ_NS$P4 <- dist2AQ_NS$totalfish/dist2AQ_NS$LAH
dist2AQ_NS$P5 <- dist2AQ_NS$totalfish/dist2AQ_NS$MED
dist2AQ_NS$P6 <- dist2AQ_NS$totalfish/dist2AQ_NS$MGR
dist2AQ_NS$P7 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRH
dist2AQ_NS$P8 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRV
dist2AQ_NS$P9 <- dist2AQ_NS$totalfish/dist2AQ_NS$SMA
dist2AQ_NS$P10 <- dist2AQ_NS$totalfish/dist2AQ_NS$STW


# sum all pressures for total propagule pressure at a river
prop.press_NS <- apply(as.matrix(dist2AQ_NS[,30:54]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NS <- data.frame(code=nsrivers[,4], lat=nsrivers[,3], long = nsrivers[,2], prop.press = prop.press_NS)

write.csv(prop.press_NS, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure NS_all years_2017-01-06.csv")


# q values
# sum all pressures for total propagule pressure at a river
prop.press_NS_q <- apply(as.matrix(dist2AQ_NS[,15:24]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NS_q <- data.frame(code=NSQ$Code, lat=NSQ$Lat, long = NSQ$Long, prop.press = prop.press_NS_q, q=NSQ$Q)

write.csv(prop.press_NS_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure NS_Q values_2016-12-07.csv")
```
## Nova Scotia - plot propagule pressure
```{r}
dist2AQ_NS_plot <- arrange(subset(dist2AQ_NS, select=c(Site.ID, Lat, Long, totalfish)), -totalfish)
prop.press_NS <- arrange(prop.press_NS, -prop.press)

plot3 <- ggplot() + 
  ggtitle("Aquaculture sites") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.7, -59.5), ylim=c(43.2, 48)) + ### sets boundaries
  geom_point(data=dist2AQ_NS_plot, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(0,4250000), breaks=c(1,10000, 50000,75000,1000000, 2000000, 4250000))

plot4 <- ggplot() + 
  ggtitle("Propagule pressure (1999-2015)") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.6, -59.5), ylim=c(43.2, 48)) + ### sets boundaries +
  geom_point(data=prop.press_NS, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="\u03A3(years stocked/dist)")

gA <- ggplotGrob(plot3)
gB <- ggplotGrob(plot4)
grid.newpage()
grid.draw(cbind(gA, gB))



## q values

ggplot() + 
  geom_smooth(data=prop.press_NS_q, aes(prop.press, q), method="lm", se=TRUE) +
  geom_point(data=prop.press_NS_q, aes(prop.press, q)) +
  geom_label_repel(data=prop.press_NS_q, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  xlab("Propagule pressure") +
  ylab("Q value") 

ggplot() + geom_text(data=prop.press_NS, aes(long, lat, label=code))

```


---------------------------------------------------------------------------------------------------------------------
# NEW BRUNSWICK CAGE SITE DISTANCES TEMPLATE CODE ---------------------------------------------------------------------------------------------------------------------

## New Brunswick - read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
# NB.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NB_Hydro_shp/waterbody_2.shp", layer="waterbody_2")
# GOM <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/PhysioRegions_WGS84.shp", layer="PhysioRegions_WGS84")
# GOMclip <- gDifference(GOM, NB.low)
# GOMclip <- SpatialPolygonsDataFrame(GOMclip, data=as.data.frame(x=1))

# NB.BOF <- crop(GOM, extent(-67.3, -64.5, 44.5, 47.08))
# NB.BOF2 <- crop(NB.low, extent(-67.3, -64.5, 44.5, 47.1)) ### This makes stripes through grand manan??

NB <- getData("GADM", country="CAN", level=2)
NB.BOF <- crop(NB, extent(-67.3, -64.5, 44.5, 46))
#NB.prov <-crop(NB, extent(-67.85, -63.7, 44.5, 48.1))
plot(NB.BOF)
# creating raster
r <- raster(ncol=1100, nrow=850)
extent(r) <- extent(NB.BOF)
NBrast <- rasterize(NB.BOF, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive).
NBrast@data@values <- ifelse(is.na(NBrast@data@values)=="FALSE", 10000, 1)

plot(NBrast)
# if shoreline needed:
# NBline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NB_Land_shp/shoreline_1.shp", "shoreline_1")

# create transition layer for raster (likelihood of presence within cell). 
tr4 <- transition(1/NBrast, transitionFunction=mean, directions=8)
tr4c <- geoCorrection(tr4, type="c")

plot(raster(tr4c))


# for q values
# creating raster
r <- raster(ncol=972, nrow=1188) # 1 grid cell = 3km2
extent(r) <- extent(NB.prov)
NBprovrast <- rasterize(NB.prov, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive).
NBprovrast@data@values <- ifelse(is.na(NBprovrast@data@values)=="FALSE", 10000, 1)

# create transition layer for raster (likelihood of presence within cell). 
tr4q <- transition(1/NBprovrast, transitionFunction=mean, directions=8)
tr4cq <- geoCorrection(tr4q, type="c")

plot(raster(tr4cq))

```
## New Brunswick - AQ site coordinates and river mouths
```{r}
# site coords

# read in sites from annual NB stocking. Adjust years as desired. Min for NB is 1998, max is 2016. 
NB_stocking <- read.csv("C:/Users/keyserf/Documents/Data/R output/NB_stocking.csv")
sitecoords <- unique(subset(NB_stocking, is.na(lat)=="FALSE", select=c("Site.ID","lat", "long")))
x <- sitecoords$long
y <- sitecoords$lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

## New Brunswick river mouths
morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nbrivers <- as.data.frame(unique(morris$River[morris$ProvState=="NB"]))
names(nbrivers) <- c("river")
coords_clean <- rbind(c(45.545066, -66.011293), 
               c(45.422197, -65.402976),
               c(45.262844, -65.781699),
               c(45.179130, -66.987045),
               c(45.131204, -67.068731),
               c(45.199799, -67.261215),
               c(45.118038, -66.876022),
               c(47.074048, -65.399438),
               c(45.570888, -65.774480),
               c(45.957255, -66.618207),
               c(45.502517, -66.072903),
               c(45.167935, -67.194878),
               c(45.610963, -64.957627),
               c(45.206954, -67.147044))
nbrivers <- cbind(nbrivers, coords_clean)

names(nbrivers) <- c("River", "lat", "long")

plot(NBrast)
plot(NB.low, add=TRUE)
points(nbrivers[,3], nbrivers[,2], col="red")
nbrivers[,2:3] <- rbind(c(45.25795, -66.04133),# BIB
                    c(45.40349, -65.40872), # BSR
                    c(45.25354, -65.79461), # BKR
                    c(45.14328, -66.97758), # BOC
                    c(45.11682, -67.02819), # CHS
                    c(45.18298, -67.27490), # DNS
                    c(45.12123, -66.91432), # MDR
                    c(NA, NA),              # MIR
                    c(45.12123, -66.91432), # MTB
                    c(45.24913, -66.04765), # NSH
                    c(45.24913, -66.04765), # SJR
                    c(45.16092, -67.19266), # SCR
                    c(45.58872, -64.93427), # USR
                    c(45.17416, -67.15471)) # WAR

nbrivers2 <- subset(nbrivers, is.na(lat)=="FALSE")
nbrivers2$code <- c("BIB", "BSR", "BKR", "BOC", "CHS", "DNS", "MDR", "MTB", "NSH", "SJR", "SCR", "USR", "WAR")


# for q-values

NBQ <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NS Q values.csv", header=TRUE) 
head(NBQ)

names(NBQ) <- c("Code", "Q", "Distance")

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

NBQ <- join(NBQ, qsitecoords, type="left")
NBQ <- NBQ[!is.na(NBQ$Lat)==TRUE,]
NBQ <- subset(NBQ, Site %in% c("Big Salmon", "Jacquet", "Miramichi", "Nashwaak", "Tobique"))

NBQ[1, 5:6] <- c(-65.40428, 45.41445)
# NBQ[2, 5:6] <- c(-66.02681, 47.93944)
# NBQ[3, 5:6] <- c(-65.34352, 47.08349)
NBQ[4, 5:6] <- c(-66.03602, 45.24463)
NBQ[5, 5:6] <- c(-66.03602, 45.24463)

# plot(NB.prov, xlim=c(-66, -67), ylim=c(47.5, 48.5))
# plot(NB.low, add=TRUE)
# text(NBQ[,5], NBQ[,6], col="red")
# click()

# remove Gulf sites because no NB aquaculture on that side, and unreliable to combine NS and NB inventory data. 
NBQ <- NBQ[c(1,4:5),]

```
## New Brunswick - calculate distance matrix
```{r}
# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d4 <- costDistance(tr4c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(nbrivers2[,3]), as.numeric(nbrivers2[,2])))

d4 

# for Q value analysis
# d4q <- costDistance(tr4cq, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(NBQ[,5]), as.numeric(NBQ[,6])))

# d4q
```
## New Brunswick - merge with site coords and inventory data
```{r}
d4 <- as.data.frame(cbind(d4, sitecoords$Site.ID))
colnames(d4)[14] <- "Site.ID"
colnames(d4)[1:13] <- as.list(as.character(nbrivers2$code))

# for q values

d4q <- as.data.frame(cbind(d4q, sitecoords$Site.ID))
colnames(d4q)[4] <- "Site.ID"
colnames(d4q)[1:3] <- as.list(as.character(NBQ$Code))

```
## New Brunswick - pick the years you want and summarize
```{r}
dist2AQ_sub <- subset(NB_stocking, Year >1998 & Year<2016 & is.na(lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, lat, long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d4, dist2AQ_sub, type="left")
# for qvalues
dist2AQ <- join(d4q, dist2AQ_sub, type="left")

dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)



# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub <- subset(NB_stocking, Year >2001 & Year<2013 & is.na(lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, lat, long),
                     summarize,
                     totalfish=length(unique(Year)))
dist2AQ <- join(d4q, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

# Add extra distance for TOB and NSH since they are upstream. 116km for NSH and 293 km for TOB.
dist2AQ$TOB <- dist2AQ$TOB + 293000
dist2AQ$NSH <- dist2AQ$NSH + 116000
```
## New Brunswick - Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:13] <- apply(dist2AQ[,1:13], 2, function(x) as.character(x))
dist2AQ[,1:13] <- apply(dist2AQ[,1:13], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BIB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$BSR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$BKR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$BOC
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$CHS
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$DNS
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$MDR
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$MTB
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$NSH
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$SJR
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$SCR
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$USR
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$WAR


## for q values
dist2AQ[,1:3] <- apply(dist2AQ[,1:3], 2, function(x) as.character(x))
dist2AQ[,1:3] <- apply(dist2AQ[,1:3], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BSR
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$NSH
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$TOB



# sum all pressures for total propagule pressure at a river
prop.press_NB_all <- apply(as.matrix(dist2AQ[,18:30]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NB_all <- data.frame(code=nbrivers2$code, lat=nbrivers2[,2], long = nbrivers2[,3], prop.press = prop.press_NB_all)

write.csv(prop.press_NB_all, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NB_lin_all years_2016-12-02.csv")


# for qvalues
# sum all pressures for total propagule pressure at a river
prop.press_NB_q <- apply(as.matrix(dist2AQ[,8:10]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NB_q <- data.frame(code=NBQ$Code, lat=NBQ[,6], long = NBQ[,5], prop.press = prop.press_NB_q, q=NBQ$Q)

write.csv(prop.press_NB_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NB_q values_2016-12-07.csv")

```
## New Brunswick - plot propagule pressure
```{r}
dist2AQ_sub_plot <- subset(dist2AQ_sub, totalfish > 0)
dist2AQ_sub_plot$lat <- as.numeric(dist2AQ_sub_plot$lat)
dist2AQ_sub_plot$long <- as.numeric(dist2AQ_sub_plot$long)

dist2AQ_sub_plot <- arrange(dist2AQ_sub_plot, -totalfish)
prop.press_NB_all <- arrange(prop.press_NB_all, -prop.press)

### get shapefiles in <Maritimes and NL maps.R>


plot1 <- ggplot() + 
  ggtitle("Aquaculture sites") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.3, -64.3), ylim=c(44.5, 46)) + ### sets boundaries
  theme_bw() + ### my favourite theme settings here and below (makes land white)
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  geom_point(data=dist2AQ_sub_plot, aes(long, lat, size=totalfish), fill="red", shape=21, colour="black") +    scale_size_continuous(name="Total fish", range = c(0.5,8), limits=c(1,2500000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000))



plot2 <- ggplot() + 
  ggtitle("Propagule pressure (2000-2012)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_NB_all, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() + ### my favourite theme settings here and below (makes land white)
  coord_map(xlim=c(-67.4, -64.3), ylim=c(44.5, 46)) + ### sets boundaries
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,6000), breaks=c(500, 1000, 2000, 4000, 6000))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))
### PNG 1500*600

## q values

ggplot() + 
  geom_smooth(data=prop.press_NB_q, aes(prop.press, q), method="lm", se=TRUE) +
  geom_point(data=prop.press_NB_q, aes(prop.press, q)) +
  geom_label_repel(data=prop.press_NB_q, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  xlab("Propagule pressure") +
  ylab("Q value") 



### TRYING HEATMAP

# ?rasterize
# test <- rasterize(c(dist2AQ_sub_plot$long, dist2AQ_sub_plot$lat), r, fun=sum(dist2AQ_sub_plot$totalfish))
# 
# test <- dist2AQ_sub_plot
# 
# coordinates(test) <- ~long+lat
# 
# proj4string(test) <- CRS("+proj=longlat +ellps=GRS80 +no_defs") # set it to lat-long
# test <- spTransform(test,CRS("+proj=longlat +ellps=GRS80 +no_defs"))
# gridded(test) <- TRUE
# r2 <- raster(test)
# projection(r2) <- CRS("+proj=longlat +ellps=GRS80 +no_defs")
# 
# hpars<-read.table("https://sites.google.com/site/arunsethuraman1/teaching/hpars.dat?revision=1")#Read in the density data
# 
# head(hpars)
# positions <- data.frame(lon=rnorm(20000, mean=-75.1803458, sd=0.05), lat=rnorm(10000,mean=39.98352197, sd=0.05))
# 
# dist2AQ_sub_plot$adj <- dist2AQ_sub_plot$totalfish/1000
# test <- data.frame(lat=rep(dist2AQ_sub_plot$lat, round(dist2AQ_sub_plot$adj,0)), long=rep(dist2AQ_sub_plot$long, round(dist2AQ_sub_plot$adj, 0)))
# 
# 
# can <- readOGR("C:/Users/keyserf/Documents/R/canvec/canada.shp", layer="canada")
# can <- fortify(can)
# 
# usa <- readOGR("C:/Users/keyserf/Documents/R/canvec/usa.shp", layer="usa")
# usa <- fortify(usa)
# 
# ggplot() + 
#   geom_polygon(data=can, aes(long, lat, group=group)) +
#   geom_polygon(data=usa, aes(long, lat, group=group)) +
#   coord_map(xlim=c(-68, -66), ylim=c(44.25, 45.5)) +
#   geom_density2d(data = test, aes(x = long, y = lat), size = 0.3) + 
#   stat_density2d(data = test, aes(x = long, y = lat, fill = ..level.., alpha = ..level..), size = 0.01, 
#     bins = 16, geom = "polygon") + 
#   scale_fill_gradient(low = "green", high = "red") + 
#   scale_alpha(range = c(0, 0.3), guide = FALSE)
# ?geom_density2d
# 
# ggplot() +
#   geom_density2d(data = test, aes(x = long, y = lat), size = 0.3) + 
#   #stat_density2d(data = test, aes(x = long, y = lat, fill = ..level.., alpha = ..level..), size = 0.01, 
#     bins = 16, geom = "polygon") + 
#   scale_fill_gradient(low = "green", high = "red") + 
#   scale_alpha(range = c(0, 0.3), guide = FALSE) +
#   geom_spatial(can) +
#   geom_spatial(usa) +
#   coord_map(xlim=c(-68, -66), ylim=c(44.25, 45.5))


```
## all q values together with distance-only pressure
```{r}
qvals <- rbind(prop.press_NB_q, prop.press_NS_q)

names(qsites)


prop.press_NL_q <- read.csv("C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_qvalues_2005-2012_2016-12-06.csv")

prop.press_NL_q <- data.frame(code=qsites$Code, lat=qsites$Lat, long=qsites$Long, prop.press=qsites$prop.press, q=qsites$Q)

prop.press_NL_q <- join(prop.press_NL_q, qsites, type="left")



qvals$prov <- c(rep("NB", 3), rep("NS", 10), rep("NL", 15))

qvals <- subset(qvals, !code %in% c("TOB", "NSH"))

model_all <- lm(data=qvals, q~prop.press)
summary(model_all)
qvals[,7:9] <- predict(qvals, object=model_all, interval=c("confidence"), level=0.95)

qvals[,10:12] <- predict(qvals, object=model_all, interval=c("confidence"), level=0.97)
qvals$out <- ifelse(qvals$q < qvals$V11 | qvals$q > qvals$V12, "out", "in")

statlabel <- paste0("slope = ", round(coefficients(model_all)[2], 4), "              adj. Rsq. = ", round(summary(model_all)$adj.r.squared, 4), "              p-value = ", round(anova(model_all)[1,5],4))


ggplot() + 
  geom_smooth(data=prop.press_NL_q, aes(prop.press.prop.press, Q), colour="black", method="lm", se=FALSE) +
  geom_point(data=prop.press_NL_q, aes(prop.press.prop.press, Q), colour="black", size=3, alpha=0.5) +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V7)) +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V8), lty="dashed") +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V9), lty="dashed") +
  #geom_label_repel(data=qvals, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  # scale_shape_manual(values=c(21,22,23), labels=c("NL (2005-2012)", "NS (2002-2012)"))+
  # scale_fill_discrete(labels=c("NL (2005-2012)", "NS (2002-2012)"))+
  xlab("Propagule pressure") +
  ylab("Q value") +
  geom_text_repel(data=prop.press_NL_q, aes(prop.press.prop.press, Q, label=Code), size=3)+
  ggtitle("Newfoundland 2005-2012")
  #geom_text(data=NULL, aes(0.0045, 0.27, label=paste0("slope = ", round(coefficients(model_all)[2], 4), "\nadj. Rsq. = ", round(summary(model_all)$adj.r.squared, 4), "\np-value = ", round(anova(model_all)[1,5],4))), size=4, hjust=0, ) +
  #facet_wrap(~prov, scales="free_x") +
  #ggtitle(statlabel) +
  #scale_x_continuous()
  
sfa <- read.csv("C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_sfa rivers_2005-2015_2017-01-16.csv")
hybrids <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Hybrid Proportions Output.csv")
names(hybrids)
colnames(sfa)[9]<-"River"

hybrids <- join(hybrids, sfa, type="left")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pHybNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pHybNC), method="lm", se=FALSE) + 
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pHybNC, label=River), size=3)+
  xlab("Propagule pressure")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pFarmNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pFarmNC), method="lm", se=FALSE) +
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pFarmNC, label=River), size=3)+
  xlab("Propagule pressure")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pWildNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pWildNC), method="lm", se=FALSE) +
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pWildNC, label=River), size=3)+
  xlab("Propagule pressure")



```



------------------------------------------------------------------------------------------
### ALL PROVS COMBINED
```{r}
atlcan <- getData("GADM", country="CAN", level=2)
atlcan <- crop(atlcan, extent(-68, -59, 42, 48))

writeOGR(obj=atlcan, "C:/Users/keyserf/Documents/Data/R output/atlcan.shp", layer = "atlcan", driver="ESRI Shapefile")

plot(atlcan)

maritimes <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Maritimes coordinates.csv")

maritimes <- subset(maritimes, Long<0)

NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS I&T/NS IT sites_FK_EP_FK.csv", header=TRUE)
sitecoords <- unique(subset(NSsitecoords, is.na(Lat)=="FALSE", select=c("Site.ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

siterast[13,] <- c(-65.74858, 44.65102)
siterast[1,] <- c(-64.32808,  44.41282)
siterast[6,] <- c(-60.84400, 45.67315)
siterast[10,] <- c(-60.84400, 45.67315)
siterast[2,] <- c(-60.97440, 45.99829)

sitecoords$prov <- "NS"

NB_stocking <- read.csv("C:/Users/keyserf/Documents/Data/R output/NB_stocking.csv")
sitecoords2 <- unique(subset(NB_stocking, is.na(lat)=="FALSE", select=c("Site.ID","lat", "long")))
x <- sitecoords2$long
y <- sitecoords2$lat
xy2 <- cbind(x, y)
siterast2 <- as.matrix(xy2)

names(sitecoords2) <- c("Site.ID", "Lat", "Long")
sitecoords2$prov <- "NB"

sitecoords_all <- rbind(sitecoords, sitecoords2)


# Get shapefile
atlcan <- getData("GADM", country="CAN", level=3)
extent(atlcan)

# crop it
atlcan <- crop(atlcan, extent(-68, -59, 41.67693, 50))

#build raster file
r <- raster(ncols=700, nrow=526)
extent(r) <- extent(atlcan)
MARrast <- rasterize(atlcan, r, fun="first")

#save it in case of changes
MARrast2 <- MARrast

#change land values to make them impassable
MARrast2@data@values <- ifelse(is.na(MARrast2@data@values)=="FALSE", 1000000, 1)

#canso causeway is impassable
MARrast2@data@values <- ifelse(coordinates(MARrast2)[,1] > -61.45 & coordinates(MARrast2)[,1] < -61.37 & coordinates(MARrast2)[,2] > 45.631 & coordinates(MARrast2)[,2] < 45.656, 1000000, MARrast2@data@values)

#transition layers
trmar <- transition(1/MARrast2, transitionFunction=mean, directions=8)
trmarc <- geoCorrection(trmar, type="c")

#remove the rivers that are on land by making a list of good rivers
bad<-data.frame(extract(x = MARrast2, y = SpatialPoints(coords = cbind(maritimes$Long, maritimes$Lat), proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))))
bad$Name <- maritimes$Name
get_good <- which(bad[,1] == 1)
get_bad <- which(bad[,1] == 1000000)

badrivers <- maritimes$Name[get_bad]
badrivers <- c(badrivers, "Saint Nicholas", "Tabusinac", "Southwest Mabou")

landmaritimes <- maritimes[maritimes$Name %in% badrivers,]
write.csv(landmaritimes, "C:/Users/keyserf/Documents/Data/R output/Maritimes rivers to Dave.csv")
landmaritimes$num <- 1:282
```

# fix bad maritimes river coords
```{r}
NSriv <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NS_Land_shp/shoreline_1.shp", layer="shoreline_1")
NBriv <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NB_Land_shp/shoreline_1.shp", layer="shoreline_1")
PEriv <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/PE shoreline_1/shoreline_1.shp", layer="shoreline_1")

##### CODE TO MOVE RIVERS (saved in click*.csv files)
dev.off()
plot(MARrast2, xlim=c(-63.3, -61.9), ylim=c(45.9, 46.6))
plot(PEriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="red")

click27 <- landmaritimes[landmaritimes$Prov=="Prince Edward Island" & landmaritimes$Long > -63.3 & landmaritimes$Long < -61.9 & landmaritimes$Lat > 45.9 & landmaritimes$Lat < 46.6,]
click27 <- cbind(click27, data.frame(click(n=17)))
write.csv(click27, "C:/Users/keyserf/Documents/Data/R output/click27.csv")

dev.off()
plot(MARrast2, xlim=c(-64.5, -63.3), ylim=c(46.15, 47.1))
plot(PEriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="red")

click26 <- landmaritimes[landmaritimes$Prov=="Prince Edward Island" & landmaritimes$Long > -64.5 & landmaritimes$Long < -63.3 & landmaritimes$Lat > 46.15 & landmaritimes$Lat < 47,]
click26 <- cbind(click26, data.frame(click(n=12)))
write.csv(click26, "C:/Users/keyserf/Documents/Data/R output/click26.csv")

click25 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-67 & landmaritimes$Long < -66.5 & landmaritimes$Lat <48.5 & landmaritimes$Lat > 47.5,]
click25 <- cbind(click25, data.frame(click(n=1)))
write.csv(click25, "C:/Users/keyserf/Documents/Data/R output/click25.csv")

dev.off()
plot(MARrast2, xlim=c(-67, -66.5), ylim=c(47.5, 48.5))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click25 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-67 & landmaritimes$Long < -66.5 & landmaritimes$Lat <48.5 & landmaritimes$Lat > 47.5,]
click25 <- cbind(click25, data.frame(click(n=1)))
write.csv(click25, "C:/Users/keyserf/Documents/Data/R output/click25.csv")

dev.off()
plot(MARrast2, xlim=c(-66.7, -64.4), ylim=c(47.5, 48.2))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click24 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-66.7 & landmaritimes$Long < -64.4 & landmaritimes$Lat <48.2 & landmaritimes$Lat > 47.5,]
click24 <- cbind(click24, data.frame(click(n=20)))
write.csv(click24, "C:/Users/keyserf/Documents/Data/R output/click24.csv")

dev.off()
plot(MARrast2, xlim=c(-66, -64.5), ylim=c(46.7, 47.5))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click22 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-66 & landmaritimes$Long < -65.5 & landmaritimes$Lat <47.5 & landmaritimes$Lat > 46.8,]
click22 <- cbind(click22, data.frame(click(n=6)))
write.csv(click22, "C:/Users/keyserf/Documents/Data/R output/click22.csv")

click23 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-65.5 & landmaritimes$Long < -64.5 & landmaritimes$Lat <47.5 & landmaritimes$Lat > 46.85,]
click23 <- cbind(click23, data.frame(click(n=9)))
write.csv(click23, "C:/Users/keyserf/Documents/Data/R output/click23.csv")

dev.off()
plot(MARrast2, xlim=c(-65.2, -64.5), ylim=c(46, 46.9))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click21 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-65.2 & landmaritimes$Long < -64.5 & landmaritimes$Lat <46.9 & landmaritimes$Lat > 46.1,]
click21 <- cbind(click21, data.frame(click(n=17)))
write.csv(click21, "C:/Users/keyserf/Documents/Data/R output/click21.csv")

dev.off()
plot(MARrast2, xlim=c(-67, -64.5), ylim=c(45.2, 46.2))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click20 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-67 & landmaritimes$Long < -65.5 & landmaritimes$Lat <46.2 & landmaritimes$Lat > 45.4,]
click20 <- cbind(click20, data.frame(click(n=9)))
write.csv(click20, "C:/Users/keyserf/Documents/Data/R output/click20.csv")

dev.off()
plot(MARrast2, xlim=c(-65, -64.1), ylim=c(45.4, 46))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click19 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-65 & landmaritimes$Long < -64.1 & landmaritimes$Lat <46 & landmaritimes$Lat > 45.4,]
click19 <- cbind(click19, data.frame(click(n=8)))
write.csv(click19, "C:/Users/keyserf/Documents/Data/R output/click19.csv")

dev.off()
plot(MARrast2, xlim=c(-66, -65), ylim=c(44.9, 45.5))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click18 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-66 & landmaritimes$Long < -65 & landmaritimes$Lat <45.5 & landmaritimes$Lat > 44.9,]
click18 <- cbind(click18, data.frame(click(n=6)))
write.csv(click18, "C:/Users/keyserf/Documents/Data/R output/click18.csv")


dev.off()
plot(MARrast2, xlim=c(-67, -66), ylim=c(44.9, 45.5))
plot(NBriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click17 <- landmaritimes[landmaritimes$Prov=="New Brunswick" & landmaritimes$Long >-67 & landmaritimes$Long < -66 & landmaritimes$Lat <45.5 & landmaritimes$Lat > 44.9,]
click17 <- cbind(click17, data.frame(click(n=3)))
write.csv(click17, "C:/Users/keyserf/Documents/Data/R output/click17.csv")


dev.off()
plot(MARrast2, xlim=c(-66.5, -65.3), ylim=c(44, 44.9))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click16 <- landmaritimes[landmaritimes$Prov=="Nova Scotia" & landmaritimes$Long >-66.5 & landmaritimes$Long < -65.3 & landmaritimes$Lat <44.9 & landmaritimes$Lat > 44,]
click16 <- cbind(click16, data.frame(click(n=9)))
write.csv(click16, "C:/Users/keyserf/Documents/Data/R output/click16.csv")

dev.off()
plot(MARrast2, xlim=c(-66.5, -65.3), ylim=c(44, 44.9))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click16 <- landmaritimes[landmaritimes$Prov=="Nova Scotia" & landmaritimes$Long >-66.5 & landmaritimes$Long < -65.3 & landmaritimes$Lat <44.9 & landmaritimes$Lat > 44,]
click16 <- cbind(click16, data.frame(click(n=9)))
write.csv(click16, "C:/Users/keyserf/Documents/Data/R output/click16.csv")

dev.off()
plot(MARrast2, xlim=c(-64.6, -63), ylim=c(44.9, 45.5))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click15 <- landmaritimes[landmaritimes$Prov=="Nova Scotia" & landmaritimes$Long >-64.6 & landmaritimes$Long < -63 & landmaritimes$Lat <45.5 & landmaritimes$Lat > 44.9,]
click15 <- cbind(click15, data.frame(click(n=20)))
write.csv(click15, "C:/Users/keyserf/Documents/Data/R output/click15.csv")

dev.off()
plot(MARrast2, xlim=c(-65.4, -64.6), ylim=c(44.6, 45.6))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click14 <- landmaritimes[landmaritimes$Prov=="Nova Scotia" & landmaritimes$Long >-65.4 & landmaritimes$Long < -64.6 & landmaritimes$Lat <45.6 & landmaritimes$Lat > 44.6,]
click14 <- cbind(click14, data.frame(click(n=2)))
write.csv(click14, "C:/Users/keyserf/Documents/Data/R output/click14.csv")

dev.off()
plot(MARrast2, xlim=c(-64.6, -64), ylim=c(45.5, 46.1))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click13 <- landmaritimes[landmaritimes$Long >-64.6 & landmaritimes$Long < -64 & landmaritimes$Lat <46.1 & landmaritimes$Lat > 45.5,]
click13 <- cbind(click13, data.frame(click(n=10)))
write.csv(click13, "C:/Users/keyserf/Documents/Data/R output/click13.csv")

dev.off()
plot(MARrast2, xlim=c(-64, -63), ylim=c(45.5, 46))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click12 <- landmaritimes[landmaritimes$Long >-64 & landmaritimes$Long < -63 & landmaritimes$Lat <46 & landmaritimes$Lat > 45.5,]
click12 <- cbind(click12, data.frame(click(n=6)))
write.csv(click12, "C:/Users/keyserf/Documents/Data/R output/click12.csv")

dev.off()
plot(MARrast2, xlim=c(-63, -62), ylim=c(45, 45.8))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click11 <- landmaritimes[landmaritimes$Long >-63 & landmaritimes$Long < -62 & landmaritimes$Lat <45.8 & landmaritimes$Lat > 45,]
click11 <- cbind(click11, data.frame(click(n=12)))
write.csv(click11, "C:/Users/keyserf/Documents/Data/R output/click11.csv")

dev.off()
plot(MARrast2, xlim=c(-62, -61.2), ylim=c(45.6, 46.4))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click10 <- landmaritimes[landmaritimes$Long >-62 & landmaritimes$Long < -61.2 & landmaritimes$Lat <46.4 & landmaritimes$Lat > 45.6,]
click10 <- cbind(click10, data.frame(click(n=16)))
write.csv(click10, "C:/Users/keyserf/Documents/Data/R output/click10.csv")

dev.off()
plot(MARrast2, xlim=c(-61.25, -60), ylim=c(46.5, 47.2))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click9 <- landmaritimes[landmaritimes$Long >-61.25 & landmaritimes$Long < -60 & landmaritimes$Lat <47.2 & landmaritimes$Lat > 46.5,]
click9 <- cbind(click9, data.frame(click(n=13)))
write.csv(click9, "C:/Users/keyserf/Documents/Data/R output/click9.csv")

dev.off()
plot(MARrast2, xlim=c(-61.25, -59.5), ylim=c(45.9, 46.5))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click8 <- landmaritimes[landmaritimes$Long >-61.25 & landmaritimes$Long < -59.5 & landmaritimes$Lat <46.5 & landmaritimes$Lat > 45.9,]
click8 <- cbind(click8, data.frame(click(n=18)))
write.csv(click8, "C:/Users/keyserf/Documents/Data/R output/click8.csv")

dev.off()
plot(MARrast2, xlim=c(-60.5, -59.5), ylim=c(45.5, 46))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click7 <- landmaritimes[landmaritimes$Long >-60.5 & landmaritimes$Long < -59.5 & landmaritimes$Lat <46.0 & landmaritimes$Lat > 45.5,]
click7 <- cbind(click7, data.frame(click(n=7)))
write.csv(click7, "C:/Users/keyserf/Documents/Data/R output/click7.csv")

dev.off()
plot(MARrast2, xlim=c(-61.5, -60.5), ylim=c(45.5, 45.8))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click6 <- landmaritimes[landmaritimes$Long >-61.5 & landmaritimes$Long < -60.5 & landmaritimes$Lat <45.8 & landmaritimes$Lat > 45.5,]
click6 <- cbind(click6, data.frame(click(n=5)))  
write.csv(click6, "C:/Users/keyserf/Documents/Data/R output/click6.csv")

dev.off()
plot(MARrast2, xlim=c(-62, -60.7), ylim=c(44.9, 45.6))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click5 <- landmaritimes[landmaritimes$Long >-62 & landmaritimes$Long < -60.7 & landmaritimes$Lat <45.6,]
click5 <- cbind(click5, data.frame(click(n=10)))
write.csv(click5, "C:/Users/keyserf/Documents/Data/R output/click5.csv")

dev.off()
plot(MARrast2, xlim=c(-64.5, -63.5), ylim=c(44.3, 44.8))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click3 <- landmaritimes[landmaritimes$Long >-64.5 & landmaritimes$Long < -63.5 & landmaritimes$Lat <44.8 & landmaritimes$Lat>44.3,]
click3 <- cbind(click3, data.frame(click(n=17)))
write.csv(click3, "C:/Users/keyserf/Documents/Data/R output/click3.csv")

dev.off()
plot(MARrast2, xlim=c(-63.5, -62.5), ylim=c(44.4, 45))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click3a <- landmaritimes[landmaritimes$Long >-63.5 & landmaritimes$Long < -62.5 & landmaritimes$Lat >44.4 & landmaritimes$Lat<45,]
click3a <- cbind(click3a, data.frame(click(n=13)))
write.csv(click3a, "C:/Users/keyserf/Documents/Data/R output/click3a.csv")

dev.off()
plot(MARrast2, xlim=c(-62.5, -61.5), ylim=c(44.9, 45.2))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click4 <- landmaritimes[landmaritimes$Long >-62.5 & landmaritimes$Long < -61.5 & landmaritimes$Lat <45.2,]
click4 <- cbind(click4, data.frame(click(n=6)))
write.csv(click4, "C:/Users/keyserf/Documents/Data/R output/click4.csv")

dev.off()
plot(MARrast2, xlim=c(-65, -63.5), ylim=c(43.8, 44.3))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click2 <- landmaritimes[landmaritimes$Long >-65 & landmaritimes$Long < -63.5 & landmaritimes$Lat <44.3,]
click2 <- cbind(click2, data.frame(click(n=4)))
write.csv(click2, "C:/Users/keyserf/Documents/Data/R output/click2.csv")

dev.off()
plot(MARrast2, xlim=c(-66.5, -65), ylim=c(43, 44))
plot(NSriv, add=TRUE)
text(landmaritimes$Long, landmaritimes$Lat, labels=landmaritimes$num, col="yellow")

click1 <- landmaritimes[landmaritimes$Long >-66.5 & landmaritimes$Long < -65 & landmaritimes$Lat <44,]
click1 <- cbind(click1, data.frame(click(n=7)))
write.csv(click1, "C:/Users/keyserf/Documents/Data/R output/click1.csv")

clickNS <- rbind(click1, click2, click3, click3a, click4, click5, click6, click7, click8, click9, click10, click11,click12, click13, click14, click15, click16)
write.csv(clickNS, "C:/Users/keyserf/Documents/Data/R output/clickNS.csv")

clickNB <- rbind(click17, click18, click19, click20, click21, click22, click23, click24, click25)
write.csv(clickNB, "C:/Users/keyserf/Documents/Data/R output/clickNB.csv")

clickPE <- rbind(click26, click27)
write.csv(clickPE, "C:/Users/keyserf/Documents/Data/R output/clickPE.csv")

clickMAR <- rbind(clickNS, clickNB, clickPE)
length(unique(clickMAR$num))

clickMARunique <- join(landmaritimes, clickMAR, type="left")
View(clickMARunique)
table(clickMARunique$num)

clickmissing <- subset(clickMARunique, is.na(x))
clickmissing

dev.off()
plot(MARrast2, xlim=c(-66, -64), ylim=c(45, 46.5))
plot(NBriv, add=TRUE)
text(clickmissing$Long, clickmissing$Lat, labels=clickmissing$num, col="yellow")

missing <- data.frame(click(n=9))
clickmissing[,8:9] <- missing

clickdouble <- subset(clickMARunique, num %in% c(107, 111, 115, 116, 140, 142, 215, 268, 255, 279))

dev.off()
plot(MARrast2), xlim=c(-66, -64), ylim=c(45, 46.5))
plot(NBriv, add=TRUE)
text(clickdouble$x, clickdouble$y, labels=clickdouble$num, col="yellow")

clicksingle <- ddply(.data=clickdouble, .(X, Prov, SFA, Name, Long, Lat, num),
                     summarize,
                     x=max(x),
                     y=max(y))

clickMARgood <- subset(clickMARunique, !num %in% c(107, 111, 115, 116, 140, 142, 215, 268, 255, 279) & !is.na(x))

clickMARfinal <- rbind(clickMARgood, clicksingle, clickmissing)
View(clickMARfinal)
write.csv(clickMARfinal, "C:/Users/keyserf/Documents/Data/R output/clickMARfinal.csv")

fixedmaritimes <- clickMARfinal[,c(1:4,7:9)]
colnames(fixedmaritimes)[7] <- "Lat"
colnames(fixedmaritimes)[6] <- "Long"

maritimesFINAL <- rbind(maritimes[get_good,], fixedmaritimes[,c(1:4,6:7)])
maritimesFINAL <- subset(maritimesFINAL, !(Name=="Saint Nicholas" & Long>-64.919))

dev.off()
plot(MARrast2, xlim=c(-65, -64.5), ylim=c(46, 47))
points(maritimesFINAL[maritimesFINAL$Name=="Saint Nicholas",]$Long, maritimesFINAL[maritimesFINAL$Name=="Saint Nicholas",]$Lat)

maritimesFINAL[maritimesFINAL$Name=="Saint Nicholas",5:6] <- c(-64.85363, 46.66703)

dev.off()
plot(MARrast2, xlim=c(-65.5, -64.5), ylim=c(47, 48))
points(maritimesFINAL[maritimesFINAL$Name=="Tabusintac",]$Long, maritimesFINAL[maritimesFINAL$Name=="Tabusintac",]$Lat)

maritimesFINAL[maritimesFINAL$Name=="Tabusintac",5:6] <- c(-64.95027, 47.3404)

dev.off()
plot(MARrast2, xlim=c(-61.7, -61), ylim=c(45.7, 46.5))
points(maritimesFINAL[maritimesFINAL$Name=="Southwest Mabou ",]$Long, maritimesFINAL[maritimesFINAL$Name=="Southwest Mabou ",]$Lat)

maritimesFINAL[maritimesFINAL$Name=="Southwest Mabou ",5:6] <-c(-61.48397, 46.08413)

```

#calculate least-cost distance
```{r}
dmar2 <- costDistance(trmarc, fromCoords = cbind(as.numeric(sitecoords_all$Long), as.numeric(sitecoords_all$Lat)), 
                      toCoords = cbind(as.numeric(maritimesFINAL$Long), as.numeric(maritimesFINAL$Lat)))

#set colnames in matrix to be the good rivers from maritimes df
colnames(dmar2) <- gsub("\\s", "", maritimesFINAL$Name)


#remove the "pond" columns
dmar3 <- dmar2[,(dmar2[1, ] < 10000000)]
pondcols <- dmar2[,(dmar2[1, ] > 10000000)]
pondcols ## GOOD! NO MORE PONDS. 

#cbind the AQ site IDs
dmar3 <- as.data.frame(cbind(dmar3, sitecoords_all$Site.ID))
colnames(dmar3)[388] <- "Site.ID"

#get the true water sites by stealing the column names.
# maritimes3 <- as.character(colnames(dmar3)[1:103])
# maritimes$Name <- as.character(maritimes$Name)
# maritimes2 <- subset(maritimes, Name %in% maritimes3)
# arrange(maritimes2, Name)$Name

dist2AQ_NB <- subset(NB_stocking, Year >1999 & Year<2013 & is.na(lat)==FALSE)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")
dist2AQ_NS <- subset(NSinv, Year >1999 & Year<2013 & is.na(Lat)==FALSE)

names(dist2AQ_NB) <- c("X", "Site.ID", "Year", "totalfish", "Long", "Lat", "Area")
names(dist2AQ_NS)

dist2AQ_NB <- dist2AQ_NB[,c(1,2,3,4,6,5)]

dist2AQ_sub <- rbind(dist2AQ_NB, dist2AQ_NS)
dist2AQ_sub <- dist2AQ_sub[,2:6]
#dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))

dist2AQ <- join(dmar3, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)


dist2AQ[,1:387] <- apply(dist2AQ[,1:387], 2, function(x) as.character(x))
dist2AQ[,1:387] <- apply(dist2AQ[,1:387], 2, function(x) as.numeric(x))

dist2AQ[dist2AQ == 0] <- 1000

# for byyear calcs, change totalfish to 1 (1 year)
dist2AQ$totalfish <- 1

# For each AQ site, caclulate total fish/distance from river
## original calculation
test <- c(dist2AQ$totalfish/dist2AQ[,1:387])
dist2AQ <- cbind(dist2AQ, test)

# sum all pressures for total propagule pressure at a river
prop.press_MILLIONRIVERS <- apply(as.matrix(dist2AQ[,108:210]), 2, function(x) sum(x, na.rm=TRUE))
colnames(dist2AQ)[393]
# for each year
prop.press_2000 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2000, 393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2001 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2001,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2002<- apply(as.matrix(dist2AQ[dist2AQ$Year==2002,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2003<- apply(as.matrix(dist2AQ[dist2AQ$Year==2003,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2004<- apply(as.matrix(dist2AQ[dist2AQ$Year==2004,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2005<- apply(as.matrix(dist2AQ[dist2AQ$Year==2005,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2006<- apply(as.matrix(dist2AQ[dist2AQ$Year==2006,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2007<- apply(as.matrix(dist2AQ[dist2AQ$Year==2007,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2008<- apply(as.matrix(dist2AQ[dist2AQ$Year==2008,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2009<- apply(as.matrix(dist2AQ[dist2AQ$Year==2009,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2010<- apply(as.matrix(dist2AQ[dist2AQ$Year==2010,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2011<- apply(as.matrix(dist2AQ[dist2AQ$Year==2011,  393:779]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2012<- apply(as.matrix(dist2AQ[dist2AQ$Year==2012,  393:779]), 2, function(x) sum(x, na.rm=TRUE))


prop.press_byyear <- data.frame(prop.press=c(prop.press_2000, prop.press_2001, prop.press_2002, prop.press_2003, prop.press_2004, prop.press_2005, prop.press_2006, prop.press_2007, prop.press_2008, prop.press_2009, prop.press_2010, prop.press_2011, prop.press_2012), year=rep(2000:2012, each=387), Name=rep(gsub("\\s", "", maritimesFINAL$Name), 13), Lat=rep(maritimesFINAL$Lat, 13), Long=rep(maritimesFINAL$Long, 13))

write.csv(prop.press_byyear, "C:/Users/keyserf/Documents/Data/R output/prop.press_byyear_2017-01-25.csv")

## calculate average river pressure from 2000-2012
prop.press_avg <- ddply(.data=prop.press_byyear, .(Name, Lat, Long),
                        summarize,
                        prop.press=mean(prop.press, na.rm=TRUE),
                        stddev = sd(prop.press, na.rm=TRUE))

maritimesFINAL$Name <- gsub("\\s", "",  maritimesFINAL$Name)

prop.press_byyear <- join(prop.press_byyear, maritimesFINAL, type="left")

prop.press_byyear$SFA <- gsub("\\s", "", prop.press_byyear$SFA)

prop.press_byyear$Name <- factor(prop.press_byyear$Name, levels=unique(prop.press_byyear$Name[order(prop.press_byyear$SFA, prop.press_byyear$Long)], ordered=TRUE))


SFA15_17 <- ggplot() + geom_boxplot(data=prop.press_byyear[prop.press_byyear$SFA %in% c("SFA15", "SFA15&Q1", "SFA16", "SFA17"),], aes(prop.press, Name)) +
  theme_classic() +
  xlim(0, 0.006) +
  facet_grid(SFA~., scales="free_y", space="free")

SFA18_20 <- ggplot() + geom_boxplot(data=prop.press_byyear[prop.press_byyear$SFA %in% c("SFA18", "SFA19", "SFA20"),], aes(prop.press, Name)) +
  theme_classic() +
  xlim(0, 0.006) +
  facet_grid(SFA~., scales="free_y", space="free")

SFA21_23 <- ggplot() + geom_boxplot(data=prop.press_byyear[prop.press_byyear$SFA %in% c("SFA21", "SFA22", "SFA23"),], aes(prop.press, Name)) +
  theme_classic() +
  xlim(0, 0.006) +
  facet_grid(SFA~., scales="free_y", space="free")

grid.arrange(SFA15_17, SFA18_20, SFA21_23, nrow=1)

# match to river mouth coords
prop.press_MILLIONRIVERS <- data.frame(Name = maritimes2$Name, Lat=maritimes2$Lat, Long =maritimes2$Long, prop.press = prop.press_MILLIONRIVERS, sfa=maritimes2$SFA)

write.csv(prop.press_MILLIONRIVERS, "C:/Users/keyserf/Documents/Data/R output/prop.press_maritimes_2017-01-20.csv")

prop.press_MILLIONRIVERS <- arrange(prop.press_MILLIONRIVERS, -prop.press)

ggplot() + 
  ggtitle("Propagule pressure (2000-2012)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_MILLIONRIVERS, aes(Long, Lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  coord_map(xlim=c(-68, -59.5), ylim=c(43.3, 48)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  scale_size_continuous(name="\u03A3(years stocked/dist)", range = c(0.5,8))


View(dist2AQ[1:20,c(103:108,211)])

prop.press_byyear <- arrange(prop.press_byyear, -prop.press)

ggplot() + 
  ggtitle("Propagule pressure (average from 2000-2012)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_avg, aes(Long, Lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  coord_map(xlim=c(-68, -59.5), ylim=c(43.3, 48)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  scale_size_continuous(name="\u03A3(1/dist)", range = c(0.5,8))# +
  #facet_wrap(~year, nrow=2)



levels(prop.press_MILLIONRIVERS$sfa) <- c("SFA 18", "SFA 19", "SFA 20", "SFA 21", "SFA 22", "SFA 23", "SFA 15", "SFA 15", "SFA 16", "SFA 17")

prop.press_MILLIONRIVERS$sfa <- factor(prop.press_MILLIONRIVERS$sfa, c("SFA 15", "SFA 16", "SFA 17", "SFA 18",
                                                                       "SFA 19", "SFA 20", "SFA 21", "SFA 22", "SFA 23"))


prop.press_sfa$Name <- factor(prop.press_sfa$Name, levels=prop.press_sfa$Name[order(prop.press_sfa$Number)], ordered=TRUE)
prop.press_MILLIONRIVERS$Name <- factor(prop.press_MILLIONRIVERS$Name, levels=prop.press_MILLIONRIVERS$Name[order(prop.press_MILLIONRIVERS$Long)], ordered=TRUE)

ggplot() + geom_point(data=prop.press_MILLIONRIVERS, aes(prop.press, Name)) + facet_grid(sfa~., scales="free_y", space="free") +
  theme_bw() + 
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  xlab("Propagule pressure (2000-2012)") +
  ylab("River name")




```

### reports
```{r}
### Magaguadavic from ASF

# mag <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/ASF Escapees_Magaguadavic_HeadTide.csv")
# 
# mag$Date <- dmy(mag$Date.dd.mm.yy)
# mag$Year <- year(mag$Date)
# 
# mag$type <- ifelse(mag$Origin==2, "farm", "other")
# 
# mag_summ <- ddply(.data=mag, .(Year, type),
#                   summarize,
#                   total = length(Fork.Length..cm.))
# 
# mag_summ$River <- "Magaguadavic"
# mag_summ$ProvState <- "NB"
# colnames(mag_summ)[3] <- "TotalFarmed"
# mag_summ$TotalCombined <- mag_summ$TotalFarmed
# mag_summ$CountMethod <- "fence"
# mag_summ$SOURCES <- "ASF"
# mag_summ <- select(mag_summ, -type)
# mag_summ$detected <- 1

### I added mag_summ into csv Feb 24 2017 

# Bradbury 2015
## add bradbury sampling sites (BDN, GAR, LTR, FBN, SMB)

bradprops2015 <- read.csv("C:/Users/keyserf/Documents/Data/R output/bradprops2015.csv")

brad2015 <- ddply(.data=bradprops2015, .(River),
                  summarize,
                  totalfarmed = sum(Esc),
                  totalsamp = sum(total))

brad2015$River <- as.character(brad2015$River)

brad2015[is.na(brad2015)] <- 0

brad2015$propfarmed <- brad2015$totalfarmed / brad2015$totalsamp

brad2015$River[brad2015$River == "Northwest River"] <-  "North West Brook 1"
brad2015$River[brad2015$River == "Simm's Brook"] <-  "Simmons Brook"
brad2015$River[brad2015$River == "Bay du Nord River"] <- "Bay Du Nord"

colnames(brad2015)[2] <- "TotalFarmed"
colnames(brad2015)[3] <- "TotalCombined"

brad2015$ProvState <- "NL"
brad2015$Year.adj <- 2015

brad2015 <- brad2015[,c(1:3,5:6)]

brad2015$detected[brad2015$TotalFarmed==0] <- "0"
brad2015$detected[brad2015$TotalFarmed>0] <- 1

reports <- join(reports, brad2015, type="full")

bradoverview2015 <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/2015 NL salmon sightings.csv")
head(bradoverview2015)

bradoverview2015$detected[bradoverview2015$Reports=="confirmed"] <- 1
bradoverview2015$detected[bradoverview2015$Reports=="suspected"] <- 0.5

bradoverview2015$Location <- as.character(bradoverview2015$Location)

bradoverview2015$Location[bradoverview2015$Location == "Northwest River"] <-  "North West Brook 1"
bradoverview2015$Location[bradoverview2015$Location == "Simms Brook"] <-  "Simmons Brook"
bradoverview2015$Location[bradoverview2015$Location == "Terrenceville Area ?"] <-  "Terrenceville Brook"
bradoverview2015$Location[bradoverview2015$Location == "SouthWest Brook"] <-  "South West Brook 1"
bradoverview2015$Location[bradoverview2015$Location == "Grandy's Brook"] <-  "Grandy Brook"
bradoverview2015$Location[bradoverview2015$Location == "Big Conne (Marine Recapture)"] <-  "Conne River"

bradoverview2015 <- bradoverview2015[,c(1,2,7,8,10)]

names(bradoverview2015) <- c("River", "Year.adj", "Latitude.in", "Longitude.in", "detected")


### Add bradbury 2016

brad2016 <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and Reports/Bradbury sampling 2016.csv")
#dev.off()
#plot(ATLrast2, xlim=c(-56.3, -55), ylim=c(47.4,48.2))
#text(sched$Long, sched$Lat, labels=sched$Number, col="red")
#text(brad2016$Longitude[21:30], brad2016$Latitude__[21:30])


brad2016$Number <- c(47,47,48,48,37,27,25,29,38,29,
                           16, 47, 48, "NA", 16, 47, 48, "NA", 29, 19,
                           19,"NA",19,38, 29, 25, 37,38, 35, "NA", 
                           "NA", 29, 37,37,37,37,35,35,38,38,
                            38,25,27,27,25,25,25,40,40,25,
                           38,37,37,27,27,25,25,25,38,"NA",
                           29,29,"NA", "NA", 31,30,37)

brad2016 <- join(brad2016, sched, type="left")

brad2016[is.na(brad2016$Long)=="TRUE",11:10] <- rbind(c(47.688344, -55.124000),
                                                      c(47.688344, -55.124000),
                                                      c(47.569167, -55.731452),
                                                      c(47.569167, -55.731452),
                                                      c(47.569167, -55.731452),
                                                      c(47.65225, -55.93152),
                                                      c(47.569167, -55.731452),
                                                      c(47.569167, -55.731452))

brad2016$Name <- as.character(brad2016$Name)

brad2016[brad2016$Long==-55.124000,7] <- "Tickle Harbour"
brad2016[brad2016$Long==-55.731452,7] <- "Bill Skinners Cove"
brad2016[brad2016$Long==-55.93152,7] <- "Seal Nest Cove"

str(brad2016)
brad2016$Year.adj <- 2016
colnames(brad2016)[10] <- "long1"
colnames(brad2016)[11] <- "lat1"

brad2016simp <- unique(brad2016[,c(7,12, 10, 11)])

brad2016simp$TotalFarmed <- 0 
colnames(brad2016simp)[1]<-"River"
brad2016simp$River[brad2016simp$River == "Bay du Nord River"] <- "Bay Du Nord"
brad2016simp$detected <- 0


### read in all contributed reports

reports <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Escapee reports_2017-03-28.csv")

reports$TotalFarmed <- as.character(reports$TotalFarmed)
reports <- subset(reports, !TotalFarmed %in% c("N/A"))
reports$detected[reports$TotalFarmed=="N/A"] <- "NA"
reports$detected[is.na(reports$TotalFarmed)=="FALSE"] <- 1
reports$detected[reports$TotalFarmed==0] <- 0
reports$detected[reports$TotalFarmed%in%c("?", "Suspected", "Unconfirmed")] <- 0.5

reports$Year.adj <- as.numeric(as.character(reports$Year))


### join all reports

names(bradoverview2015)
names(brad2016simp)
names(reports)

reports <- join(reports, bradoverview2015, type="full")

reports <- join(reports, brad2016simp, type="full")


# 503 different river/year reports
```

### get coordinates for reports
```{r}
morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nsrivers <- as.data.frame(unique(morris$River[morris$Prov=="NS"]))
names(nsrivers) <- c("river")
#nsrivers
coords_clean <- rbind(c(-65.59265, 44.69787), # Annap
c(-60.86494, 46.06677),# Baddeck
c(-65.69013, 44.61802), #Bear
c(-60.79996, 45.86143), #BRas
c(-64.22795, 45.12565), #Gasp
c(-60.61312, 45.59906), #Grand
c(-64.09798, 45.39943), #Harr
c(-60.57251, 46.26069), #Indian
c(-64.34167, 44.28720), #Lahave
c(-61.99407, 45.00587), #Liscomb
c(-61.11676, 46.44321), #Marg
c(-64.65848, 44.03053), # Mersey
c(-66.16127, 44.23016), #Meteghan
c(-60.88931, 46.05536), #MIddle
c(-65.60077, 44.69787), #Nict
c(-60.58063, 46.23217), #North
c(-64.30106, 45.37091), # Parrs
c(-63.54560, 44.62372), #Sack
c(-66.18564, 44.05905), #Salmon
c(-60.93805, 46.01543), #skye
c(-63.48874, 45.33098), #Stew
c(-60.50752, 46.36336), #St. Ann
c(-61.86410, 45.02298), #St. mary
c(-65.95007, 43.76246), #Tusket
c(-60.93805, 46.01543)) #Why 

nsrivers <- cbind(nsrivers, coords_clean)
nsrivers$river <- as.character(nsrivers$river)

names(nsrivers) <- c("River", "long", "lat")

nsrivers$code <- as.character(c("APR", "BAD", "BRR", "BRA", "GAK", "GRA", "HAR", "IND", "LAH", "LIS", "MGR", "MER", "MET", "MID", "NIC", "NRV", "PAR", "SAC", "SAD", "SKY", "STW", "STA", "SMA", "TUS", "WHY"))

nsrivers <- nsrivers[,c(1,3,2,4)]



morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nbrivers <- as.data.frame(unique(morris$River[morris$ProvState=="NB"]))
names(nbrivers) <- c("river")
coords_clean <- rbind(c(45.545066, -66.011293), 
               c(45.422197, -65.402976),
               c(45.262844, -65.781699),
               c(45.179130, -66.987045),
               c(45.131204, -67.068731),
               c(45.199799, -67.261215),
               c(45.118038, -66.876022),
               c(47.074048, -65.399438),
               c(45.570888, -65.774480),
               c(45.957255, -66.618207),
               c(45.502517, -66.072903),
               c(45.167935, -67.194878),
               c(45.610963, -64.957627),
               c(45.206954, -67.147044))
nbrivers <- cbind(nbrivers, coords_clean)

names(nbrivers) <- c("River", "lat", "long")

# plot(NBrast)
# plot(NB.low, add=TRUE)
# points(nbrivers[,3], nbrivers[,2], col="red")
nbrivers[,2:3] <- rbind(c(45.25795, -66.04133),# BIB
                    c(45.40349, -65.40872), # BSR
                    c(45.25354, -65.79461), # BKR
                    c(45.14328, -66.97758), # BOC
                    c(45.11682, -67.02819), # CHS
                    c(45.18298, -67.27490), # DNS
                    c(45.12123, -66.91432), # MDR
                    c(NA, NA),              # MIR
                    c(45.12123, -66.91432), # MTB
                    c(45.24913, -66.04765), # NSH
                    c(45.24913, -66.04765), # SJR
                    c(45.16092, -67.19266), # SCR
                    c(45.58872, -64.93427), # USR
                    c(45.17416, -67.15471)) # WAR

nbrivers2 <- subset(nbrivers, is.na(lat)=="FALSE")
nbrivers2$code <- c("BIB", "BSR", "BKR", "BOC", "CHS", "DNS", "MDR", "MTB", "NSH", "SJR", "SCR", "USR", "WAR")

marreports <- rbind(nbrivers2, nsrivers)

nlrivers <- sched[,c(3:5)]
names(nlrivers) <- c("River", "long", "lat")
nlrivers$code <- NA

atlreports <- rbind(marreports, nlrivers)

atlreports$River <- as.character(atlreports$River)

atlreports[10,1] <- "St. John River"
atlreports[22,1] <- "Lahave"
atlreports[29,1] <- "North (CB)"

fullreports <- join(reports, atlreports, type="left")
fullreports[fullreports$River=="Clyburn",17] <- 46.661677
fullreports[fullreports$River=="Clyburn",18] <- -60.397694

fullreports$lat <- ifelse(is.na(fullreports$lat)=="TRUE", fullreports$Latitude.in, fullreports$lat)
fullreports$long <- ifelse(is.na(fullreports$long)=="TRUE", fullreports$Longitude.in, fullreports$long)

fullreports$lat <- ifelse(is.na(fullreports$lat)=="TRUE", fullreports$lat1, fullreports$lat)
fullreports$long <- ifelse(is.na(fullreports$long)=="TRUE", fullreports$long1, fullreports$long)

# Cobscott Bay is a typo. Remove.
fullreports <- fullreports[!fullreports$River=="Cobscott Bay",]
# Connecticut, pawcatuck and merrimack River is way too far inland. Remove.
fullreports <- fullreports[!fullreports$River=="Connecticut River",]
fullreports <- fullreports[!fullreports$River=="Merrimack",]
fullreports <- fullreports[!fullreports$River=="Pawcatuck",]

# remove unknown locations
fullreports <- fullreports[!fullreports$River=="Unknown",]

fullreports$River[fullreports$River=="Simm's"] <- "Simmons Brook"
fullreports$River[fullreports$River=="Garnish"] <- "Garnish River"

# create reportlocs to identify rivers
reportlocs <- unique(fullreports[,c(1,19:20)])

reportlocs[reportlocs$River=="Androscoggin", 3:2] <- c(-69.878744, 43.953714)
reportlocs[reportlocs$River=="Annapolis", 3:2] <- c(-65.68093, 44.65396)  
reportlocs[reportlocs$River=="Aroostook", 3:2] <- c(-66.04765, 45.24913)
reportlocs[reportlocs$River=="Bay Du Nord", 3] <- -55.42948 
reportlocs[reportlocs$River=="Bay Du Nord", 2] <- 47.70122
reportlocs[reportlocs$River=="Bear", 3:2] <- c(-65.69852, 44.62575)
reportlocs[reportlocs$River=="Bill Skinners Cove", 3:2] <- c(-55.75627, 47.5521) 
reportlocs[reportlocs$River=="Boyden Stream", 3:2] <- c(-67.04209, 44.97076) 
reportlocs[reportlocs$River=="Clyburn", 3] <- -60.39769
reportlocs[reportlocs$River=="Clyburn", 2] <- 46.66168
reportlocs[reportlocs$River=="Cobscook Bay", 3:2] <- c(-67.071438, 44.910682)
reportlocs[reportlocs$River=="Collins Brook ", 3:2] <- c(-55.82494, 47.79367)
reportlocs[reportlocs$River=="Connaigre Bay", 3:2] <- c(-55.843870, 47.539911)
reportlocs[reportlocs$River=="Conne River",3:2] <- c(-55.801525, 47.867332)
reportlocs[reportlocs$River=="Dennis Stream", 3:2] <- c(-67.15164, 45.16442)  
reportlocs[reportlocs$River=="Dennys River", 3:2] <- c(-67.17081, 44.89716) 
reportlocs[reportlocs$River=="D'Espoir Brook", 3:2] <- c(-56.16406, 47.84225)
reportlocs[reportlocs$River=="East Machias", 3:2] <- c(-67.39036, 44.68688)
reportlocs[reportlocs$River=="Frenchman's Cove", 3:2] <- c(-55.38782, 47.21629)
reportlocs[reportlocs$River=="Grandy Brook", 3:2] <- c(-57.68647, 47.62023)
reportlocs[reportlocs$River=="Grand Bank Brook", 3:2] <- c(-55.74006, 47.11024)
reportlocs[reportlocs$River=="Garnish River", 3] <- -55.37788
reportlocs[reportlocs$River=="Garnish River", 2] <- 47.24417
reportlocs[reportlocs$River=="Hobart Stream", 3:2] <- c(-67.12043, 44.88428)
reportlocs[reportlocs$River=="Kennebec", 3:2] <- c(-69.75693, 43.74425) 
reportlocs[reportlocs$River=="Lahave", 3:2] <- c(-64.34988, 44.27322) 
reportlocs[reportlocs$River=="Little River", 3] <- -55.81197
reportlocs[reportlocs$River=="Little River", 2] <- 47.7953
reportlocs[reportlocs$River=="Long Harbour", 3:2] <- c(-54.96017, 47.764)
reportlocs[reportlocs$River=="Machias", 3:2] <- c(-67.390493, 44.688272)
reportlocs[reportlocs$River=="Magaguadavic",3:2] <- c(-66.910076, 45.122017)
reportlocs[reportlocs$River=="Mal Bay Brook", 3:2]  <- c(-55.15675, 47.62835)
reportlocs[reportlocs$River=="Margaree", 3:2] <- c(-61.10427, 46.44772)
reportlocs[reportlocs$River=="Miramichi", 3:2] <- c(-65.332628, 47.086688)
reportlocs[reportlocs$River=="Narraguagus", 3:2] <- c(-67.887, 44.54183)
reportlocs[reportlocs$River=="Nictaux", 3:2] <- c(-65.68093, 44.65396) 
reportlocs[reportlocs$River=="North (CB)", 3:2] <- c(-60.58669, 46.24114)
reportlocs[reportlocs$River=="North East Brook", 3:2] <- c(-55.37232, 47.7188)
reportlocs[reportlocs$River=="North West Brook 1", 3] <- -55.38075 
reportlocs[reportlocs$River=="North West Brook 1", 2] <- 47.7109 
reportlocs[reportlocs$River=="Old Brook", 3:2] <- c(-55.64168, 47.50313)
reportlocs[reportlocs$River=="Pennamaquan", 3:2] <- c(-67.164242, 44.943102)
reportlocs[reportlocs$River=="Penobscot", 3:2] <- c(-68.79487, 44.48683)
reportlocs[reportlocs$River=="Pleasant River", 3:2] <- c(-70.24207, 43.69196) 
reportlocs[reportlocs$River=="Rencontre Brook", 3:2] <- c(-55.20745, 47.63259)
reportlocs[reportlocs$River=="Saco River", 3:2] <- c(-70.37678, 43.46604)
reportlocs[reportlocs$River=="Salmon River 1", 3:2] <- c(-55.46242, 47.63996)
reportlocs[reportlocs$River=="Salmon River 2", 3:2] <- c(-56.1103, 47.74382) 
reportlocs[reportlocs$River=="Salmonier Brook", 3] <- -55.67354
reportlocs[reportlocs$River=="Salmonier Brook", 2] <- 47.66986
reportlocs[reportlocs$River=="Shoal Brook", 3] <- -55.68705
reportlocs[reportlocs$River=="Shoal Brook", 2] <- 47.66858
reportlocs[reportlocs$River=="Simmons Brook", 3] <- -55.45720
reportlocs[reportlocs$River=="Simmons Brook", 2] <- 47.63639
reportlocs[reportlocs$River=="Southeast Brook", 3:2] <-c(-55.7659, 47.91822)
reportlocs[reportlocs$River=="South West Brook 1", 3:2] <- c(-55.46466, 47.61965)
reportlocs[reportlocs$River=="St. Croix River", 3:2] <- c(-67.19257, 45.16494)
reportlocs[reportlocs$River=="Tailrace", 3] <- -55.76375
reportlocs[reportlocs$River=="Tailrace", 2] <- 47.93676
reportlocs[reportlocs$River=="Taylors Bay Brook 1", 3:2] <- c(-55.61144, 47.5217)
reportlocs[reportlocs$River=="Terrenceville Brook", 3:2] <- c(-54.73114, 47.67646)
reportlocs[reportlocs$River=="Tickle Harbour", 3:2] <- c(-55.15429, 47.64118) 
reportlocs[reportlocs$River=="Togus Stream", 3:2] <- c(-69.75937, 43.75544) 
reportlocs[reportlocs$River=="Union River", 3:2] <- c(-68.430865, 44.490147)
reportlocs[reportlocs$River=="Bolden's Cove", 3:2] <- c(-55.75307, 47.54519)
reportlocs[reportlocs$River=="East Bay", 3:2] <- c(-56.09231, 47.75046)
reportlocs[reportlocs$River=="Hardy's Cove", 3:2] <- c(-55.65659, 47.67506)
reportlocs[reportlocs$River=="Little Passage", 3:2] <- c(-55.932142, 47.650579)
reportlocs[reportlocs$River=="Miller's Passage", 3:2] <- c(-55.6099, 47.52215)
reportlocs[reportlocs$River=="North Bay", 3:2] <- c(-56.1607, 47.84891)

names(reportlocs) <-c("River", "latfinal1", "longfinal1")

reportlocs <- unique(reportlocs)

#ggplot() + geom_point(data=reportlocs, aes(longfinal1, latfinal1))

fullreports <- join(fullreports, reportlocs, type="left")

fullreports <- dplyr::select(fullreports, -Latitude.in, -Longitude.in, -lat, -long, -long1, -lat1)

fullreports$Year.adj[is.na(fullreports$Year.adj)==TRUE] <- as.numeric(fullreports$Year[is.na(fullreports$Year.adj)==TRUE])

write.csv(fullreports, "C:/Users/keyserf/Documents/Data/R output/fullreports.csv")

write.csv(reportlocs, "C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")

# check coords
ggplot() +
  geom_point(data=reportlocs, aes(longfinal1, latfinal1)) + 
  coord_map() + 
  theme_classic() 
```

### add Qvalue rivers to reportlocs too
```{r}
maritimeNLqsites <- subset(qsitecoords, !Region%in%c("Gaspesie", "North Shore Lower", "Southern Quebec", "North Shore upper", "Anticosti", "Ungava", "Labrador 1", "Labrador 2", "Labrador 3", "Labrador 4", "Labrador 5", "Melville") & ! Code%in%c("NAR", "NSH", "TOB"))

DAPC2 <- read.table("C:/users/keyserf/Documents/Data/Genetic data/Freya_K2_PosteriorProbabilities.txt")
pops <- row.names(DAPC2)
DAPC2 <- data.frame(ID=pops, X1 = DAPC2$X1, X2 = DAPC2$X2)

pops <- reshape::colsplit(DAPC2$ID, split="_", names=c("pop", "id"))

DAPC2 <- data.frame(pop=pops$pop, ID = pops$id, X1 = DAPC2$X1, X2 = DAPC2$X2)

DAPC_mean <- ddply(.data=DAPC2, .(pop),
                   summarize,
                   meanX1 = mean(X1),
                   meanX2 = mean(X2))
colnames(DAPC_mean)[1]<-"Code"

maritimeNLqsites <-join(maritimeNLqsites, DAPC_mean, type="full")

maritimeNLqsites$River[is.na(maritimeNLqsites$River)] <- c("Aqua", "Bottom Brook", "Aqua", "Dollard", "North West Brook 1", 
                                                           "Grand Bank Brook", "Grand le Pierre", "Salmonier Brook", 
                                                           "Little River", "Mal Bay Brook", "North East Brook", "Old Brook", 
                                                           "Southeast Brook", "Simmons Brook", "Taylors Bay Brook 1", "Terrenceville Brook",
                                                           "Tailrace", "Aqua")
# 
# maritimeNLqsites$River <- gsub(maritimeNLqsites$River,pattern = " ", replacement = ".", fixed=T)
# maritimeNLqsites$River <- gsub(maritimeNLqsites$River,pattern = "(", replacement = ".", fixed=T)
# maritimeNLqsites$River <- gsub(maritimeNLqsites$River,pattern = ")", replacement = ".", fixed=T)

reportlocs <- join(reportlocs, maritimeNLqsites[,c(1:2)], type="full")
reportlocs <- subset(reportlocs, !Code%in%c("LSR"))
reportlocs <- subset(reportlocs, !River %in% c("Aqua"))

# reportlocs$River <- gsub(reportlocs$River,pattern = " ", replacement = ".", fixed=T)
# reportlocs$River <- gsub(reportlocs$River,pattern = "(", replacement = ".", fixed=T)
# reportlocs$River <- gsub(reportlocs$River,pattern = ")", replacement = ".", fixed=T)

reportlocs[which(reportlocs$Code=="BSB"),]$longfinal1 <- -53.28981
reportlocs[which(reportlocs$Code=="BSB"),]$latfinal1 <- 46.7095
reportlocs[which(reportlocs$Code=="WAB"),]$longfinal1 <- -56.77375
reportlocs[which(reportlocs$Code=="WAB"),]$latfinal1 <- 51.21244
reportlocs[which(reportlocs$Code=="NPR"),]$longfinal1 <- -53.99326
reportlocs[which(reportlocs$Code=="NPR"),]$latfinal1 <- 47.24506
reportlocs[which(reportlocs$Code=="GRR"),]$longfinal1 <- -57.09784
reportlocs[which(reportlocs$Code=="GRR"),]$latfinal1 <- 47.56489
reportlocs[which(reportlocs$River=="Grandy.Brook"),]$longfinal1 <- -57.68401
reportlocs[which(reportlocs$River=="Grandy.Brook"),]$latfinal1 <- 47.62091
reportlocs[which(reportlocs$River=="Bottom.Brook"),]$longfinal1 <- -56.31815
reportlocs[which(reportlocs$River=="Bottom.Brook"),]$latfinal1 <- 47.69749
reportlocs[which(reportlocs$River=="Northeast.River.Placentia"),]$longfinal1 <- -53.99627
reportlocs[which(reportlocs$River=="Northeast.River.Placentia"),]$latfinal1 <- 47.24441
reportlocs[which(reportlocs$River=="La.Poile"),]$longfinal1 <- -58.32564
reportlocs[which(reportlocs$River=="La.Poile"),]$latfinal1 <- 47.74495
reportlocs[which(reportlocs$River=="Northeast.Brook.Trepassey"),]$longfinal1 <- -53.37387
reportlocs[which(reportlocs$River=="Northeast.Brook.Trepassey"),]$latfinal1 <- 46.74434
reportlocs[which(reportlocs$River=="Rocky.River"),]$longfinal1 <- -53.60258  
reportlocs[which(reportlocs$River=="Rocky.River"),]$latfinal1 <- 47.15568
reportlocs[which(reportlocs$River=="Antigonish.West"),]$longfinal1 <- -61.87993    
reportlocs[which(reportlocs$River=="Antigonish.West"),]$latfinal1 <- 45.70208
reportlocs[which(reportlocs$River=="Eskasoni"),]$longfinal1 <- -60.57714
reportlocs[which(reportlocs$River=="Eskasoni"),]$latfinal1 <- 45.94572
reportlocs[which(reportlocs$River=="Medway"),]$longfinal1 <- -64.58279
reportlocs[which(reportlocs$River=="Medway"),]$latfinal1 <- 44.1357
reportlocs[which(reportlocs$River=="Cross"),]$longfinal1 <- -62.27921
reportlocs[which(reportlocs$River=="Cross"),]$latfinal1 <- 46.4898
reportlocs[which(reportlocs$River=="Cap.Chat"),]$longfinal1 <- -66.83
reportlocs[which(reportlocs$River=="Cap.Chat"),]$latfinal1 <- 49.08
reportlocs[which(reportlocs$River=="Jacquet"),]$longfinal1 <- -66.01215
reportlocs[which(reportlocs$River=="Jacquet"),]$latfinal1 <- 47.94381
reportlocs[which(reportlocs$River=="St..Genevieve"),]$longfinal1 <- -56.80553
reportlocs[which(reportlocs$River=="St..Genevieve"),]$latfinal1 <- 51.14233
reportlocs[which(reportlocs$River=="Campbellton"),]$longfinal1 <- -54.91214
reportlocs[which(reportlocs$River=="Campbellton"),]$latfinal1 <- 49.29591
reportlocs[which(reportlocs$River=="Dollard"),]$longfinal1 <- -56.52698
reportlocs[which(reportlocs$River=="Dollard"),]$latfinal1 <- 47.69772
reportlocs[which(reportlocs$River=="Grand.le.Pierre"),]$longfinal1 <- -54.77633 
reportlocs[which(reportlocs$River=="Grand.le.Pierre"),]$latfinal1 <-  47.66146
reportlocs[which(reportlocs$River=="North.River.NS"),]$longfinal1<- -63.432582
reportlocs[which(reportlocs$River=="North.River.NS"),]$latfinal1 <- 45.359957

# plot(ATLrast2, xlim=c(-68, -65), ylim=c(47, 52))
# points(qsitecoords$Long[qsitecoords$Code=="JT"], qsitecoords$Lat[qsitecoords$Code=="JT"])
# points(qsitecoords$Long[qsitecoords$Code=="CC"], qsitecoords$Lat[qsitecoords$Code=="CC"])
# click()
# plot(ATLrast2, xlim=c(-57, -56), ylim=c(51, 51.5))
# points(qsitecoords$Long[qsitecoords$Code=="SGR"], qsitecoords$Lat[qsitecoords$Code=="SGR"])
# plot(ATLrast2, xlim=c(-55.2, -54), ylim=c(48.5, 49.5))
# points(qsitecoords$Long[qsitecoords$Code=="CMP"], qsitecoords$Lat[qsitecoords$Code=="CMP"])
# plot(ATLrast2, xlim=c(-57, -56), ylim=c(47, 48))
# click()
# plot(ATLrast2, xlim=c(-57, -52), ylim=c(47, 49))
# points(qsitecoords$Long[qsitecoords$Code=="GLP"], qsitecoords$Lat[qsitecoords$Code=="GLP"])

write.csv(reportlocs, "C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")

```

### site coordinates
```{r}
sitecoords_atl_2 <- unique(select(inventory1, Site.ID, Lat, Long, prov))

# dev.off()
# plot(ATLrast2, xlim=c(-69,-67), ylim=c(44,45))
# plot(ATLrast2, xlim=c(-56,-55), ylim=c(47,48))
# points(sitecoords_atl_2$Long[sitecoords_atl_2$Site.ID==2008], sitecoords_atl_2$Lat[sitecoords_atl_2$Site.ID==2008])
# points(sitecoords_atl_2$Long[sitecoords_atl_2$Site.ID==3041], sitecoords_atl_2$Lat[sitecoords_atl_2$Site.ID==3041])
# 
# click()

sitecoords_atl_2[sitecoords_atl_2$Site.ID==2012,3:2] <- c(-55.80644, 47.54435) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1045,3:2] <- c(-55.77777, 47.50755) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1081,3:2] <- c(-55.19299, 47.62375) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==155,3:2] <- c(-55.80644, 47.86196) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2008,3:2] <- c(-55.84731, 47.61622) 
sitecoords_atl_2[sitecoords_atl_2$Site.ID==867,3:2] <- c(-55.84731, 47.61622) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2021,3:2] <- c(-56.20453, 47.63841) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==877,3:2] <- c(-56.20453, 47.63841) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==841,3:2] <- c(-56.10994, 47.70315) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==885,3:2] <- c(-55.38218, 47.66055) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==826,3:2] <- c(-55.87237, 47.61213) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==924,3:2] <- c(-55.87237, 47.61213) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==978,3:2] <- c(-55.39652, 47.55597) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==991,3:2] <- c(-55.76630, 47.53079) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==993,3:2] <- c(-55.76630, 47.53079) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1002,3:2] <- c(-55.38469, 47.7109) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1043,3:2] <- c(-56.14720, 47.6741) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1048,3:2] <- c(-55.61115, 47.5153) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1049,3:2] <- c(-55.61438, 47.52305) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1071,3:2] <- c(-55.80644, 47.62181) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1072,3:2] <- c(-55.80644, 47.62181) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==1083,3:2] <- c(-55.23276, 47.64505) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2004,3:2] <- c(-55.39616, 47.56565) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2015,3:2] <- c(-56.11280, 47.70509) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2023,3:2] <- c(-56.20740, 47.64312) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2024,3:2] <- c(-55.88348, 47.62375) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2029,3:2] <- c(-55.88348, 47.62375) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==12,3:2] <- c(-66.72061, 45.05403) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==18,3:2] <- c(-66.82469, 45.05210) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==27,3:2] <- c(-66.83017, 45.03467) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==36,3:2] <- c(-66.86577, 45.03854) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==42,3:2] <- c(-66.95067, 45.03467) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==56,3:2] <- c(-66.98628, 44.87199) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==57,3:2] <- c(-66.99723, 44.93396) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==168,3:2] <- c(-66.98628, 44.88361) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==172,3:2] <- c(-66.70692, 44.67058) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==202,3:2] <- c(-66.82743, 44.64347) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==213,3:2] <- c(-66.73705, 44.74417) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==501,3:2] <- c(-66.43304, 45.06178) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==507,3:2] <- c(-66.61729, 45.08234) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==74,3:2] <- c(-64.28439, 44.42198) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==772,3:2] <- c(-62.81166, 44.74062) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==3006,3:2] <- c(-67.01193, 44.89205) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==3041,3:2] <- c(-68.36233, 44.17131) #

# moveATL <- subset(sitecoords_atl_2, Site.ID %in% c(10,37,46,51,53,61,349,491))
# moveNL <- subset(sitecoords_atl_2, Site.ID %in% c(500,781,869,2009,2013,2016,2025,2027,2030,2031))
# 
# plot(ATLrast2, xlim=c(-67.5,-66), ylim=c(44,45.5))
# plot(ATLrast2, xlim=c(-56,-55.5), ylim=c(47.5, 48))
# 
# text(moveNL$Long[6:10], moveNL$Lat[6:10])
# click(n=5)

sitecoords_atl_2[sitecoords_atl_2$Site.ID==10,3:2] <- c(-66.72151, 45.04892) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==37,3:2] <- c(-66.87286, 45.02277) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==53,3:2] <- c(-66.94240, 44.92691) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==61,3:2] <- c(-67.01602, 45.10992) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==491,3:2] <- c(-66.81968, 44.60446) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==51,3:2] <- c(-66.97103, 44.91239) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==349,3:2] <- c( -66.72151, 44.71485) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==46,3:2] <- c(-66.93012, 44.99954) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==500,3:2] <- c(-55.84951, 47.81381) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==781,3:2] <- c(-55.93448, 47.66663) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==869,3:2] <- c(-55.88696, 47.62499) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2009,3:2] <- c(-55.83943, 47.79445) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2013,3:2] <- c(-55.85383, 47.81478) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2016,3:2] <- c(-55.88696, 47.62402) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2025,3:2] <- c(-55.83943, 47.79445) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2027,3:2] <- c(-55.83943, 47.79445) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2030,3:2] <- c(-55.88696, 47.73635) #
sitecoords_atl_2[sitecoords_atl_2$Site.ID==2031,3:2] <- c(-55.84951, 47.81381) #

write.csv(sitecoords_atl_2, "C:/Users/keyserf/Documents/Data/R output/sitecoords_atl_2.csv")
```

## get shapefile
```{r}
all <- getData("GADM", country="CAN", level=1)
allatl <- crop(all, extent(-71, -52, 42, 52))

eastus <- getData("GADM", country="USA", level=1)
eastus <- crop(eastus, extent(-71, -53, 42, 49))

plot(allatl)

east <- rbind(allatl, eastus)
plot(east)

#build raster file
r <- raster(ncols=1550, nrows=1000)
extent(r) <- extent(east)
ATLrast <- rasterize(east, r, fun="first")

#save it in case of changes
ATLrast2 <- ATLrast
plot(ATLrast2)

#change land values to make them impassable
ATLrast2@data@values <- ifelse(is.na(ATLrast2@data@values)=="FALSE", 100000, 1)

#canso causeway is impassable
ATLrast2@data@values <- ifelse(coordinates(ATLrast2)[,1] > -61.42577 & coordinates(ATLrast2)[,1] < -61.414002 & coordinates(ATLrast2)[,2] > 45.641238 & coordinates(ATLrast2)[,2] < 45.647156, 1000000, ATLrast2@data@values)

#passage in baie d'espoir
ATLrast2@data@values <- ifelse(coordinates(ATLrast2)[,1] > -55.92918 & coordinates(ATLrast2)[,1] < -55.88609 & coordinates(ATLrast2)[,2] > 47.62705 & coordinates(ATLrast2)[,2] < 47.64791, 1, ATLrast2@data@values)
```

# Skip below and read in files instead at bottom of chunk (fullreports and reportlocs)
```{r}
# reportlocs <- read.csv("C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")

# bad2<-data.frame(extract(x = ATLrast2, y = SpatialPoints(coords = cbind(reportlocs$longfinal1, reportlocs$latfinal1), proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))))
# bad2$River <- reportlocs$River
# 
# get_good2 <- which(bad2[,1] == 1)
# get_bad2 <- which(bad2[,1] == 100000)
# 
# badrivers2 <- reportlocs$River[get_bad2]
# 
# badrivers2

# dev.off()
# plot(ATLrast2, xlim=c(-57, -53), ylim=c(47, 48))
# points(reportlocs$longfinal[reportlocs$River=="Mal Bay Brook"], reportlocs$latfinal[reportlocs$River=="Mal Bay Brook"])
# 
# reportlocs[reportlocs$River=="Bear", 4:3] <- c(-65.69852, 44.62575)


## find bad AQ sites

bad3<-data.frame(extract(x = ATLrast2, y = SpatialPoints(coords = cbind(sitecoords_atl_2$Long, sitecoords_atl_2$Lat), proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))))
bad3$Site.ID <- sitecoords_atl_2$Site.ID
bad3$prov <- sitecoords_atl_2$prov

get_good3 <- which(bad3[,1] == 1)
get_bad3 <- which(bad3[,1] == 100000)

badsites3 <- sitecoords_atl_2[get_bad3, c("Site.ID", "prov")]

badsites3 <- join(badsites3, sitecoords_atl_2, type="left")

unique(badsites3[])

# dev.off()
# plot(ATLrast2), xlim=c(-67.2, -66.4), ylim=c(44.5, 45.2))
# text(badsites3[badsites3$prov=="NB",]$Long, badsites3[badsites3$prov=="NB",]$Lat, labels=badsites3[badsites3$prov=="NB",]$Site.ID)

badsites3[badsites3$prov=="NB",4:3] <- c(-66.72366, -66.81626, #10, 16
                                         -66.84110, -66.87046, #29, 37
                                         -66.93822, -66.94725, #46, 53
                                         -66.94725, -67.02178, #54, 61
                                         -66.97210, -66.70334, #168, 298
                                         -66.72818, -66.81400, #349, 491
                                         -66.88853, -66.97435, #38, 51
                                         -66.85240, -66.89982, #159, 206
                                         -66.69430, 45.06568,  #378, 10
                                         45.05447, 45.03045,  #16, 29
                                         45.03846, 45.00003,  #37, 46
                                         44.92157, 44.92317,  #53, 54
                                         45.12652, 44.87514,  #61, 168
                                         44.67979, 44.71182,  #298, 349
                                         44.60934, 45.03045,  #491, 38
                                         44.93438, 45.05607,  #51, 159
                                         44.93918, 45.05767)  #206, 378


# plot(ATLrast2, xlim=c(-67, -64), ylim=c(44.2, 44.7))
# text(badsites3[badsites3$prov=="NS",]$Long, badsites3[badsites3$prov=="NS",]$Lat, labels=badsites3[badsites3$prov=="NS",]$Site.ID)

badsites3[badsites3$prov=="NS",4:3] <- rbind(c(-64.31949, 44.40483), #74
                                                                       c(-66.33586, 44.26520),  #742
                                                                       c(-65.74907, 44.64712),  #1039
                                                                       c(-65.70305, 44.65533))  #1040

# dev.off() 
# plot(ATLrast2, xlim=c(-57, -55), ylim=c(47, 48))
# text(badsites3[badsites3$prov=="NL"& badsites3$Site.ID<1000,]$Long, badsites3[badsites3$prov=="NL" & badsites3$Site.ID<1000,]$Lat)

badsites3[badsites3$prov=="NL", 4:3] <- rbind(c(-55.36514, 47.70264), # 1046
                                                 c(-55.60664, 47.52799), # 1040
                                                 c(-55.32772, 47.64749), # 1082
                                                 c(-55.83114, 47.79226), # 2009
                                                 c(-55.78352, 47.57625), # 2012
                                                 c(-55.83454, 47.81524), # 2013
                                                 c(-55.88896, 47.62680), # 2016
                                                 c(-55.83794, 47.79455), # 2025
                                                 c(-55.83454, 47.79455), # 2027
                                                 c(-55.86856, 47.73481), # 2030
                                                 c(-55.83454, 47.81064), # 2031
                                                 c(-55.84134, 47.81524), # 500
                                                 c(-55.88556, 47.62680), # 781
                                                 c(-55.88556, 47.62680), # 833
                                                 c(-55.88556, 47.62680), # 869
                                                 c(-55.38895, 47.65668), # 886
                                                 c(-55.74950, 47.64749)) # 939
                                              

# dev.off() 
# plot(ATLrast2, xlim=c(-68, -67), ylim=c(44, 45))
# points(badsites3[badsites3$Site.ID %in% c(3034),]$longfinal, badsites3[badsites3$Site.ID %in% c(3034),]$latfinal)
badsites3[badsites3$prov=="ME", 4:3] <- c(-67.36914, 44.60755)#3034
    
names(badsites3) <-c("Site.ID", "prov", "latfinal", "longfinal")
sitecoords_atl_2 <- join(sitecoords_atl_2, badsites3, type="left")

sitecoords_atl_2$Long <- ifelse(is.na(sitecoords_atl_2$longfinal)==FALSE, sitecoords_atl_2$longfinal, sitecoords_atl_2$Long)
sitecoords_atl_2$Lat <- ifelse(is.na(sitecoords_atl_2$latfinal)==FALSE, sitecoords_atl_2$latfinal, sitecoords_atl_2$Lat)


# FOR AQPRESS USAGE ONLY:
#
#
# dev.off()
# plot(rasterAQ, xlim=c(-64.5, -64.2), ylim=c(44.3,44.5))
# points(sitecoords_atl[sitecoords_atl$Site.ID%in%c(74) & sitecoords_atl$prov=="NS", 4:3]$Long, sitecoords_atl[sitecoords_atl$Site.ID%in%c(74) & sitecoords_atl$prov=="NS", 4:3]$Lat) 
# sitecoords_atl[sitecoords_atl$Site.ID%in%c(74) & sitecoords_atl$prov=="NS",4:3] <- c(-64.31927, 44.40678)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-61.1, -60.9), ylim=c(45.9,46.1))
# points(sitecoords_atl[sitecoords_atl$Site.ID%in%c(193) & sitecoords_atl$prov=="NS",]$Long,sitecoords_atl[sitecoords_atl$Site.ID%in%c(193) & sitecoords_atl$prov=="NS",]$Lat) 
# sitecoords_atl[sitecoords_atl$Site.ID%in%c(193) & sitecoords_atl$prov=="NS",4:3] <- c(-60.97104, 46.01466)
# 
# 
# dev.off()
# plot(rasterAQ, xlim=c(-67.1, -66.7), ylim=c(44.5,45.2))
# text(sitecoords_atl[sitecoords_atl$Site.ID%in%c(16,34,52,168,350,491,14,44,49,159) & sitecoords_atl$prov=="NB",]$Long, sitecoords_atl[sitecoords_atl$Site.ID%in%c(16,34,52,168,350,491,14,44,49,159) & sitecoords_atl$prov=="NB",]$Lat, labels=sitecoords_atl[sitecoords_atl$Site.ID%in%c(16,34,52,168,350,491,14,44,49,159) & sitecoords_atl$prov=="NB",]$Site.ID)
# sitecoords_atl[sitecoords_atl$Site.ID%in%c(16,34,52,168,350,491,14,44,49,159) & sitecoords_atl$prov=="NB",4:3] <- rbind(c(-66.81515, 45.04547), 
#                                                                                                                         c(-66.86131, 45.04885), c(-66.94248, 44.92473), 
#                                                                                                                         c(-66.98068, 44.87282), c(-66.71965, 44.72049),
#                                                                                                                         c(-66.81992, 44.61554), c(-66.81037, 45.06239),
#                                                                                                                         c(-66.90746, 44.99356), c(-66.97590, 44.93375),
#                                                                                                                         c(-66.85972, 45.05111))
# 
# sitecoords_atl[sitecoords_atl$Site.ID==54,4:3] <- c(-66.93211, 44.91673)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-61.5, -60), ylim=c(46,46.8))
# text(reportlocs[reportlocs$River %in% c("Clyburn", "Margaree"),]$Long, 
#      reportlocs[reportlocs$River %in% c("Clyburn", "Margaree"),]$Lat,
#      labels=reportlocs[reportlocs$River %in% c("Clyburn", "Margaree"),]$River) 
# reportlocs[reportlocs$River =="Clyburn", 5:4] <- c(-60.39119, 46.66155)
# reportlocs[reportlocs$River =="Margaree", 5:4] <- c(-61.11375, 46.4434)
# 
# 
# dev.off()
# plot(rasterAQ, xlim=c(-65, -64), ylim=c(44, 45))
# points(reportlocs[reportlocs$River == "Lahave",]$longfinal, 
#        reportlocs[reportlocs$River == "Lahave",]$latfinal)
# reportlocs[reportlocs$River == "Lahave",5:4] <-c(-64.34928, 44.27843)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-67.1, -66.7), ylim=c(44.5,45.2))
# points(sitecoords_atl[sitecoords_atl$Site.ID==52,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==52,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==52, 5:4] <- c(-66.94248, 44.92473)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-67, -66.8), ylim=c(44.9, 45.2))
# points(sitecoords_atl[sitecoords_atl$Site.ID==39,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==39,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==39,5:4] <- c(-66.9123, 45.05808)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-66.9, -66.6), ylim=c(44.9, 45.2))
# points(sitecoords_atl[sitecoords_atl$Site.ID==20,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==20,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==20, 5:4] <- c(-66.83126, 45.06165)
# 
# points(sitecoords_atl[sitecoords_atl$Site.ID==26,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==26,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==26, 5:4] <- c(-66.82261, 45.04128)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-67, -66.8), ylim=c(44.9, 45.1))
# points(sitecoords_atl[sitecoords_atl$Site.ID==46,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==46,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==46, 5:4] <- c(-66.93936, 45.00064)
# 
# points(sitecoords_atl[sitecoords_atl$Site.ID==40,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==40,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==40, 5:4] <- c(-66.91425, 45.06824)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-57, -56), ylim=c(47, 48))
# points(sitecoords_atl[sitecoords_atl$Site.ID==2023,]$Long, sitecoords_atl[sitecoords_atl$Site.ID==2023,]$Lat)
# sitecoords_atl[sitecoords_atl$Site.ID==2023, 5:4] <- c(-56.21113, 47.64143)
# 
# dev.off()
# plot(rasterAQ, xlim=c(-55, -54), ylim=c(47, 48))
# points(reportlocs[reportlocs$River=="Terrenceville Brook",]$Long,
#        reportlocs[reportlocs$River=="Terrenceville Brook",]$Lat)
# reportlocs[reportlocs$River=="Terrenceville Brook",5:4] <- c(-54.74464, 47.6669)

# write.csv(reportlocs[2:4], "C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")

sitecoords_atl_2 <- sitecoords_atl_2[,1:4]

write.csv(sitecoords_atl_2, "C:/Users/keyserf/Documents/Data/R output/sitecoords_atl_2.csv")

##### READ IN FOLLOWING:

sitecoords_atl_2 <- read.csv("C:/Users/keyserf/Documents/Data/R output/sitecoords_atl_2.csv")
reportlocs <- read.csv("C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")
inventory1 <- read.csv("C:/Users/keyserf/Documents/Data/R output/inventory1.csv")

```

### fix years in fullreports
```{r}
fullreports[fullreports$Year.adj<1000,]$Year

fullreports[fullreports$Year.adj<1000,]$Year.adj <- c(1996, 1990, 1989, NA, 2005,
                                                        1996, 1996, NA, 1999, NA,
                                                        1996, NA, 1994, 1998,
                                                        2005, 2005, 1988, 1996, 2000,
                                                        2005, 1996, 1998, 2005, 1996,
                                                        NA, NA, 2001, NA, 1998, 
                                                        2005, 1996, 1998, NA, 1989)

write.csv(fullreports, "C:/Users/keyserf/Documents/Data/R output/fullreports_yearfixed.csv")

fullreports <- read.csv("C:/Users/keyserf/Documents/Data/R output/fullreports_yearfixed.csv")
tail(fullreports)
```


### *** clean read - March 20, 2017 ***
```{r}
sitecoords_atl_2 <- read.csv("C:/Users/keyserf/Documents/Data/R output/sitecoords_atl_2.csv")
reportlocs <- read.csv("C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")
inventory1 <- read.csv("C:/Users/keyserf/Documents/Data/R output/inventory1.csv")
fullreports <- read.csv("C:/Users/keyserf/Documents/Data/R output/fullreports_yearfixed.csv")
```     

### calculating propagule pressure for fullreports using AQpress
```{r}

names(sitecoords_atl_2)
names(inventory1) 
names(reportlocs) <- c("X", "X1", "River", "Lat", "Long", "Code")

reportlocs$River <- gsub("\\s", ".", reportlocs$River)
reportlocs$River <- gsub("'", ".", reportlocs$River, fixed=TRUE)
reportlocs$River <- gsub("(", ".", reportlocs$River, fixed=TRUE)
reportlocs$River <- gsub(")", ".", reportlocs$River, fixed=TRUE)

inventory1 <- subset(inventory1, Year>2004 & Year<2016)
inventory1 <- subset(inventory1, !is.na(Lat))

calcAQpress(AQsites = sitecoords_atl_2[,2:5], rivercoords = reportlocs[,2:4], inventory=inventory1[,2:7], dir="C:/Users/keyserf/Documents/Data/R output", inputRast=TRUE, rastName=ATLrast2, saveRast=FALSE, distType="weightedDist", stocking=FALSE)

# NL ONLY
# sfaNLlocs <- sched[,c(1,3,6,7)]
# names(sfaNLlocs) <- c("prov", "River", "Long", "Lat")
# sfaNLlocs$River <- gsub("\\s", ".", sfaNLlocs$River)
# sfaNLlocs$River <- gsub("'", ".", sfaNLlocs$River, fixed=TRUE)
# sfaNLlocs$River <- gsub("(", ".", sfaNLlocs$River, fixed=TRUE)
# sfaNLlocs$River <- gsub(")", ".", sfaNLlocs$River, fixed=TRUE)
# 
# plot(ATLrast2, xlim=c(-54.5, -53), ylim=c(47, 48))
# points(sfaNLlocs[sfaNLlocs$River=="Northeast.River",]$Long, sfaNLlocs[sfaNLlocs$River=="Northeast.River",]$Lat)
# #click()
# sfaNLlocs[sfaNLlocs$River=="Grandy.Brook",]$Long <- -57.68401
# sfaNLlocs[sfaNLlocs$River=="Grandy.Brook",]$Lat <- 47.62091
# sfaNLlocs[sfaNLlocs$River=="Kings.Harbour.Brook",]$Long <- -57.56606
# sfaNLlocs[sfaNLlocs$River=="Kings.Harbour.Brook",]$Lat <- 47.62796
# sfaNLlocs[sfaNLlocs$River=="Brent.Cove.Brook",]$Long <- -56.31818
# sfaNLlocs[sfaNLlocs$River=="Brent.Cove.Brook",]$Lat <- 47.70246
# sfaNLlocs[sfaNLlocs$River=="Bottom.Brook",]$Long <- -56.31818
# sfaNLlocs[sfaNLlocs$River=="Bottom.Brook",]$Lat <- 47.73036
# sfaNLlocs[sfaNLlocs$River=="Allan.s.Cove.Brook",]$Long <- -56.31818
# sfaNLlocs[sfaNLlocs$River=="Allan.s.Cove.Brook",]$Lat <- 47.70246
# sfaNLlocs[sfaNLlocs$River=="D.Espoir.Brook",]$Long <- -56.15778
# sfaNLlocs[sfaNLlocs$River=="D.Espoir.Brook",]$Lat <- 47.84365
# sfaNLlocs[sfaNLlocs$River=="Long.Reach.Brook",]$Long <- -56.11604
# sfaNLlocs[sfaNLlocs$River=="Long.Reach.Brook",]$Lat <- 47.74495
# sfaNLlocs[sfaNLlocs$River=="North.West.Brook.2",]$Long <- -55.81321
# sfaNLlocs[sfaNLlocs$River=="North.West.Brook.2",]$Lat <- 47.893
# sfaNLlocs[sfaNLlocs$River=="Little.River",]$Long <- -55.8393
# sfaNLlocs[sfaNLlocs$River=="Little.River",]$Lat <- 47.79078
# sfaNLlocs[sfaNLlocs$River=="Old.Brook",]$Long <- -55.61494
# sfaNLlocs[sfaNLlocs$River=="Old.Brook",]$Lat <- 47.52288
# sfaNLlocs[sfaNLlocs$River=="Belle.Harbour.River",]$Long <- -55.3384
# sfaNLlocs[sfaNLlocs$River=="Belle.Harbour.River",]$Lat <- 47.6533
# sfaNLlocs[sfaNLlocs$River=="Big.Salmonier.Brook",]$Long <- -55.18174
# sfaNLlocs[sfaNLlocs$River=="Big.Salmonier.Brook",]$Lat <- 46.98737
# sfaNLlocs[sfaNLlocs$River=="Mal.Bay.Brook",]$Long <- -55.15578
# sfaNLlocs[sfaNLlocs$River=="Mal.Bay.Brook",]$Lat <- 47.62863
# sfaNLlocs[sfaNLlocs$River=="Bay.de.l.Eau.River",]$Long <- -54.8373
# sfaNLlocs[sfaNLlocs$River=="Bay.de.l.Eau.River",]$Lat <- 47.37483
# sfaNLlocs[sfaNLlocs$River=="Terrenceville.Brook",]$Long <- -54.75903
# sfaNLlocs[sfaNLlocs$River=="Terrenceville.Brook",]$Lat <- 47.66388
# sfaNLlocs[sfaNLlocs$River=="Northeast.River",]$Long <- -53.99627
# sfaNLlocs[sfaNLlocs$River=="Northeast.River",]$Lat <- 47.24441


# calcAQpress(AQsites = sitecoords_atl_2[,2:5], rivercoords = reportlocs[,2:4], inventory=inventory1[,2:7], dir="C:/Users/keyserf/Documents/Data/R output", inputRast=TRUE, rastName=ATLrast2, saveRast=FALSE, distType="weightedDist", stocking=FALSE)

avgpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-03-29_ALL OBS OR GEN SITES.csv.csv")
allpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-03-29_ALL OBS OR GEN SITES.csv.csv")

totalpp <- ddply(.data=allpp, .(River, Lat, Long), 
                 summarize,
                 total = sum(prop.press, na.rm=T))

pp <- join(avgpp, totalpp, type="left")

eastland <- fortify(east)

sampmapgene <- subset(sampmap, Q.value=="Q"|PARR=="P")
colnames(sampmapgene)[2] <-"River"
sampmapgene$River <- gsub("\\s", ".", sampmapgene$River)
sampmapgene$River <- gsub("'", ".", sampmapgene$River, fixed=TRUE)
sampmapgene$River <- gsub("(", ".", sampmapgene$River, fixed=TRUE)
sampmapgene$River <- gsub(")", ".", sampmapgene$River, fixed=TRUE)
sampmapgene[sampmapgene$Prov=="NL",]$River <- c("Bay.du.Nord.River", "Biscay.Bay", "Bottom.Brook", "Campbellton", "Conne.River", "Dolland.Brook", "North.West.Brook.1", "Garnish.River", "Grand.Bank.Brook", "Grand.le.Pierre.Brook", "Grey.River", "Long.Harbour.River", "Salmonier.River", "La.Poile", "Little.River", "Mal.Bay.Brook", "Northeast.Brook.Trep", "Northeast.Branch", "Northeast.River", "Old.Brook", "Rocky.River", "Southeast.Brook", "St..Genevieve", "Simmons.Brook", "St..Paul", "Taylors.Bay.Brook.1", "Terrenceville.Brook", "Tailrace", "Western.Arm.Brook")
colnames(sampmapgene)[1] <- "prov"
sampmapgene$prov <- ifelse(sampmapgene$prov=="New Brunswick", "NB", ifelse(sampmapgene$prov=="Nova Scotia", "NS", ifelse(sampmapgene$prov=="Newfoundland", "NL", NA)))

# sampmapgene <- join(sampmapgene, sfaNLlocs, type="left")
# head(sampmapgene)
# sampmapgene$long <- ifelse(is.na(sampmapgene$Long)==TRUE, sampmapgene$Longitude, sampmapgene$Long)
# sampmapgene$lat <- ifelse(is.na(sampmapgene$Lat)==TRUE, sampmapgene$Latitude, sampmapgene$Lat)


# sfaNLlocs <- join(sfaNLlocs, sampmapgene, type="full")
# sfaNLlocs$Long <- ifelse(is.na(sfaNLlocs$Long)==TRUE, sfaNLlocs$Longitude, sfaNLlocs$Long)
# sfaNLlocs$Lat <- ifelse(is.na(sfaNLlocs$Lat)==TRUE, sfaNLlocs$Latitude, sfaNLlocs$Lat)
# 
# plot(ATLrast2, xlim=c(-65, -64), ylim=c(44, 45))
# points(sfaNLlocs[sfaNLlocs$River=="LaHave",]$Long, sfaNLlocs[sfaNLlocs$River=="LaHave",]$Lat)
# click()
# 
# sfaNLlocs[sfaNLlocs$River=="Biscay.Bay",]$Long <- -52.28638
# sfaNLlocs[sfaNLlocs$River=="Biscay.Bay",]$Lat <- 46.72819
# sfaNLlocs[sfaNLlocs$River=="La.Poile",]$Long <- -58.32564
# sfaNLlocs[sfaNLlocs$River=="La.Poile",]$Lat <- 47.74495
# sfaNLlocs[sfaNLlocs$River=="Northeast.Brook.Trep",]$Long <- -53.37387
# sfaNLlocs[sfaNLlocs$River=="Northeast.Brook.Trep",]$Lat <- 46.74434
# sfaNLlocs[sfaNLlocs$River=="Rocky.River",]$Long <- -53.57016
# sfaNLlocs[sfaNLlocs$River=="Rocky.River",]$Lat <- 47.18897
# sfaNLlocs[sfaNLlocs$River=="Antigonish.West",]$Long <- -61.89378
# sfaNLlocs[sfaNLlocs$River=="Antigonish.West",]$Lat <- 45.68606
# sfaNLlocs[sfaNLlocs$River=="Eskasoni",]$Long <- -60.57714
# sfaNLlocs[sfaNLlocs$River=="Eskasoni",]$Lat <- 45.94572
# sfaNLlocs[sfaNLlocs$River=="LaHave",]$Long <- -64.35339
# sfaNLlocs[sfaNLlocs$River=="LaHave",]$Lat <- 44.27087
# sfaNLlocs[sfaNLlocs$River=="Medway",]$Long <- -64.58279
# sfaNLlocs[sfaNLlocs$River=="Medway",]$Lat <- 44.1357
# sfaNLlocs[sfaNLlocs$River=="North",]$Long <- -60.59079
# sfaNLlocs[sfaNLlocs$River=="North",]$Lat <- 46.23334

# calcAQpress(AQsites = sitecoords_atl_2[,2:5], rivercoords = sfaNLlocs[,2:4], inventory=inventory1[,2:7], dir="C:/Users/keyserf/Documents/Data/R output", inputRast=TRUE, rastName=ATLrast2, saveRast=FALSE, distType="weightedDist", stocking=FALSE)

# avgpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-03-21.csv")
# allpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-03-21.csv")
# 
# totalpp <- ddply(.data=allpp, .(River, Lat, Long), 
#                  summarize,
#                  total = sum(prop.press, na.rm=T))
# names(totalpp)
# 
totalpp <- totalpp %>%
         arrange(-total)


### for reportlocs, entire atlantic + AQ sites
#MAR
MAR <- ggplot() + 
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_polygon(data=eastland, aes(long, lat, group=group), fill="grey") +
  coord_map(xlim=c(-71, -58), ylim=c(43, 47.5)) + ### sets boundaries
  geom_point(data=totalpp, aes(Long, Lat, size=total), fill="yellow", shape=21, colour="black") +
  #geom_point(data=sitecoords_atl_2, aes(Long, Lat), size=0.5) + 
  ggsn::scalebar(data=eastland, dist=100, dd2km=TRUE, model="WGS84", location="bottomright", anchor=c(x = -59, y = 43.5), st.size=3) +
   scale_size_continuous(name="Propagule\npressure", range = c(0.5,10), limits=c(0.0004,0.035)) +
  xlab("Longitude") + ylab("Latitude")
  
#NL
NL <- ggplot() + 
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_polygon(data=eastland, aes(long, lat, group=group), fill="grey") +
  coord_map(xlim=c(-60, -52), ylim=c(46.5, 52)) + ### sets boundaries
  geom_point(data=totalpp, aes(Long, Lat, size=total), fill="yellow", shape=21, colour="black") +
  #geom_point(data=sitecoords_atl_2, aes(Long, Lat), size=0.5) + 
  ggsn::scalebar(data=eastland, dist=50, dd2km=TRUE, model="WGS84", location="bottomright", anchor=c(x = -58, y = 47), st.size=3) +
  scale_size_continuous(name="Propagule\npressure", range = c(0.5,10), limits=c(0.0004,0.035)) +
  xlab("Longitude") + ylab("Latitude")

grid.arrange(MAR, NL, nrow=1)
?grid.arrange



## bring escape_summ_3 over from Escape Pressure script
escape_summ_3 <- subset(escape_summ_3, is.na(Long)=="FALSE")
escape_summ_3$prov <- "NL"
names(escape_summ_3) <- c("Site.ID", "Lat", "Long", "Year", "totalfish", "prov")

# dev.off()
plot(ATLrast2, xlim=c(-56.5, -55.5), ylim=c(47.5, 48))
# points(-56.06085, 47.77315)
# click()
escape_summ_3$Long[escape_summ_3$Site.ID=="Grip Cove"] <- -55.93162
escape_summ_3$Lat[escape_summ_3$Site.ID=="Grip Cove"] <- 47.65667
escape_summ_3$Long[escape_summ_3$Site.ID=="Ironskull"] <- -55.39557
escape_summ_3$Lat[escape_summ_3$Site.ID=="Ironskull"] <- 47.54435
escape_summ_3$Long[escape_summ_3$Site.ID=="Jeddore Lake"] <- -56.0619
escape_summ_3$Lat[escape_summ_3$Site.ID=="Jeddore Lake"] <- 47.77422
escape_summ_3$Long[escape_summ_3$Site.ID=="Long Pond"] <- -55.7883
escape_summ_3$Lat[escape_summ_3$Site.ID=="Long Pond"] <- 47.57146
escape_summ_3$Long[escape_summ_3$Site.ID=="May Cove"] <- -55.87716
escape_summ_3$Lat[escape_summ_3$Site.ID=="May Cove"] <- 47.7322

calcAQpress(AQsites = escape_summ_3[,c(1:3,6)], rivercoords = reportlocs[reportlocs$Long > -60,2:4], inventory=escape_summ_3[,1:6], dir="C:/Users/keyserf/Documents/Data/R output", inputRast=TRUE, rastName=ATLrast2, saveRast=FALSE, distType="weightedDist", stocking=TRUE)

avgep <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-03-29.csv")
allep <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-03-29.csv")

totalep <- ddply(.data=allep, .(River, Lat, Long), 
                 summarize,
                 total = sum(prop.press, na.rm=T))

totalep <- totalep %>%
         arrange(-total)

##NL Only because we don't have NS escape reports

fullNL <- ggplot() + 
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_polygon(data=eastland, aes(long, lat, group=group), fill="grey") +
  coord_map(xlim=c(-60, -52), ylim=c(46.5, 52)) + ### sets boundaries
  geom_point(data=totalep, aes(Long, Lat, size=total), fill="red", shape=21, colour="black") +
  #geom_point(data=sitecoords_atl_2, aes(Long, Lat), size=0.5) + 
  ggsn::scalebar(data=eastland, dist=50, dd2km=TRUE, model="WGS84", location="bottomright", anchor=c(x = -58, y = 47), st.size=3) +
  annotate(geom="rect", xmin = -56.5, xmax = -55, ymin = 47.4, ymax = 48.1, fill=NA, colour="black") +
  scale_size_continuous(name="Escape event\npressure", range = c(0.5,10), limits=c(0.01,220)) +
  xlab("Longitude") + ylab("Latitude")

#inset of south
insetNL <- ggplotGrob(ggplot() + 
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_polygon(data=eastland, aes(long, lat, group=group), fill="grey") +
  coord_map(xlim=c(-56.5, -55), ylim=c(47.4, 48.1)) + ### sets boundaries
  geom_point(data=totalep, aes(Long, Lat, size=total), fill="red", shape=21, colour="black") +
  #geom_point(data=sitecoords_atl_2, aes(Long, Lat), size=0.5) + 
  ggsn::scalebar(data=eastland, dist=50, dd2km=TRUE, model="WGS84", location="bottomright", anchor=c(x = -58, y = 47), st.size=3) +
  scale_size_continuous(name="Escape event\npressure", range = c(0.5,10), limits=c(0.01,220), guide = FALSE) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks=element_blank(), plot.margin=unit(c(0,0,0,0),"mm")) +
  xlab("Longitude") + ylab("Latitude"))

fullNL 
vp = viewport(x=0.65, y=0.75, width=0.3, height=0.3)
pushViewport(vp)
grid.draw(insetNL)


```

#transition layers and calculating propagule pressure
```{r}
tratl <- transition(1/ATLrast2, transitionFunction=mean, directions=8)
tratlc <- geoCorrection(tratl, type="c")

datl_full <- costDistance(tratlc, fromCoords = cbind(as.numeric(sitecoords_atl$Long), as.numeric(sitecoords_atl$Lat)), toCoords = cbind(as.numeric(reportlocs$longfinal1), as.numeric(reportlocs$latfinal1)))


options("scipen"=100, "digits"=7)

datl_full <- cbind(datl_full, sitecoords_atl$Site.ID, as.character(sitecoords_atl$prov))
datl_full <- as.data.frame(datl_full)
colnames(datl_full)[86] <- "Site.ID"
colnames(datl_full)[87] <- "prov"

datl_full1 <- datl_full

### all possible years
dist2AQ_NB <- subset(NB_inv, is.na(lat)==FALSE)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")
dist2AQ_NS <- subset(NSinv, is.na(Lat)==FALSE)

names(dist2AQ_NB) <- c("Site.ID", "Year", "totalfish", "Long", "Lat")
names(dist2AQ_NS)

dist2AQ_NB <- dist2AQ_NB[,c(1,2,3,5,4)]
dist2AQ_NB$prov <- "NB"
dist2AQ_NS$prov <- "NS"

dist2AQ_NS <- dist2AQ_NS[,2:7]

dist2AQ_NL <- annual
names(dist2AQ_NL) <- c("X", "Site.ID", "Year", "totalfish", "Lat", "Long")
dist2AQ_NL <- dist2AQ_NL[,2:6]
dist2AQ_NL$prov <- "NL"

dist2AQ_sub <- rbind(dist2AQ_NB, dist2AQ_NS, dist2AQ_NL)
dist2AQ_sub <- subset(dist2AQ_sub, Year>2004)

#dist2AQ_sub <- dist2AQ_sub[,2:7]
#dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))

dist2AQ <- join(datl_full1, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

dist2AQ[,1:85] <- apply(dist2AQ[,1:85], 2, function(x) as.character(x))
dist2AQ[,1:85] <- apply(dist2AQ[,1:85], 2, function(x) as.numeric(x))

dist2AQ[dist2AQ == 0] <- 1000

# for byyear calcs, change totalfish to 1 (1 year)
dist2AQ$totalfish <- 1

# For each AQ site, caclulate total fish/distance from river
## original calculation
test <- c(dist2AQ$totalfish/dist2AQ[,1:85])
dist2AQ <- cbind(dist2AQ, test)

# sum all pressures for total propagule pressure at a river
prop.press_allreports <- apply(as.matrix(dist2AQ[,92:176]), 2, function(x) sum(x, na.rm=TRUE))

# for each year
prop.pressall_2005 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2005, 92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2006 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2006, 92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2007 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2007, 92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2008 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2008, 92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2009 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2009, 92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2010<- apply(as.matrix(dist2AQ[dist2AQ$Year==2010,  92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2011<- apply(as.matrix(dist2AQ[dist2AQ$Year==2011,  92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2012<- apply(as.matrix(dist2AQ[dist2AQ$Year==2012,  92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2013<- apply(as.matrix(dist2AQ[dist2AQ$Year==2013,  92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2014<- apply(as.matrix(dist2AQ[dist2AQ$Year==2014,  92:176]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressall_2015<- apply(as.matrix(dist2AQ[dist2AQ$Year==2015,  92:176]), 2, function(x) sum(x, na.rm=TRUE))

##only go up to 2015 because we dont have stocking data for 2016

prop.press_all_byyear <- data.frame(prop.press=c(prop.pressall_2005, prop.pressall_2006, prop.pressall_2007, prop.pressall_2008, prop.pressall_2009, prop.pressall_2010, prop.pressall_2011, prop.pressall_2012, prop.pressall_2013, prop.pressall_2014, prop.pressall_2015), Year=rep(2005:2015, each=85), River=rep(reportlocs$River, 11), lat=rep(reportlocs$latfinal1, 11), long=rep(reportlocs$longfinal1, 11))


prop.press_avg_reports <- ddply(.data=prop.press_all_byyear, .(River, long, lat),
                                summarize,
                                averagepress = mean(prop.press),
                                stdpress = sd(prop.press))

timereports <- read.csv("C:/Users/keyserf/Documents/Data/R output/fullreports_yearfixed.csv")

# because some rivers cross provincial borders so need to combine their results
detections <- ddply(.data=timereports, .(River,longfinal1, latfinal1),
                    summarize,
                    detect = max(detected))

# NA's are because some rivers don't have data prior to 2004. 

prop.press_avg_reports <- join(prop.press_avg_reports, detections, type="left")

write.csv(prop.press_avg_reports, "C:/Users/keyserf/Documents/Data/R output/prop.press_avg_reports.csv")

# new2 <- new
# colnames(new2)[c(3,13)] <- c("year.desc", "Year")
# 
# prop.press_atl_byyear <- join(prop.press_atl_byyear, new2, type="left", by=c("River", "Year"))

# prop.press_atl_byyear$PropFarmed <- as.numeric(prop.press_atl_byyear$PropFarmed)
```

# Modelling average propagule pressure
```{r}
prop.press_avg_fun <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-02-03.csv")
unique(prop.press_avg_fun$River)
prop.press_avg_fun$River <- as.character(prop.press_avg_fun$River)

fullreports$River<-gsub("\\s", ".", fullreports$River)
fullreports$River <- gsub("(",".",fullreports$River, fixed=TRUE)
fullreports$River <- gsub(")",".",fullreports$River, fixed=TRUE)
fullreports$River <- gsub("'",".",fullreports$River, fixed=TRUE)

# 
# fullreports[fullreports$River=="Bay.du.Nord.River",]$River<- "Bay.Du.Nord"
# fullreports[fullreports$River=="Bay.Du.Nord",]$latfinal1 <- 47.70501 
# fullreports[fullreports$River=="Bay.Du.Nord",]$longfinal1 <- -55.42238

detections <- ddply(.data=fullreports[fullreports$Year.adj>2004,], .(River, latfinal1, longfinal1),
                       summarize,
                       totalfish = sum(as.numeric(as.character(TotalFarmed)), na.rm=T),
                       PA = max(detected))

detections <- detections[is.na(detections$longfinal1)==FALSE,]

# subreports <- subset(timereports, Year.adj>2004)
# 
# detectionssub <- ddply(.data=subreports, .(River, latfinal1, longfinal1),
#                        summarize,
#                        total = sum(as.numeric(as.character(TotalFarmed))),
#                        PA = max(detected))
# 
# detectionssub$River <- gsub("\\s",".", detectionssub$River)

detectpp <- join(detections, pp, type="left")

detectpp$detect2 <- 0
detectpp$detect2[detectpp$PA > 0] <- 1
detectpp$detect2[is.na(detectpp$PA)] <- NA

# prop.press_avg_fun$River <- factor(prop.press_avg_fun$River, levels=prop.press_avg_fun$River[order(prop.press_avg_fun$long)], ordered=TRUE)

prop.press_avg_plot <- join(unique(prop.press_avg_fun[,c(2,5,6,7,10,11)]), unique(timereports[,c(2:3)]), type="left")

prop.press_avg_plot$ProvState[71:91] <- "NL"
prop.press_avg_plot <- subset(prop.press_avg_plot, ProvState %in% c("NL", "NB", "NS", "ME"))
prop.press_avg_plot <- subset(prop.press_avg_plot, !(River=="St..Croix.River" & ProvState=="ME"))

prop.press_avg_plot <- join(prop.press_avg_plot, unique(prop.press_avg_fun[,c(2,8,9)]), type="left")


relevelingME <- unique(prop.press_avg_plot[prop.press_avg_plot$ProvState=="ME", c(1,7:9)])
relevelingME <- relevelingME[is.na(relevelingME$longfinal1)==FALSE,]
relevelingME <- arrange(relevelingME, latfinal1)
relevelingME$order <- c(1:16)

relevelingNB <-  unique(prop.press_avg_plot[prop.press_avg_plot$ProvState=="NB", c(1,7:9)])
relevelingNB <- relevelingNB[is.na(relevelingNB$longfinal1)==FALSE,]
relevelingNB <- arrange(relevelingNB, longfinal1)
relevelingNB$order <- c(1:12, 14, 13)
relevelingNB$reg <- c(rep("OBOF",12), "GULF", "OBOF")
relevelingNB <- arrange(relevelingNB, order)

relevelingNS <-  unique(prop.press_avg_plot[prop.press_avg_plot$ProvState=="NS", c(1,7:9)])
relevelingNS <- relevelingNS[is.na(relevelingNS$longfinal1)==FALSE,]
relevelingNS <- arrange(relevelingNS, latfinal1, longfinal1)
relevelingNS$order <- c("SU", "SU", "OBOF", "SU", "SU", 
                            "OBOF", "SU", "OBOF", "OBOF", "SU", "SU",
                            "IBOF", "IBOF", "IBOF", "IBOF", 
                            "ECB", "ECB", "ECB", "ECB", 
                            "ECB", "ECB", "ECB", "ECB", "ECB", "ECB", "ECB")
relevelingNS <- arrange(relevelingNS, order)
relevelingNS$order2 <- NA
relevelingNS[relevelingNS$order=="ECB",]$order2 <- c(1,2,3,4,5,6,7,8,9,11,10)
relevelingNS[relevelingNS$order=="SU",]$order2 <- c(2,3,1,4,5,6,7)
relevelingNS[relevelingNS$order=="IBOF",]$order2 <- c(4,3,1,2)
relevelingNS[relevelingNS$order=="OBOF",]$order2 <- c(4,3,2,1)
relevelingNS$order <- factor(relevelingNS$order, levels=c("IBOF", "OBOF", "SU", "ECB"))
relevelingNS <- arrange(relevelingNS, order, order2)
relevelingNS$order <- c(1:26)

relevelingNL <-  unique(prop.press_avg_plot[prop.press_avg_plot$ProvState=="NL", c(1,7:9)])
relevelingNL <- relevelingNL[is.na(relevelingNL$longfinal1)==FALSE,]
relevelingNL <- arrange(relevelingNL, longfinal1, latfinal1)
relevelingNL <- relevelingNL[-18,]
relevelingNL$order <- c(1:27)

ordered <- data.frame(River=c(as.character(relevelingME$River), as.character(relevelingNB$River), as.character(relevelingNS$River), as.character(relevelingNL$River)), order=c(relevelingME$order, relevelingNB$order, relevelingNS$order, relevelingNL$order))

ordered$order <- c(1:83)

prop.press_avg_plot <- join(prop.press_avg_plot, ordered,type="left")
prop.press_avg_plot <- prop.press_avg_plot[-62,]


dev.off()
plot(MARrast2, xlim=c(-67, -60.5), ylim=c(43.2, 46))
text(relevelingNS[relevelingNS$order=="OBOF",]$longfinal1, relevelingNS[relevelingNS$order=="OBOF",]$latfinal1)


prop.press_avg_plot$River <- factor(prop.press_avg_plot$River, levels=unique(prop.press_avg_plot$River[order(prop.press_avg_plot$order)]), ordered=TRUE)


prop.press_avg_plot$ProvState <- factor(prop.press_avg_plot$ProvState, levels=c("ME", "NB", "NS", "NL"))
  
  
ggplot() + geom_point(data=prop.press_avg_plot, aes(River, averagepress)) +
  geom_errorbar(data=prop.press_avg_plot, aes(x=River, ymin=averagepress-stdpress, ymax=averagepress+stdpress)) +
  geom_text(data=prop.press_avg_plot, aes(River, averagepress+stdpress+0.00001, label=River, angle=90, hjust=0), size=3)+
  theme_classic() +
  theme(panel.border=element_rect(colour="black", fill=NA))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("Average propagule pressure") +
  theme(axis.text.x=element_blank())+
  ylim(0,0.004)+
  facet_grid(.~ProvState, scales="free_x", space="free_x")
  



prop.press_avg_sub <- subset(prop.press_avg_fun, !is.na(detect2)=="TRUE")

detectpp$sProp.press <- scale(detectpp$averagepress)

scaleList <- list(scale = attr(detectpp$sProp.press, "scaled:scale"),
                            center = attr(detectpp$sProp.press, "scaled:center"))

require(lme4)
mod <- glmer(detect2~sProp.press+(1|River),data=detectpp,family=binomial(link="logit"))
summary(mod)

summary(glm(detect2~averagepress, detectpp, family=binomial(link="logit")))


sdata <-  scale(seq(from=min(detectpp$averagepress),to=max(detectpp$averagepress),by=0.00001),scale=scaleList$scale,center=scaleList$center)
newdata <- data.frame(expand.grid(unique(as.character(detectpp$River)),sdata),stringsAsFactors = F)
#newdata <- data.frame(River="Big Salmon",sdata,stringsAsFactors = F)

colnames(newdata) <- c("River","sProp.press")

newdata1 <- predict(mod, newdata, se.fit=T)


newdata <- cbind(newdata1, newdata2)
newdata$fixedprop.press <- newdata$sProp.press * (as.numeric(scaleList$scale) + as.numeric(scaleList$center))

## predictSE computes predicted values based on linear predictor and associated standard errors
newdata <- cbind(newdata,AICcmodavg::predictSE(mod,newdata,se.fit=T,type="response")%>%data.frame())
newdata$fixedprop.press <- newdata$sProp.press * (as.numeric(scaleList$scale) + as.numeric(scaleList$center))

#mod_coef=as.data.frame(coef(mod)$River)
#int <- ((log(p/(1-p)) - mod_coef[1,1]) / mod_coef[1,2])*scaleList$scale + scaleList$center



Intercept <- mean(newdata[which(round(newdata$fit,1)==0.5),"fixedprop.press"]) #there are two values, answer is in between

newdata2 <- newdata

ggplot()+
  geom_segment(aes(x=Intercept,xend=Intercept,y=-Inf,yend=0.5),lty=2,colour="grey40")+
  geom_segment(aes(x=-Inf,xend=Intercept,y=0.5,yend=0.5),lty=2,colour="grey40")+
  geom_line(data=newdata2,aes(x=fixedprop.press,y=fit,group=River),lwd=1.12)+
  geom_line(data=newdata2,aes(x=fixedprop.press,y=fit+se.fit,group=River),lty=2,lwd=1.05)+
  geom_line(data=newdata2,aes(x=fixedprop.press,y=fit-se.fit,group=River),lty=2,lwd=1.05)+
  geom_point(data=detectpp,aes(x=averagepress,y=detect2),pch=21,fill="white")+
  labs(x="Average propagule pressure",y=expression(paste("Probability of farmed presence " %+-% " se",sep=" ")))+
  theme_bw() + 
  xlim(0,0.003)


ggplot() +
  geom_point(data=prop.press_avg_sub,aes(x=averagepress,y=detect2),pch=21,fill="white")+
  geom_label_repel(data=prop.press_avg_sub, aes(x=averagepress, y=detect2, label=River))

# provs <- unique(timereports[,])

detectionssub <- ddply(.data=subreports, .(River, latfinal1, longfinal1, ProvState, CountMethod),
                       summarize,
                       total = sum(as.numeric(as.character(TotalFarmed))),
                       PA = max(detected))

totals <- join(detectionssub, prop.press_avg_sub,type="left")


ggplot() + geom_point(data=totals[totals$CountMethod %in% c("Fence", "Non-fence"),], aes(averagepress, total)) +
  facet_wrap(~CountMethod, ncol=2, scale="free_x") + 
  geom_smooth(data=totals[totals$CountMethod %in% c("Fence", "Non-fence"),], aes(averagepress, total), method="lm", colour="black") + 
  theme_classic() + xlab("Average propagule pressure") +
  ylab("Total escapees detected")


totals$adjpress <-  totals$averagepress*1000
mod2 <-glmer(data=totals, total~adjpress + (1|CountMethod), family="poisson")

summary(mod2)

pred.df <- data.frame(adjpress=rep(seq(0,max(totals$adjpress, na.rm=T), 0.01),2), CountMethod=c(rep("Fence", 275), rep("Non-fence", 275)))
pred.df$preds <- predict(mod2, pred.df)

ggplot() + geom_point(data=pred.df, aes(adjpress/1000, preds)) + facet_wrap(~CountMethod)

totals <- totals[is.na(totals$total)==FALSE,]

require(car)
require(MASS)
# poisson <- fitdistr(detectpp$detect2, "Poisson")
# qqp(detectpp$detect2, "pois", poisson$estimate)

qqp(detectpp$detect2, "bernoulli") ## looks better?!
# qqp(detectpp$detect2, "lnorm")

detectpp$pp2 <- detectpp$averagepress*1000

mod2 <- glmer(detect2 ~ pp2 + (1|River), detectpp, family=binomial(link="logit"))
summary(mod2)

newdata <- data.frame(pp2=rep(seq(min(detectpp$pp2), max(detectpp$pp2), 0.02), 50), River=rep(detectpp$River, each=135))

newdata2 <- data.frame(stats::predict(mod2, newdata))

newdata <- cbind(newdata, newdata2)
colnames(newdata)[3] <- "fit"

ggplot() + geom_line(data=newdata, aes(pp2, fit, colour=River))

require("broom")
?broom

tidy(mod2, conf.int=TRUE)
glance(mod2)
detectpp_mod2 <- augment(mod2, detectpp)

ggplot() + geom_point(data=detectpp_mod2, aes(averagepress, .fitted))


expo <- fitdistr(detectpp$detect2, "exponential")


nbinom <- fitdistr(detectpp$detect2, "Negative Binomial")
qqp(detectpp$detect2, "nbinom", size = nbinom$estimate[[1]], mu = nbinom$estimate[[2]])

# gamma <- fitdistr(totals$total, "gamma")
# qqp(recog$Aggression.t, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

PQL <- glmmPQL(total ~ averagepress, ~1 | CountMethod, family = gaussian(link = "log"),
    data = totals, verbose = FALSE)

install.packages("R2admb")
install.packages("glmmADMB", 
    repos=c("http://glmmadmb.r-forge.r-project.org/repos",
            getOption("repos")),
    type="source")
require(glmmADMB)

# We can also try a standard zero-inflated negative binomial model; the default is the NB2 parameterization (variance = (1 + k)).

totals$CountMethod <- as.factor(totals$CountMethod)
totals <- totals[is.na(totals$averagepress)==FALSE,]
fit_zinbinom <- glmmadmb(total~adjpress + (1|CountMethod), 
                     data=totals, 
                     zeroInflation=TRUE, 
                     family="nbinom")

summary(fit_zinbinom)
pred.df <- data.frame(adjpress=rep(seq(0,max(totals$adjpress, na.rm=T), 0.01),2), CountMethod=c(rep("Fence", 275), rep("Non-fence", 275)))
pred.df$preds <- predict(fit_zinbinom, pred.df)

ggplot() + geom_point(data=pred.df, aes(adjpress, preds)) + facet_wrap(~CountMethod)

install.packages("bbmle")
require(bbmle)
install.packages("coefplot")
require(coefplot)
vn <- c("total", "CountMethod", "adjpress") 
coefplot(model=fit_zinbinom, 
             varnames=vn, 
             legend=TRUE)

```



```{r}
ggplot()+
  geom_point(data=prop.press_atl_byyear,aes(x=prop.press,y=detect))+
  geom_point(data=plotdata,aes(x=fixedprop.press,y=fit))+
  theme_bw()

ggplot(prop.press_atl_byyear,aes(x=prop.press,y=detect))+geom_point()+theme_bw()

ggplot() + geom_point(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, colour=as.factor(Year))) +
  #geom_boxplot(data=prop.press_atl_byyear, aes(detect, prop.press)) +
  
  theme_bw()
  
#geom_smooth(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, colour=as.factor(Year)), method="lm") + 
  #geom_text_repel(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, label=River, colour=as.factor(Year)), size=2)

write.csv(prop.press_atl_byyear, "C:/Users/keyserf/Documents/Data/R output/prop.press_atl_byyear_2017-01-20.csv")

          
## bulk years together
### fix names and classes first
colnames(prop.press_atl_byyear)[4:5] <- c("Lat", "Long")
str(prop.press_atl_byyear)
prop.press_atl_byyear[,8:10] <- apply(prop.press_atl_byyear[,8:10], 2, function(x) as.numeric(x)) 

# NA's in TotalWild, TotalFarmed and TotalCombined indicate that a propagule pressure was calculated for that year, but that there were no reports of escapees

## I checked, and it's correct to simply add together the PP's to get the overall PP!

prop.press_atl <- ddply(.data=prop.press_atl_byyear, .(River, Lat, Long),
                        summarize,
                        totalfarmed = sum(TotalFarmed, na.rm=T),
                        totalsamp = sum(TotalCombined,na.rm=T),
                        totalprop.press = sum(prop.press))

prop.press_atl$propfarmed <- prop.press_atl$totalfarmed / prop.press_atl$totalsamp

ggplot() + geom_point(data=prop.press_atl, aes(totalprop.press, propfarmed)) +
  theme_bw() +
  geom_smooth(data=prop.press_atl, aes(totalprop.press, propfarmed)) + 
  geom_smooth(data=prop.press_atl, aes(totalprop.press, propfarmed), method="lm", colour="red") + 
  geom_text_repel(data=prop.press_atl, aes(totalprop.press, propfarmed, label=River), size=2)


yearssampled <- ddply(.data=new2, .(River),
                      summarize,
                      effort = length(unique(Year)))

## Bring over bradprops2015 from Bradbury sampling 2015 script too. 

brad2015 <- ddply(.data=bradprops2015, .(River),
                  summarize,
                  totalfarmed = sum(Esc),
                  totalsamp = sum(total))

brad2015[is.na(brad2015)] <- 0

brad2015$propfarmed <- brad2015$totalfarmed / brad2015$totalsamp


```

### Number of escapees per river
```{r}
str(fullreports)

ggplot() + geom_spatial(data=NB.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") + 
  geom_point(data=fullreports, aes(longfinal, latfinal, colour=as.factor(TotalFarmed))) + 
  coord_map() + 
  theme_classic() 


##timereports[timereports$Year.adj==2016 & is.na(timereports$lat1)=="FALSE",]$detected <- 0

# timereports$count <- as.numeric(as.character(timereports$TotalFarmed))

# names(timereports)
# 
# perry <- data.frame(River=c("Little.River", "Garnish.River", "Simmons.Brook"), Year.adj=c(2013, 2013, 2012), ProvState=rep("NL", 3), TotalFarmed=c(5,26,12), latfinal1=c(47.79706,  47.23734, 47.63639), longfinal1=c(-55.80285, -55.35724, -55.4572), detected=c(1,1,1))
# 
# timereports2 <- join(timereports,perry, type="full")
# 
# bradmore <- data.frame(River=c("Garnish.River", "Garnish.River"),
#                        Year.adj=c(2015, 2016),
#                        ProvState=rep("NL",2),
#                        TotalFarmed=c(4,3),
#                        latfinal1=rep(47.23734,2),
#                        longfinal1=rep(-55.35724,2),
#                        detected=rep(1,2))
# 
# timereports2 <- join(timereports2, bradmore, type="full")
# 
# timereports2$count <- as.numeric(as.character(timereports2$TotalFarmed))

fullreports$count <- as.numeric(as.character(fullreports$TotalFarmed))

alldetections <- ddply(.data=fullreports, .(River, longfinal1, latfinal1, detected),
                    summarise,
                    totalfarmed = sum(count, na.rm=T),
                    minyear = min(Year.adj, na.rm=T),
                    maxyear = max(Year.adj, na.rm=T))

eastland <- fortify(east)

ggplot() + 
  geom_polygon(data=eastland, aes(long, lat, group=group), fill="grey") + ### canvec spatialpolygonsdataframe
  # geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  # geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  # scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  # geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  # #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  # annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  # annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  # annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") + 
 geom_point(data=alldetections[alldetections$detected==0.5 | alldetections$detected==0,], aes(longfinal1, latfinal1, fill=as.factor(detected)), shape=21, size=2) +
  geom_point(data=alldetections[alldetections$totalfarmed>0,], aes(longfinal1, latfinal1, size=totalfarmed), shape=21, fill="red2") + 
  scale_fill_manual(values=c("springgreen3", "gold"), labels=c("None detected", "Detected (no count)"), name=NULL)+
  scale_size(name="Number detected", range=c(2,12), breaks=c(100, 2500, 5000, 7000), limits=c(1,7000)) +
  theme_classic() +
  theme(plot.background=element_rect(fill="white"), panel.border=element_rect(fill=NA, colour="black"))+
  coord_map(xlim=c(-71, -52), ylim=c(43, 52)) +
  guides(size=guide_legend(order=1),
         fill=guide_legend(order=2)) +
  ylab("Latitude") +
  xlab("Longitude") +
  ggsn::scalebar(data=eastland, dist=100, dd2km=TRUE, model="WGS84", location="bottomright", anchor=c(x = -54, y = 44), st.size=3) +
  #ggtitle("Reports of escaped farmed salmon in rivers")

  

```

### using AQpress
```{r}


annual <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NL annual inventory and coords_summary_2016-11-29.csv")
NB_inv <- read.csv("C:/Users/keyserf/Documents/Data/R output/NB_inv.csv")
NSinv <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS Inventory.csv")
head(annual)
head(NB_inv)
head(NSinv)
head(NSsitecoords)

# NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS I&T/NS IT sites_FK_EP_FK.csv", header=TRUE)
# NSsitecoords <- unique(subset(NSsitecoords, is.na(Lat)=="FALSE", select=c("Site.ID","Lat", "Long")))
# NSsitecoords[13, 3:2] <- c(-65.74858, 44.65102)
# NSsitecoords[1, 3:2] <- c(-64.32808,  44.41282)
# NSsitecoords[6, 3:2] <- c(-60.84400, 45.67315)
# NSsitecoords[10, 3:2] <- c(-60.84400, 45.67315)
# NSsitecoords[2, 3:2] <- c(-60.97440, 45.99829)

names(annual) <- c("X", "Site.ID", "Year", "totalfish", "Lat", "Long")
names(NB_inv) <- c("X", "Site.ID", "Year", "totalfish", "Long", "Lat")

sitecoords_atl <- read.csv("C:/Users/keyserf/Documents/Data/R output/sitecoords_atl.csv")
fullreports <- read.csv("C:/Users/keyserf/Documents/Data/R output/fullreports.csv")
reportlocs <- read.csv("C:/Users/keyserf/Documents/Data/R output/reportlocs.csv")
head(fullreports)
head(reportlocs)

devtools::install_github("freyakeyser/AQpress")
require(AQpress)

NSsitecoords$prov <- "NS"
NB_inv$prov <- "NB"
annual$prov <- "NL"

NSinv <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS Inventory.csv")
NSinv$prov <- "NS"

# AQsites1 <- rbind(unique(annual[,c(2,5:7)]), unique(NB_inv[,c(2,6:5,7)]), unique(NSsitecoords[,c(1:3,4)]))
inventory1 <- rbind(annual[,c(2,5,6,3,7,4)], NB_inv[,c(2,6,5,3,7,4)], NSinv[,c(2,4,5,3,7,6)])
inventory1 <- subset(inventory1, Year>2004 & Year<2016)

# AQsites1[AQsites1$Site.ID=="189"  & AQsites1$prov=="NL", 3:2] <- c(-55.86193, 47.73514)
# AQsites1[AQsites1$Site.ID=="239"  & AQsites1$prov=="NL", 3:2] <- c(-55.82891, 47.54275)
# AQsites1[AQsites1$Site.ID=="637"  & AQsites1$prov=="NL", 3:2] <- c(-55.82891, 47.54275)
# AQsites1[AQsites1$Site.ID=="199"  & AQsites1$prov=="NL", 3:2] <- c(-55.33238, 47.65957)

names(reportlocs) <- c("X", "River", "Lat", "Long")

## for all reports
calcAQpress(AQsites = sitecoords_atl[is.na(sitecoords_atl$Long)=="FALSE",], inventory = inventory1[is.na(inventory1$Long)=="FALSE",], rivercoords = reportlocs, inputRast = TRUE, rastName = ATLrast2, dir="C:/Users/keyserf/Documents/Data/R output", saveRast=FALSE, distType="weightedDist")


timereports[timereports$River=="Bay.du.Nord.River",]$River<- "Bay.Du.Nord"
timereports[timereports$River=="Bay.Du.Nord",]$latfinal1 <- 47.7050
timereports[timereports$River=="Bay.Du.Nord",]$longfinal1 <- -55.42238

subreports <- subset(timereports, Year.adj>2004 & Year.adj < 2016)

detectionssub <- ddply(.data=subreports, .(Year.adj, River, latfinal1, longfinal1, ProvState),
                       summarize,
                       total = sum(as.numeric(as.character(TotalFarmed))),
                       PA = max(detected))

annualpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-02-02.csv")
names(annualpp) <- c("X", "Year.adj", "River", "prop.press", "Lat", "Long")
cleandf <- join(detectionssub, annualpp, type="left")

# sampling method

subreports$CountMethod <- as.character(subreports$CountMethod)

subreports[is.na(subreports$CountMethod)==TRUE | subreports$CountMethod=="",]

subreports[subreports$River=="Conne.River",]$CountMethod <-"Fence"
subreports[subreports$River=="Magaguadavic",]$CountMethod <-"Fence"
subreports[subreports$River=="Mitchell.Brook",]$CountMethod <-"Fence"
subreports$CountMethod[subreports$ProvState=="ME"] <-"Fence"
subreports$CountMethod[subreports$CountMethod==" "] <- "Unknown"
subreports[subreports$River%in%c("Bay.Du.Nord", "Garnish.River", "North.West.Brook.1", "Simmons.Brook", "Little.River") & subreports$Year.adj==2015,]$CountMethod <- "Non-fence"
subreports$CountMethod[subreports$River=="Chamcook.Stream" & subreports$Year.adj==2005] <- "Unknown"
subreports$CountMethod[subreports$River=="St..Croix.River" & subreports$Year.adj%in%c(2005, 2006)] <- "Unknown"
subreports$CountMethod[is.na(subreports$CountMethod)==TRUE] <- "Unknown"

subreports$CountMethod <- gsub(pattern="Fishway", replacement="Fence", x=subreports$CountMethod)
subreports$CountMethod <- gsub(pattern="FW", replacement="Fence", x=subreports$CountMethod)
subreports$CountMethod <- gsub(pattern="A", replacement="Non-fence", x=subreports$CountMethod)
subreports$CountMethod <- gsub(pattern="Diver", replacement="Non-fence", x=subreports$CountMethod)
subreports$CountMethod <- gsub(pattern="Dive", replacement="Non-fence", x=subreports$CountMethod)
subreports$CountMethod <- gsub(pattern="CF", replacement="Fence", x=subreports$CountMethod)

detectionssub2 <- ddply(.data=subreports, .(Year.adj, River, latfinal1, longfinal1, ProvState, CountMethod),
                       summarize,
                       total = sum(as.numeric(as.character(TotalFarmed))),
                       PA = max(detected))

colnames(detectionssub2)[1] <- "Year"
names(annualpp)


cleandf2 <- join(detectionssub2, annualpp, type="left")

ggplot() +
  geom_point(data=cleandf2, aes(prop.press, total)) + facet_wrap(~CountMethod) 

ggplot() + geom_point(data=cleandf, aes(prop.press, as.factor(round(PA,0)))) + theme_classic() + ylab("Escapees Detected? (1=Yes, 0=No)") + xlab("Annual propagule pressure") 


avgpp <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-02-03.csv")

cleandfavg <- join(overall, avgpp, type="left")

ggplot() + geom_point(data=cleandfavg[cleandfavg$ProvState%in%c("NS", "NL", "NB") & cleandfavg$CountMethod%in%c("Fence", "Non-fence"),], aes(averagepress, as.factor(round(PA,0)))) + 
  theme_classic() + 
  ylab("Escapees Detected? (1=Yes, 0=No)") + 
  xlab("Average propagule pressure") + 
  facet_wrap(~CountMethod, nrow=2) +
  geom_text_repel(data=cleandfavg[cleandfavg$ProvState%in%c("NS", "NL", "NB") & cleandfavg$CountMethod%in%c("Fence", "Non-fence"),], aes(averagepress, as.factor(round(PA,0)), label=River), size=2)


overall <- ddply(.data=subreports, .(River, CountMethod, ProvState),
                 summarize,
                 PA =  max(detected))


tt = data.frame(table(cleandf$River))
tt[tt$Freq]


ggplot() + geom_boxplot(data = unique(cleandf2[,c(1,2,3,4,5,8,11)]), aes(x = as.factor(PA), y = prop.press)) + facet_wrap(~River)

ggplot() + geom_boxplot(data=unique(cleandf2[,c(1,2,3,4,10)]), aes(x = as.factor(Year), y = prop.press))+ theme_classic() + theme(panel.background=element_rect(colour="black")) +
  xlab("Year (with P/A data)") + ylab("Annual propagule pressure") 

ggplot() + geom_bar(data=unique(cleandf2[,c(1,2,3,4,10)]), aes(x = as.factor(Year), y = prop.press), stat="identity")+ theme_classic() + theme(panel.background=element_rect(colour="black")) +
  xlab("Year (with P/A data)") + ylab("Annual propagule pressure") +
  facet_wrap(~River) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5))

ggplot() + geom_point(data=unique(cleandf2[,c(1,2,3,4,7,8,10)]), aes(prop.press, round(PA,0)))+
  theme_classic() + theme(panel.background=element_rect(colour="black"))

ggplot() + geom_point(data=unique(cleandf2[,c(1,2,3,4,7,8,10)]), aes(prop.press, total, colour=as.factor(Year)))+
  theme_classic() + theme(panel.background=element_rect(colour="black")) +
  #facet_wrap(~Year) + xlab("Annual propagule pressure") +
  ylab("Total escapees detected")


table(cleandf$Year.adj)
cleandf$multpp <- cleandf$prop.press*100

mod1 <- lmer(data=cleandf, total~multpp + (1|Year.adj))
aov(mod1)

require(car)
Anova(mod1)
summary(mod1)

### number of escapes ~ prop.press with random effect for year

ggplot() + geom_point(data=cleandf, aes(multpp, total)) + facet_wrap(~Year.adj) + geom_smooth(data=cleandf, aes(multpp, total), method="lm")

```


## Brendan's hybrids and geographic distance
```{r}
hybrid <- read.csv("C:/Users/keyserf/Documents/Data/R output/forFreya.csv")
names(hybrid)

ggplot() + geom_point(data=hybrid, aes(DistanceToRiver.km..y, pHybNC)) +
  theme_classic() +
  xlab("Distance to River from Green Point Escape (km)") +
  ylab("Proportion assigned to any hybrid class") +
  theme(panel.background=element_rect(colour="black")) +
  geom_smooth(data=hybrid, aes(DistanceToRiver.km..y, pHybNC), method="lm", colour="black")

summary(lm(data=hybrid, pHybNC~DistanceToRiver.km..y))

ggplot() + geom_point(data=hybrid, aes(prop.press.x, pHybNC)) +
  theme_classic() +
  xlab("Distance to River from Green Point Escape (km)") +
  ylab("Proportion assigned to any hybrid class") +
  theme(panel.background=element_rect(colour="black"))



hybrid$River

hybrid$Name <- c()
sfapp <- read.csv("C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_sfa rivers_2005-2015_2017-01-16.csv")
names(rivermouths) <- c("X", "Long", "Lat", "River")
rivermouths$prov <- "NL"

colnames(annual)[2] <- "Site.ID"
annual$prov <- "NL"
annual2 <- annual[,c(2:4,7)]

NLinv2 <- unique(NLinv2)

annual2 <- join(annual2, NLinv2, type="left")
colnames(annual2)[2] <- "Year"

NLrast2 <- rasterAQ 
plot(rasterAQ)
points(NLinv[NLinv$Site.ID==2023,]$Long, NLinv[NLinv$Site.ID==2023,]$Lat)
click()

rivermouths[rivermouths$River=="DLR",c("Lat", "Long")] <- c(47.69051, -56.52707)
rivermouths[rivermouths$River=="GBB",c("Lat", "Long")] <- c(47.11322, -55.74833)

NLinv2 <- NLinv
NLinv2[NLinv2$Site.ID==1079, "Lat"] <- "47.88772" 
NLinv2[NLinv2$Site.ID==1079, "Long"] <-  "-55.8172"
NLinv2[NLinv2$Site.ID==2012, "Lat"] <- "47.57577"
NLinv2[NLinv2$Site.ID==2012, "Long"] <- "-55.78011"
NLinv2[NLinv2$Site.ID==637, "Lat"] <- "47.57577"
NLinv2[NLinv2$Site.ID==637, "Long"] <- "-55.78011"
NLinv2[NLinv2$Site.ID==2023, "Lat"] <- "47.62955"
NLinv2[NLinv2$Site.ID==2023, "Long"]<- "-56.19862"

annual2 <- subset(annual2, Year < 2014)

calcAQpress(AQsites=unique(NLinv2[is.na(NLinv2$Long)==FALSE,]), inventory=annual2[is.na(annual2$Long)==FALSE,], rivercoords=rivermouths,dir = "C:/Users/keyserf/Documents/Data/R output", inputRast = TRUE, saveRast = FALSE, rastName = NLrast2, distType = "weightedDist", stocking = TRUE)

parr <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-02-05_hybrids.csv")

names(parr)
hybrid
hyb2 <- join(hybrid[,c("River", "pHybNC")], parr, type="left")

ggplot() + geom_point(data=hybrid, aes(prop.press.x, pF1NC)) +
  geom_smooth(data=hybrid, aes(prop.press.x, pF1NC), method="lm", colour="black") +
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  xlab("Annual propagule pressure") +
  ylab("Proportion F1")

summary(lm(data=hyb2, pHybNC ~ averagepress))


annual3 <- subset(annual2,Year<2013)

NLinv2$Lat <- as.numeric(NLinv2$Lat)
NLinv2$Long <- as.numeric(NLinv2$Long)

NLinv2 <- subset(NLinv2, is.na(Long)==FALSE)

qsites$prov <- "NL"
qsites$River <- qsites$Code

qsites <- subset(qsites, is.na(Long)==FALSE)
NLQ <- rasterAQ 
dev.off()
plot(NLprovrast)
points(qsites[qsites$River=="SGR",]$Long, qsites[qsites$River=="SGR",]$Lat)

qsites[qsites$River=="GAR",]$Long <- -55.37173
qsites[qsites$River=="GAR",]$Lat <- 47.23617
  
qsites[qsites$River=="BDN",]$Long <- -55.42273
qsites[qsites$River=="BDN",]$Lat <- 47.70221

qsites[qsites$River=="LSR",]$Long <- -53.57658
qsites[qsites$River=="LSR",]$Lat <- 47.10666

qsites[qsites$River=="SGR",]$Long <- -56.8423
qsites[qsites$River=="SGR",]$Lat <- 51.13593

qsites[qsites$River=="CMP",]$Long <- -54.92218
qsites[qsites$River=="CMP",]$Lat <- 49.32593

NLinv2[NLinv2$Site.ID==1072,]$Lat <- 47.77635 
NLinv2[NLinv2$Site.ID==1072,]$Long <- -56.06056

qsites.in <- select(qsites, River, Long, Lat, prov)

calcAQpress(AQsites=unique(NLinv2[is.na(NLinv2$Long)==FALSE,]), inventory=annual3[is.na(annual3$Long)==FALSE,], rivercoords=qsites.in, dir = "C:/Users/keyserf/Documents/Data/R output", inputRast = TRUE, saveRast = FALSE, rastName = NLprovrast, distType = "weightedDist", stocking = TRUE)

qNL <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_avg_2017-02-05_qNL.csv")
qfinal <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-02-05_qNL.csv")
qsites.j <- join(qsites, qNL, type="left")

ggplot() + geom_point(data=qsites.j, aes(averagepress, Q)) + 
  geom_smooth(data=qsites.j, aes(averagepress, Q), method="lm", colour="black") +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  geom_label_repel(data=qsites.j, aes(averagepress, Q, label=River)) +
  xlab("Average propagule pressure")

qfinal <- ddply(.data=qfinal, .(River),
                summarize,
                totalpp = sum(prop.press))

#comparing average to total PP
qs <- join(qNL[,2:7], qfinal, type="left")

ggplot() +
  geom_smooth(data=qs, aes(averagepress, totalpp), method="lm") + 
  geom_point(data=qs, aes(averagepress, totalpp)) + 
  geom_text_repel(data=qs, aes(averagepress, totalpp, label=River), size=2) + theme_classic() +
  xlab("average propagule pressure") +
  ylab("total propagule pressure")





# NSQ and NBQ
names(NSQ)
names(NBQ)
NSQ$prov <- "NS"
NBQ$prov <- "NB"
marq <- join(NSQ, NBQ, type="full")

marq$River <- marq$Code

points(marq[marq$River=="BSR",]$Long, marq[marq$River=="BSR",]$Lat)

marq[marq$River=="BSR",]$Long <- -65.37343
marq[marq$River=="BSR",]$Lat <- 45.3892

calcAQpress(AQsites=sitecoords_atl[!sitecoords_atl$prov=="NL",], inventory=inventory1[inventory1$Year < 2013 & !inventory1$prov=="NL",], rivercoords=marq, dir = "C:/Users/keyserf/Documents/Data/R output", inputRast = TRUE, saveRast = FALSE, rastName = ATLrast2, distType = "weightedDist", stocking = TRUE)

qMAR <- read.csv("C:/Users/keyserf/Documents/Data/R output/prop.press_final_2017-02-06_qMAR2.csv")

qMAR <- ddply(.data=qMAR, .(River),
              summarize,
              totalpp = sum(prop.press))

qsites.mar <- join(marq, qMAR, type="left")

ggplot() + geom_point(data=qsites.mar[!qsites.mar$River %in% c("NSH", "TOB"),], aes(totalpp, Q)) + 
  geom_smooth(data=qsites.mar[!qsites.mar$River %in% c("NSH", "TOB"),], aes(totalpp, Q), method="lm", colour="black") +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  geom_label_repel(data=qsites.mar[!qsites.mar$River %in% c("NSH", "TOB"),], aes(totalpp, Q, label=River)) +
  xlab("Total propagule pressure")

```


### Newfoundland industry production over time
```{r}

head(annual)

production <- ddply(.data=annual, .(ReportYear),
                    summarize,
                    total = sum(totalfish, na.rm=T),
                    nsites = length(unique(ID)))


dev.off()
par(oma=c(0,0,0,3))
plot(production$ReportYear, production$total, ylim=c(5500000, 18000000), type="p", pch=20, axes=0, xlab="Reporting year", ylab=NA)
axis(2, cex.axis=1, labels=T, at=seq(6000000, 18000000, 3000000))
mtext("Production estimate (number of fish)", side=2, line=3)
axis(1, labels=T, at=seq(2005, 2015, 1))
par(new=T)
plot(production$ReportYear, production$nsites, ylim=c(0,50), type="p", axes=0, xlab=NA, ylab=NA)
axis(4, cex.axis=1, at=seq(0,50, 10))
mtext("Number of aquaculture sites", side=4, line=3)
legend(2005,50, legend=c("Production", "Sites"),
       pch=c(20,1))
box(lwd=2)
mtext("Newfoundland aquaculture (2005 - 2015)", side=3, line=1, cex=1.5, lwd=2)

ggplot() + geom_point(data=production, aes(as.factor(ReportYear), total)) + theme_classic() + theme(panel.border=element_rect(colour="black", fill=NA)) +
  ylab("Production estimate (number of fish)\n") +
  xlab("\nReporting Year")
  

sum(annual[annual$ReportYear==2011,]$totalfish)
sum(annual[annual$ReportYear==2010,]$totalfish)
length(annual[annual$ReportYear==2005,]$totalfish)
```

### propagule pressure for brendan March 15, 2017
```{r}
annual2014 <- subset(annual, ReportYear==2014)
names(annual2014) <-c("X", "Site.ID", "Year", "totalfish", "Lat", "Long")
annual2014$prov <-"NL"

year3coords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Year 3 coords.csv")
year3coords$prov <- "NL"

dev.off()
plot(NLrast, xlim=c(-55.5,-55.4), ylim=c(47.7, 47.75))
points(year3coords$Long[year3coords$River=="BDN"], year3coords$Lat[year3coords$River=="BDN"])
#click()
year3coords[year3coords$River=="BDN", 3:2] <- c(-55.41703, 47.7119)


calcAQpress(AQsites = annual2014[is.na(annual2014$Long)=="FALSE",c(2,5,6,7)], inventory = annual2014[is.na(annual2014$Long)=="FALSE",c(2,3,4,5,6,7)], rivercoords = year3coords, inputRast = TRUE, rastName = NLrast, dir="C:/Users/keyserf/Documents/Data/R output", saveRast=FALSE, distType="weightedDist", stocking = TRUE)



annual2013 <- subset(annual, ReportYear==2013)
names(annual2013) <-c("X", "Site.ID", "Year", "totalfish", "Lat", "Long")
annual2013$prov <-"NL"

year3coords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Year 3 coords.csv")
year3coords$prov <- "NL"

dev.off()
plot(NLrast, xlim=c(-55.5,-55.4), ylim=c(47.7, 47.75))
points(year3coords$Long[year3coords$River=="BDN"], year3coords$Lat[year3coords$River=="BDN"])
#click()
year3coords[year3coords$River=="BDN", 3:2] <- c(-55.41703, 47.7119)


calcAQpress(AQsites = annual2013[is.na(annual2013$Long)=="FALSE",c(2,5,6,7)], inventory = annual2013[is.na(annual2013$Long)=="FALSE",c(2,3,4,5,6,7)], rivercoords = year3coords, inputRast = TRUE, rastName = NLrast, dir="C:/Users/keyserf/Documents/Data/R output", saveRast=FALSE, distType="weightedDist", stocking = TRUE)


```


#Escapee detections + genetics
```{r}
fullreports
NLQ <- qsites[,c(1,3,2)] #NL
NSQ #NS
NBQ #NB
names(NLQ) <- c("River", "Q", "Distance")
Qprovs <- rbind(NLQ, NSQ)
colnames(Qprovs)[1] <- "Code"

qsitecoords$Site <- as.character(qsitecoords$Site)

qsitecoords[qsitecoords$Site=="Bay du Nord",]$Site <- "Bay Du Nord"
qsitecoords[qsitecoords$Site=="Conne",]$Site <- "Conne River"
qsitecoords[qsitecoords$Site=="Garnish",]$Site <- "Garnish River"
qsitecoords[qsitecoords$Site=="Salmonier",]$Site <- "Salmonier Brook"
qsitecoords[qsitecoords$Site=="LaHave",]$Site <- "Lahave"
qsitecoords[qsitecoords$Site=="North",]$Site <- "North (CB)"
qsitecoords[qsitecoords$Site=="St Mary's (NS)",]$Site <- "St. Mary's"
colnames(qsitecoords)[1] <- "River"

obsgencomp <- join(fullreports[,c(2,8,14,16,19)], qsitecoords, type="full")
obsgencomp <- subset(obsgencomp, is.na(Code)==FALSE & is.na(detected)==FALSE)
obsgencomp <- join(obsgencomp, Qprovs, type="left")

obsgencomp <- ddply(.data=obsgencomp, .(River, Code, Q),
                    summarize,
                    detected=max(detected),
                    total=sum(count))

a<-ggplot() + geom_point(data=obsgencomp[!obsgencomp$River=="Nashwaak",], aes(Q, detected)) + 
  geom_smooth(data=obsgencomp[!obsgencomp$River=="Nashwaak",], aes(Q, detected), method="lm")+
  theme_classic()
b<-ggplot() + geom_point(data=obsgencomp[!obsgencomp$River=="Nashwaak",], aes(Q, total)) + 
  geom_smooth(data=obsgencomp[!obsgencomp$River=="Nashwaak",], aes(Q, detected), method="lm")+
  theme_classic()

hybrids$River <- c("Bottom Brook", "Conne River", "Dollard", "North West Brook 1", "Garnish River", "Grand Bank Brook", "Grand LaPierre", "Long Harbour", "Salmonier Brook", "Little River", "Mal Bay Brook", "North East Brook", "Old Brook", "Southeast Brook", "Simmons Brook", "Taylors Bay Brook 1", "Terrenceville Brook", "Tailrace")

colnames(hybrids)[1] <- "rivercode"
obshyb <- join(fullreports[,c(2,8,14,16,19)], hybrids, type="full")
obshyb <- subset(obshyb, is.na(rivercode)==FALSE)

obshyb <- ddply(.data=obshyb, .(River, pFarmNC, pWildNC, pHybNC),
                    summarize,
                    detected=max(detected),
                    total=sum(count))

obshyb <- melt(obshyb, id.vars = c("River", "detected", "total"))

c<-ggplot() + geom_point(data=obshyb, aes(value, detected)) + facet_wrap(~variable, nrow=3) +
  theme_classic() + theme(panel.background=element_rect(fill=NA, colour="black"))

d<-ggplot() + geom_point(data=obshyb, aes(value, total)) + facet_wrap(~variable, nrow=3) +
  theme_classic() +theme(panel.background=element_rect(fill=NA, colour="black"))

grid.arrange(a,b)
grid.arrange(c,d, ncol=2)

## try with hybrids too

obsgencomp <- join(fullreports[,c(2,8,14,16,19)], Qprovs, type="full")
names(obsgencomp)




#### Q VALUES

totalpp <- join(totalpp, reportlocs, type="left")

names(DAPC_mean) <- c("Code", "meanX1", "meanX2")
DAPC_mean <- join(DAPC_mean, totalpp, type="left")

NLpp <- ggplot() + geom_point(data=DAPC_mean[DAPC_mean$Long > -60,], aes(total, meanX2)) +
   theme_classic() + theme(panel.background=element_rect(fill=NA, colour="black")) +
  xlab("Propagule pressure (cumulative)") +
  ylab("Mean Q-value from DAPC k=2")

totalep <- join(totalep, reportlocs, type="left")
colnames(totalep)[4] <- "totalesc"
totalep <- totalep[,c(1:4, 6)]
DAPC_mean <- join(DAPC_mean, totalep, type="left")

NLep <- ggplot() + geom_point(data=DAPC_mean[which(DAPC_mean$Long > -60),], aes(totalesc, meanX2)) + theme_classic() + theme(panel.background=element_rect(fill=NA, colour="black")) +
  xlab("Escape event pressure (cumulative)") +
  ylab("Mean Q-value from DAPC k=2") +
  geom_smooth(data=DAPC_mean[which(DAPC_mean$Long > -60),], aes(totalesc, meanX2), method="lm")

grid.arrange(NLpp, NLep, nrow=1)
```