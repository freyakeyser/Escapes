
# Read in packages
```{r}
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
require(ggrepel)
require(scales)
require(ggspatial)
```

-------------------------------------------------------------------------------------------------------------
# SOUTHERN NEWFOUNDLAND CAGE SITE PROPAGULE PRESSSURES 
-------------------------------------------------------------------------------------------------------------

## Newfoundland - read in shapefiles, create raster file
```{r}
annual <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NL annual inventory and coords_summary_2016-11-29.csv")

## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
# NL <- readOGR(dsn = "./R/canvec/canvec_50K_NL_Hydro_shp/waterbody_2_1.shp", layer="waterbody_2_1")
## THIS TAKES WAY TOO LONG, try lower resolution:
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Land/
## NL.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Hydro_shp/waterbody_2.shp", layer="waterbody_2")

# #cropping shapefile to the area and details I need
# NL.low.ocean <- crop(NL.low, extent(-57, -54, 46.8, 48))
# NL.low.ocean <- subset(NL.low.ocean, perm_en=="Permanent")
# writeOGR(obj=NL.low.ocean, dsn="canvec", layer="NL.low.ocean", driver="ESRI Shapefile")
# rm(NL.low)

# read in cropped shapefile: NL.low.ocean
NL.low.ocean <- readOGR(dsn="C:/Users/keyserf/Documents/R/Escapes/canvec/NL.low.ocean.dbf", layer="NL.low.ocean")
# plot(NL.low.ocean)
# points(siterast, pch=16, col="red")

# # creating raster
r <- raster(ncol=1125, nrow=560)
extent(r) <- extent(NL.low.ocean)
NLrast <- rasterize(NL.low.ocean, r, fun="first")

# if shoreline needed:
# NLline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NL_Land_shp/shoreline_1_small.shp", "shoreline_1_small")

# Change values in raster so that land is impassable (i.e. distances would be massive). 

# Also get rid of ocean blob
NLrast@data@values <- ifelse(is.na(NLrast@data@values)=="TRUE", 10000, 1)
NLrast@data@values <- ifelse(coordinates(NLrast)[,1] < -56 & coordinates(NLrast)[,2] < 47.4, 1, NLrast@data@values)

# create transition layer for raster (likelihood of presence within cell). 
tr3 <- transition(1/NLrast, transitionFunction=mean, directions=8)
tr3c <- geoCorrection(tr3, type="c")


# for q value analysis
# creating raster
# r <- raster(ncol=1100, nrow=1160) #(1 grid square ~ 0.5 km2)
# extent(r) <- extent(NLprov)
# NLprovrast <- rasterize(NLprov, r, fun="first")
# 
# # adjust values to make lines impassable
# NLprovrast@data@values <- ifelse(is.na(NLprovrast@data@values)=="TRUE", 10000, 1)
# 
# # create transition layer for raster (likelihood of presence within cell).
# tr3q <- transition(1/NLprovrast, transitionFunction=mean, directions=8)
# tr3cq <- geoCorrection(tr3q, type="c")

# for SFA 10 and 11 scheduled rivers
# read in cropped shapefile: NL.low.ocean
NL.south <- crop(NL.low, extent(-59, -53, 46, 49))

plot(NL.south)

# # creating raster
r <- raster(ncol=920, nrow=552) ## 1 cell = 500m2
extent(r) <- extent(NL.south)
NLsouthrast <- rasterize(NL.south, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive). 

# Also get rid of ocean blob
NLsouthrast@data@values <- ifelse(is.na(NLsouthrast@data@values)=="TRUE", 10000, 1)
NLsouthrast@data@values <- ifelse(coordinates(NLsouthrast)[,1] < -56 & coordinates(NLsouthrast)[,2] < 47.4, 1, NLsouthrast@data@values)
NLsouthrast@data@values <- ifelse(coordinates(NLsouthrast)[,1] < -55 & coordinates(NLsouthrast)[,2] < 46.85, 1, NLsouthrast@data@values)

plot(NLsouthrast)

# create transition layer for raster (likelihood of presence within cell). 
tr3s <- transition(1/NLsouthrast, transitionFunction=mean, directions=8)
tr3cs <- geoCorrection(tr3s, type="c")
```


## Newfoundland - AQ site coordinates and river mouths
```{r}
# site coords

# read in sites from annual NL inventory. Adjust years as desired. Min for NL is 2005, max is 2015. 
sitecoords <- unique(subset(annual, is.na(Lat)=="FALSE", select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# for q values
sitecoords <- unique(subset(annual, is.na(Lat)=="FALSE" & ReportYear<2013, select=c("ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

# # escaped fish location
# escapes <- read.csv("C:/Users/keyserf/Documents/Data/Gillnetting2015 - Master Copy.csv")
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# str(escapes)
# 
# escapes$River <- gsub(escapes$River, pattern="Du", replacement="du")
# names(rivers) <- c("code", "V1", "V2")
# escapelocs <- unique(select(escapes, Latitude..N., Longitude..E.))
# escapemat <- as.data.frame(cbind(escapelocs$Longitude..E., escapelocs$Latitude..N.))
# escapemat <- rbind(escapemat, as.data.frame(rivers[,2:3]))
# escapemat <- as.matrix(escapemat)

## Newfoundland River mouths

## Details for above:
# rivers <- read.csv("C:/Users/keyserf/Documents/Data/river coords.csv")
# 
# ## To get river mouth locations, use click(). Click on the plot to get coords for the river mouths with sampling sites on them.
# plot(NLrast)
# text(rivers[,2], rivers[,3])
# lines(NLline)
# # rivermouths <- SpatialPoints(click(n=18))
# rivermouths <- snapPointsToLines(rivermouths, NLline)
# rivermouths <- fortify(as.data.frame(rivermouths))
# text(rivermouths$X, rivermouths$Y, col="red", labels=1:18)

# For Brendan's river sites:

Bsites <- read.csv("C:/Users/keyserf/Documents/Data/sites_lat_long_brendan.csv", header=TRUE)
# plot(NLrast)
# head(Bsites)
# points(Bsites$V1, Bsites$V2, pch=21, bg="black")
# Bsites <- Bsites[1:18,] 
# Bsites[,1:3] <- apply(Bsites[,1:3], 2, function(x) as.character(x))
# Bsites[,2:3] <- apply(Bsites[,2:3], 2, function(x) as.numeric(x))
#   
# x <- Bsites$V1
# y <- Bsites$V2
# xy <-cbind(x, y)
# Bsiterast <- as.matrix(xy)

## For precise PARR project sampling locations in rivers:

# sampling <- read.csv("C:/Users/keyserf/Documents/Data/Salmon sampling summary 2014.csv", header=TRUE)
# sampling <- select(sampling[1:20,], Location, Latitude, Longitude)
# sampling$code <- c("BTB", "CNR", "CNR", "DLR", "GAR", "GBB", "GLP", "LMS", "LTR", "LHR", "MAL", "NET", "NEB", "FBN", "OBB", "SMB", "SEB", "TRB", "TBB", "TEB")
# sampling <- sampling[-c(2,12),]
# sampling
# 
# plot(NLrast)
# points(sampling$Longitude, sampling$Latitude)
# 
# #rivermouths<- SpatialPoints(click(n=18))
# rivermouths <- data.frame(rivermouths)
# rivermouths <- cbind(rivermouths, Bsites$X)

# write.csv(rivermouths, "C:/Users/keyserf/Documents/Data/Rivers/NL river mouth coords_2016-11-18.csv")
rivermouths <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NL river mouth coords_2016-11-18.csv", header=TRUE)

# for 2015 sampling

# sampling2015 <- rivermouths[rivermouths$code %in%c("GAR", "LTR", "FBN", "SMB"),]
bdn <- data.frame(X=NA, x=-55.42002, y=47.7079, code="BDN")
sampling2015 <- rbind(rivermouths, bdn)

# for SFA 10 and 11 
sched <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NL Scheduled Coordinates.csv")

```

## Newfoundland - Q values coords
```{r}
# read in sites
qsites <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Qvalues_All NL_2016-11-10.csv")
qsites <- qsites[,1:3]

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

qsites <- join(qsites, qsitecoords, type="left")

qsites[qsites$Code=="LHR",]$Long <- -54.94830
qsites[qsites$Code=="LHR",]$Lat <- 47.77960 

qsites[qsites$Code=="BSB",]$Long <- -53.282374
qsites[qsites$Code=="BSB",]$Lat <- 46.756687

qsites[qsites$Code=="WAB",]$Long <- -56.77375
qsites[qsites$Code=="WAB",]$Lat <- 51.21244

qsites[qsites$Code=="NBT",]$Long <- -53.36932
qsites[qsites$Code=="NBT",]$Lat <- 46.74945

qsites[qsites$Code=="NPR",]$Long <- -53.99326
qsites[qsites$Code=="NPR",]$Lat <- 47.24506

qsites[qsites$Code=="GRR",]$Long <- -57.09784
qsites[qsites$Code=="GRR",]$Lat <- 47.56489

qsites[qsites$Code=="CNR",]$Long <- -55.77851
qsites[qsites$Code=="CNR",]$Lat <- 47.86362

qsites[qsites$Code=="RKR",]$Long <- -53.58221
qsites[qsites$Code=="RKR",]$Lat <- 47.18433

# plot(NLprovrast, xlim=c(-57.5, -55.5), ylim=c(47.5, 48))
# text(qsites$Long, qsites$Lat)
```

### Newfoundland - for SFA 10 and 11. Fixing river coords
```{r}
sched <- arrange(sched, Long)

plot(NLsouthrast, xlim=c(-56.2, -55), ylim=c(47.4, 48))
text(sched$Long, sched$Lat)
click(n=3)

southcoords <- rbind(c(-58.12693,47.69343),# cinq cerf 1
c(-58.04176,47.7074),# couteau 2
c(-57.91504,47.706),# connoire 3
c(-57.83610,47.64454),# middle 4
c(-57.68445,47.63476),# grandy 5
c(-57.56812,47.63616),# kingsharbour 6
c(-57.54735,47.64734),# kelly 7
c(-57.54527,47.65013),# bay deloup 8
c(-57.29806,47.76048),# white bear 9
c(-57.10626,47.57051),# grey 10
c(-56.54329,47.70321),# dollard 11
c(-56.51836,47.70740),# morgan 12
c(-56.32932,47.69902),# brent cove 13
c(-56.32101,47.76886),# bottom 14
c(-56.29400,47.70181),# allans cove 15
c(-56.16313,47.86384),# despoir 16
c(-56.15274,47.83451),#hughes 17
c(-56.09250,47.74371),#long reach 18
c(-56.06645,47.77865),# salmon 19
c(-55.86821,46.87000),# pierceys 20
c(-55.83767,47.88911 ),# northwest 21
c(-55.82535,47.08279),#fortune 22
c(-55.77261,46.86104),# salmonier river 23
c(-55.74623,47.10743),# grand bank 24
c(-55.76058,47.91923 ),#southeast 25
c(-55.71657,46.86776),#taylor bay brook 26
c(-55.80285,47.79706 ),# little brook 27
c(-55.76804,47.86400 ),# conne 28
c(-55.67354,47.66986),# salmonier 29
c(-55.63624,47.54434 ),# taylors bay 30
c(-55.60889,47.55438 ),#old brook 31
c(-55.54844,46.91255),#little lawn 32
c(-55.49240,46.91927),#lawn 33
c(-55.45720,47.63639),#simms 34
c(-55.45720,47.63639 ),# salmon 35
c(-55.46466,47.61965),# southwest 36
c(-55.42238,47.70501),#bay du nord 37
c(-55.39005,47.72007 ),#northwest 38
c(-55.34075,46.91031),#little st. lawrence 39
c(-55.37016,47.72007),#north east 40
c(-55.35724,47.23734),#garnish 41
c(-55.32097,47.26870),# devil 42
c(-55.32789,47.65982),#belle harbour 43
c(-55.12977,47.17238),#west 44
c(-55.12977,47.17238),#tides 45
c(-55.18252,47.04919),#big salmonier 46
c(-55.21101,47.62635),#Rencontre 47
c(-55.13392,47.65982),#mal bay 48
c(-54.98913,47.27766),#red harbour 49
c(-54.98913,47.27766),#northeast 50
c(-54.96263,47.76526),# long harbour 51
c(-54.96263,47.76526),#southwest 52
c(-54.91001,47.33814),#rushoon 53 
c(-54.81112,47.39189),#bay de leau 54
c(-54.78110,47.66819),#grande la pierre 55
c(-54.73200,47.37845),#cape roger 56
c(-54.72390,47.67154),#terrenceville 57
c(-54.68914,47.38965),#nonsuch 58
c(-54.44787,47.57112),#black 59
c(-54.44787,47.57112),#paradise 60
c(-54.30613,47.67656),#sandy harbour 61
c(-54.21163,47.87405),#pipers hole 62
c(-54.18476,46.95063),#cuslett 63
c(-54.18428,47.87405),#black 64
c(-54.08508,47.87512),#watsons 65
c(-54.08508,47.87512),#north harbour 66
c(-54.07927,47.12758),#great barasway 67
c(-54.05394,47.18806),#little barasway 68
c(-54.00662,47.82529),#come by chance 69
c(-53.97812,47.24182),#southeast 70
c(-53.97812,47.24182),#shalloway 71
c(-53.90230,47.34486),#ship harbour 72
c(-53.92867,47.31126),#placentia sound 73
c(-53.96823,47.24854))# northeast 74

sched <- cbind(sched, southcoords)
names(sched) <-c("Prov", "SFA", "Name", "Long.1", "Lat.1", "Long", "Lat")
sched$Number <- c(1:74)
```

### Newfoundland - Fix some AQ site coords
```{r}
# for 2013 only:
# plot(NLrast, xlim=c(-56.0, -55.5), ylim=c(47.4, 47.6))
# points(siterast[12,1], siterast[12,2], col="blue")
# siterast[12,] <- c(-55.58610, 47.51435)
# make site 12 = -55.58610 and 47.51435

# for 2010-2015 years:
# plot(NLrast)
# points(siterast[17,1], siterast[17,2])
# siterast[17,] <- click()
## make site 17 = -56.06074 and 47.77717
# siterast[17,] <- c(-56.06074, 47.77717)
# points(siterast[30,1], siterast[30,2])
# siterast[30,] <- click()
# siterast[30,] <- c(-55.78194, 47.57588)
## make site 30 = -55.78194 and 47.57588

# for all years (2005-2015):
plot(NLrast, xlim=c(-56.25, -55.5), ylim=c(47.5, 47.8))
points(siterast[19,1], siterast[19,2])

siterast[19,] <- c(-56.0205, 47.80122) 
siterast[37,] <- c(-55.76244, 47.59899)
siterast[48,] <- c(-55.76244, 47.59899)

# for q values (2005-2013) entire prov:
# plot(NLprovrast, xlim=c(-56.5, -55.5), ylim=c(47.5, 48))
# text(siterast[,1], siterast[,2])
siterast[18,] <- c(-56.06056, 47.77635)
# siterast[32,] <- c(-55.79204, 47.58395)
# siterast[43,] <- c(-55.79204, 47.58395)
# siterast[35,] <- c(-55.77543, 47.59184)
# siterast[48,] <- c(-55.77543, 47.59184)


```


## Newfoundland - calculate distance matrix
```{r}
# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d3 <- costDistance(tr3c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(rivermouths[,2]), as.numeric(rivermouths[,3])))

d3

# Q value coords
# d3q <- costDistance(tr3cq, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(qsites[,5]), as.numeric(qsites[,6])))
# 
# d3q

# SFA coords
# d3s <- costDistance(tr3cs, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(sched$Long), as.numeric(sched$Lat)))
# 
# d3s
```


## Newfoundland - merge with site coords and inventory data
```{r}
d3 <- as.data.frame(cbind(d3, sitecoords$ID))
colnames(d3)[19] <- "ID"
colnames(d3)[1:18] <- as.list(as.character(rivermouths$code))


# q values
# d3q <- as.data.frame(cbind(d3q, sitecoords$ID))
# colnames(d3q)[16] <- "ID"
# colnames(d3q)[1:15] <- as.list(as.character(qsites$Code))

# sfa values
# d3s <- as.data.frame(cbind(d3s, sitecoords$ID))
# colnames(d3s)[75] <- "ID"

```


## Newfoundland - pick the years you want and summarize
```{r}
dist2AQ_sub <- subset(annual, ReportYear >2003 & ReportYear<2016 & is.na(Lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(ID, Lat, Long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d3, dist2AQ_sub, type="left")
#dist2AQ <- join(d3s, dist2AQ_sub, type="left")
#dist2AQ <- join(d3q, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub <- subset(annual, ReportYear >2001 & ReportYear<2013 & is.na(Lat)==FALSE)
dist2AQ_sub_NL <- ddply(.data=dist2AQ_sub, .(ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(ReportYear)))
dist2AQ <- join(d3q, dist2AQ_sub_NL, type="left")
dist2AQ_NL <- subset(dist2AQ, is.na(totalfish)==FALSE)

```


## Newfoundland - Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.character(x))
dist2AQ[,1:18] <- apply(dist2AQ[,1:18], 2, function(x) as.numeric(x))

# q values
# dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.character(x))
# dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BTB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$DLR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GBB
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$GLP
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$LMS
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$LTR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$MAL
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$NEB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$FBN
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$OBB
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$SMB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$SEB
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$TRB
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$TBB
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$TEB

# for sampling 2015 also do
dist2AQ$P19 <- dist2AQ$totalfish/dist2AQ$BDN

# q values
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$GAR
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$BDN
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$CNR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$LHR
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$GRR
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$LPR
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$NPR
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$RKR
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$LSR
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$NBT
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$BSB
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$STP
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$SGR
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$WAB
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$CMP

# sfa's
dist2AQ[,1:74] <- apply(dist2AQ[,1:74], 2, function(x) as.character(x))
dist2AQ[,1:74] <- apply(dist2AQ[,1:74], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$V1
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$V2
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$V3
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$V4
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$V5
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$V6
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$V7
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$V8
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$V9
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$V10
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$V11
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$V12
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$V13
dist2AQ$P14 <- dist2AQ$totalfish/dist2AQ$V14
dist2AQ$P15 <- dist2AQ$totalfish/dist2AQ$V15
dist2AQ$P16 <- dist2AQ$totalfish/dist2AQ$V16
dist2AQ$P17 <- dist2AQ$totalfish/dist2AQ$V17
dist2AQ$P18 <- dist2AQ$totalfish/dist2AQ$V18
dist2AQ$P19 <- dist2AQ$totalfish/dist2AQ$V19
dist2AQ$P20 <- dist2AQ$totalfish/dist2AQ$V20
dist2AQ$P21 <- dist2AQ$totalfish/dist2AQ$V21
dist2AQ$P22 <- dist2AQ$totalfish/dist2AQ$V22
dist2AQ$P23 <- dist2AQ$totalfish/dist2AQ$V23
dist2AQ$P24 <- dist2AQ$totalfish/dist2AQ$V24
dist2AQ$P25 <- dist2AQ$totalfish/dist2AQ$V25
dist2AQ$P26 <- dist2AQ$totalfish/dist2AQ$V26
dist2AQ$P27 <- dist2AQ$totalfish/dist2AQ$V27
dist2AQ$P28 <- dist2AQ$totalfish/dist2AQ$V28
dist2AQ$P29 <- dist2AQ$totalfish/dist2AQ$V29
dist2AQ$P30 <- dist2AQ$totalfish/dist2AQ$V30
dist2AQ$P31 <- dist2AQ$totalfish/dist2AQ$V31
dist2AQ$P32 <- dist2AQ$totalfish/dist2AQ$V32
dist2AQ$P33 <- dist2AQ$totalfish/dist2AQ$V33
dist2AQ$P34 <- dist2AQ$totalfish/dist2AQ$V34
dist2AQ$P35 <- dist2AQ$totalfish/dist2AQ$V35
dist2AQ$P36 <- dist2AQ$totalfish/dist2AQ$V36
dist2AQ$P37 <- dist2AQ$totalfish/dist2AQ$V37
dist2AQ$P38 <- dist2AQ$totalfish/dist2AQ$V38
dist2AQ$P39 <- dist2AQ$totalfish/dist2AQ$V39
dist2AQ$P40 <- dist2AQ$totalfish/dist2AQ$V40
dist2AQ$P41 <- dist2AQ$totalfish/dist2AQ$V41
dist2AQ$P42 <- dist2AQ$totalfish/dist2AQ$V42
dist2AQ$P43 <- dist2AQ$totalfish/dist2AQ$V43
dist2AQ$P44 <- dist2AQ$totalfish/dist2AQ$V44
dist2AQ$P45 <- dist2AQ$totalfish/dist2AQ$V45
dist2AQ$P46 <- dist2AQ$totalfish/dist2AQ$V46
dist2AQ$P47 <- dist2AQ$totalfish/dist2AQ$V47
dist2AQ$P48 <- dist2AQ$totalfish/dist2AQ$V48
dist2AQ$P49 <- dist2AQ$totalfish/dist2AQ$V49
dist2AQ$P50 <- dist2AQ$totalfish/dist2AQ$V50
dist2AQ$P51 <- dist2AQ$totalfish/dist2AQ$V51
dist2AQ$P52 <- dist2AQ$totalfish/dist2AQ$V52
dist2AQ$P53 <- dist2AQ$totalfish/dist2AQ$V53
dist2AQ$P54 <- dist2AQ$totalfish/dist2AQ$V54
dist2AQ$P55 <- dist2AQ$totalfish/dist2AQ$V55
dist2AQ$P56 <- dist2AQ$totalfish/dist2AQ$V56
dist2AQ$P57 <- dist2AQ$totalfish/dist2AQ$V57
dist2AQ$P58 <- dist2AQ$totalfish/dist2AQ$V58
dist2AQ$P59 <- dist2AQ$totalfish/dist2AQ$V59
dist2AQ$P60 <- dist2AQ$totalfish/dist2AQ$V60
dist2AQ$P61 <- dist2AQ$totalfish/dist2AQ$V61
dist2AQ$P62 <- dist2AQ$totalfish/dist2AQ$V62
dist2AQ$P63 <- dist2AQ$totalfish/dist2AQ$V63
dist2AQ$P64 <- dist2AQ$totalfish/dist2AQ$V64
dist2AQ$P65 <- dist2AQ$totalfish/dist2AQ$V65
dist2AQ$P66 <- dist2AQ$totalfish/dist2AQ$V66
dist2AQ$P67 <- dist2AQ$totalfish/dist2AQ$V67
dist2AQ$P68 <- dist2AQ$totalfish/dist2AQ$V68
dist2AQ$P69 <- dist2AQ$totalfish/dist2AQ$V69
dist2AQ$P70 <- dist2AQ$totalfish/dist2AQ$V70
dist2AQ$P71 <- dist2AQ$totalfish/dist2AQ$V71
dist2AQ$P72 <- dist2AQ$totalfish/dist2AQ$V72
dist2AQ$P73 <- dist2AQ$totalfish/dist2AQ$V73
dist2AQ$P74 <- dist2AQ$totalfish/dist2AQ$V74

# sum all pressures for total propagule pressure at a river
prop.press_all <- apply(as.matrix(dist2AQ[,23:40]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_all <- data.frame(code=rivermouths$code, lat=rivermouths[,3], long = rivermouths[,2], prop.press = prop.press_all)

prop.press_201415 <- data.frame(code=sampling2015$code, lat=sampling2015[,3], long = sampling2015[,2], prop.press = prop.press_all)

write.csv(prop.press_all, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_all years_2016-12-01.csv")
write.csv(prop.press_201415, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_20142015_2016-12-15.csv")

# sum all pressures for total propagule pressure at Q value river
# prop.press_q <- apply(as.matrix(dist2AQ[,20:34]), 2, function(x) sum(x, na.rm=TRUE))
# 
# # match to river mouth coords
# prop.press_q <- data.frame(Code=qsites$Code, lat=qsites[,6], long = qsites[,5], prop.press = prop.press_q)
# 
# write.csv(prop.press_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_qvalues_2005-2012_2016-12-06.csv")



# sum all pressures for total propagule pressure at SFA value river
# prop.press_sfa <- apply(as.matrix(dist2AQ[,79:152]), 2, function(x) sum(x, na.rm=TRUE))
# 
# # match to river mouth coords
# prop.press_sfa <- data.frame(Code=sched$Number, lat=sched$Lat, long = sched$Long, prop.press = prop.press_sfa)
# 
# write.csv(prop.press_sfa, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_sfa rivers_2005-2015_2017-01-16.csv")

```


## Newfoundland - plot propagule pressure
```{r}
dist2AQ_sub_plot <- subset(dist2AQ_sub, totalfish > 0)
dist2AQ_sub_plot$Lat <- as.numeric(dist2AQ_sub_plot$Lat)
dist2AQ_sub_plot$Long <- as.numeric(dist2AQ_sub_plot$Long)

prov <- fortify(NL.low.ocean)
#prov <- fortify(NL.south)

prov$group <- ifelse(prov$long < -56.2 & prov$lat < 47.375, 4771.1, prov$group)

dist2AQ_sub_plot <- arrange(dist2AQ_sub_plot, -totalfish)
prop.press_sfa <- arrange(prop.press_sfa, -prop.press)

plot1 <- ggplot() + 
  ggtitle("Aquaculture sites")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+ 
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=dist2AQ_sub_plot, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(1,5250000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000, 5250000))

plot2 <- ggplot() + 
  ggtitle("SFA 10 and 11: Propagule pressure (2005-2015)")+
  geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-57, xmax=-56, ymin=46.8, ymax= 47.45, fill="grey") +
  geom_point(data=prop.press_all, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() +  coord_map(xlim=c(-56.7, -54.5), ylim=c(46.82, 48)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #scale_size_area(name="\u03A3(totalfish/d)", breaks=seq(50, 4000, 500)) +
  #scale_size_continuous(name="Propagule pressure=\n\u03A3(total fish^-0.0012*dist)", range = c(0.5,8), limits=c(5,25), breaks=c(5,10,15,20,25))
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,17500), breaks=c(500, 1000, 5000, 10000, 15000, 17500))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))
### PNG 1500*600


```

## Newfoundland - Q value analysis
```{r}
qsites <- join(qsites, prop.press_q[,c(1,4)], type="left") 

require(ggrepel)

ggplot() + 
  geom_smooth(data=qsites, aes(prop.press, Q), method="lm", se=TRUE) +
  geom_point(data=qsites, aes(prop.press, Q)) +
  geom_label_repel(data=qsites, aes(prop.press, Q, label=Code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  ggtitle("2005-2012")+
  xlab("Propagule pressure") +
  ylab("Q value") 

summary(lm(data=qsites, Q~prop.press))

prop.press_q<- arrange(prop.press_q, -prop.press)

ggplot() + 
  ggtitle("Q values") +
  geom_spatial(data=NL.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatial with grey
  #geom_path(data=CA.NL, aes(long, lat, group=group),colour="black") + ### black outline
  annotate(geom="rect", xmin=-60, xmax=-56.5, ymin=46.5, ymax= 47.25, fill="grey") + ### hides stupid white spaces
  annotate(geom="rect", xmin=-60, xmax=-56.1, ymin=46.5, ymax= 47.4, fill="grey") +
  annotate(geom="rect", xmin=-60, xmax=-59.42, ymin=46.5, ymax= 50.21, fill="grey")+
  annotate(geom="rect", xmin=-56.1, xmax=-55.9, ymin=46.5, ymax= 46.83, fill="grey") +
  annotate(geom="rect", xmin=-54, xmax=-52.2, ymin=50, ymax= 51.8, fill="grey") +
  coord_map(xlim=c(-59.9, -52.3), ylim=c(46.52, 51.79)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_point(data=prop.press_q, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  geom_label_repel(data=prop.press_q, aes(long, lat, label=Code), size=3, point.padding = unit(0.5,"lines"))

```

### SFA plots
```{r}

### SFA 10-11 plot
ggplot() + geom_polygon(data=prov, aes(long, lat, group=group), fill="grey")+
  annotate(geom="rect", xmin=-59, xmax=-56.0, ymin=46.5, ymax= 47.4, fill="grey") +
  annotate(geom="rect", xmin=-56, xmax=-55, ymin=46.5, ymax= 46.8, fill="grey") +
  coord_map(xlim=c(-58, -53.5), ylim=c(46.6, 48.2)) +
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  geom_point(data=prop.press_sfa, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  scalebar(data=fortify(NL.south), dist=25, dd2km=TRUE, model="WGS84", location="bottomleft", anchor=c(x = -57.75, y = 46.88), st.size=3) +
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,20000))+
  ggtitle("SFAs 10 and 11")


names(prop.press_sfa) <- c("Number", "lat", "long", "prop.press")

sched

prop.press_sfa <- join(prop.press_sfa, sched, type="left")

prop.press_sfa <- select(prop.press_sfa, Prov, SFA, Name, Number, lat, long, prop.press)

prop.press_sfa$Name <- factor(prop.press_sfa$Name, levels=prop.press_sfa$Name[order(prop.press_sfa$Number)], ordered=TRUE)

ggplot() + geom_point(data=prop.press_sfa, aes(prop.press, Name)) + facet_grid(SFA~., scales="free_y", space="free") +
  theme_bw() + 
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  xlab("Propagule pressure (2005-2015)") +
  ylab("River name")
  
  
```


---------------------------------------------------------------------------------------------------------------------
# NOVA SCOTIA CAGE SITE PROPAGULE PRESSURES ---------------------------------------------------------------------------------------------------------------------

## Nova Scotia - shapefile prep
```{r}

# NS.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NS_Hydro_shp/waterbody_2.shp", layer="waterbody_2")
NS.low <- crop(NS.low, extent(-67, -59.5, 43.3, 47.5))
#plot(NS.low)

# creating raster
r <- raster(ncol=1110, nrow=930)
extent(r) <- extent(NS.low)
NSrast <- rasterize(NS.low, r, fun="first")

# Also get rid of ocean blob
NSrast@data@values <- ifelse(is.na(NSrast@data@values)=="TRUE", 100000, 1)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -64.5 & coordinates(NSrast)[,2] < 44, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -61 & coordinates(NSrast)[,2] < 45, 1, NSrast@data@values)
NSrast@data@values <- ifelse(coordinates(NSrast)[,2] >47.2, 1, NSrast@data@values)

# Canso causeway is impassable
NSrast@data@values <- ifelse(coordinates(NSrast)[,1] > -61.42577 & coordinates(NSrast)[,1] < -61.414002 & coordinates(NSrast)[,2] > 45.641238 & coordinates(NSrast)[,2] < 45.647156, 100000, NSrast@data@values)

# create transition layer for raster (likelihood of presence within cell). 
tr5 <- transition(1/NSrast, transitionFunction=mean, directions=8)
tr5c <- geoCorrection(tr5, type="c")

```


## Nova Scotia - AQ site coordinates and rivermouths
```{r}
# read in sites from I&T file. Adjust years as desired. Min for NS is 1999, max is 2015. 
NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS I&T/NS IT sites_FK_EP_FK.csv", header=TRUE)
sitecoords <- unique(subset(NSsitecoords, is.na(Lat)=="FALSE", select=c("Site.ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)
test <- click()
siterast[13,] <- c(-65.74858, 44.65102)
siterast[1,] <- c(-64.32808,  44.41282)
siterast[6,] <- c(-60.84400, 45.67315)
siterast[10,] <- c(-60.84400, 45.67315)
siterast[2,] <- c(-60.97440, 45.99829)

plot(NSrast) , xlim=c(-61.25, -60.9), ylim=c(45.9, 46.1))
text(siterast[,1], siterast[,2], col="red")

# # escaped fish location from Escapes_2016-10-07 morris df
morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nsrivers <- as.data.frame(unique(morris$River[morris$Prov=="NS"]))
names(nsrivers) <- c("river")
#nsrivers
coords_clean <- rbind(c(-65.59265, 44.69787), # Annap
c(-60.86494, 46.06677),# Baddeck
c(-65.69013, 44.61802), #Bear
c(-60.79996, 45.86143), #BRas
c(-64.22795, 45.12565), #Gasp
c(-60.61312, 45.59906), #Grand
c(-64.09798, 45.39943), #Harr
c(-60.57251, 46.26069), #Indian
c(-64.34167, 44.28720), #Lahave
c(-61.99407, 45.00587), #Liscomb
c(-61.11676, 46.44321), #Marg
c(-64.65848, 44.03053), # Mersey
c(-66.16127, 44.23016), #Meteghan
c(-60.88931, 46.05536), #MIddle
c(-65.60077, 44.69787), #Nict
c(-60.58063, 46.23217), #North
c(-64.30106, 45.37091), # Parrs
c(-63.54560, 44.62372), #Sack
c(-66.18564, 44.05905), #Salmon
c(-60.93805, 46.01543), #skye
c(-63.48874, 45.33098), #Stew
c(-60.50752, 46.36336), #St. Ann
c(-61.86410, 45.02298), #St. mary
c(-65.95007, 43.76246), #Tusket
c(-60.93805, 46.01543)) #Why 

nsrivers <- cbind(nsrivers, coords_clean)
nsrivers$river <- as.character(nsrivers$river)

names(nsrivers) <- c("River", "long", "lat")

nsrivers$code <- as.character(c("APR", "BAD", "BRR", "BRA", "GAK", "GRA", "HAR", "IND", "LAH", "LIS", "MGR", "MER", "MET", "MID", "NIC", "NRV", "PAR", "SAC", "SAD", "SKY", "STW", "STA", "SMA", "TUS", "WHY"))

# nsmorris <- subset(morris, ProvState=="NS")
# nsmorris <- join(nsmorris, nsrivers, type="left")
# 
# unique(nsmorris$TotalFarmed)
# 
# nsmorris_true <- subset(nsmorris, !TotalFarmed =="0", select=c("River", "lat", "long", "TotalFarmed"))
# nsmorris_true <- subset(nsmorris_true, !TotalFarmed =="N/A")
# nsmorris_true <- unique(nsmorris_true[,1:3])


# Q value rivers NS

# for q-values
NSQ <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NS Q values.csv", header=TRUE) 
head(NSQ)

names(NSQ) <- c("Code", "Q", "Distance")

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

NSQ <- join(NSQ, qsitecoords, type="left")
NSQ <- NSQ[!is.na(NSQ$Lat)==TRUE,]
NSQ <- subset(NSQ, !Region %in% c("Southern Quebec", "Gaspesie", "Anticosti", "North Shore upper", "North Shore Lower"))
NSQ <- subset(NSQ, !Site %in% c("Cap Chat", "Cross", "Big Salmon", "Jacquet", "Miramichi", "Nashwaak", "Tobique"))

NSQ[1, 5:6] <- c(-61.91332, 45.64064)
NSQ[2, 5:6] <- c(-60.59093, 45.93392)
NSQ[3, 5:6] <- c(-64.27549, 45.12792)
NSQ[4, 5:6] <- c(-64.34658, 44.27382)
NSQ[5, 5:6] <- c(-64.57827, 44.13918)
NSQ[6, 5:6] <- c(-61.12861, 46.44463)
NSQ[7, 5:6] <- c(-63.38684, 45.35512)
NSQ[8, 5:6] <- c( -60.58367, 46.25754)
NSQ[9, 5:6] <- c(-61.92785, 45.02375)
NSQ[10, 5:6] <- c(-63.48755, 45.32147)

```


### Nova Scotia - Fix some river coords
```{r}
# make nictaux = to annapolis
# nsrivers[15,3] <- nsrivers[1,3]
# nsrivers[15,2] <- nsrivers[1,2]
# 
# # for all years:
# # plot(NSrast, xlim=c(-61, -60), ylim=c(46, 47))
# # text(nsrivers[16,3], nsrivers[16,2], col="red")
# nsrivers[16,2:3] <- c(46.26345, -60.59543)
# plot(NSrast, xlim=c(-62.5, -62), ylim=c(44.75, 45.25))
# # text(nsrivers[,3], nsrivers[,2], col="red")
# nsrivers[10,2:3] <- c(45.024369, -61.989859)
```


## Nova Scotia - Transition layer, Geocorrection, calculate distance matrix
```{r}

# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d5 <- costDistance(tr5c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(nsrivers[,2]), as.numeric(nsrivers[,3])))

d5

# for Q value analysis
# d5q <- costDistance(tr5c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(NSQ[,5]), as.numeric(NSQ[,6])))

# d5q

```


## Nova Scotia - Merge with site coords and inventory data
```{r}
colnames(sitecoords)[1] <- "Site.ID"
d5 <- as.data.frame(cbind(d5, sitecoords$Site.ID))
colnames(d5)[26] <- "Site.ID"
colnames(d5)[1:25] <- as.list(as.character(nsrivers$code))

dist2AQ_NS <- join(d5, sitecoords, type="left")


# Add distance to upstream rivers (NS -  Nictaux is 65 km upstream from assigned "rivermouth" location)

dist2AQ_NS$NIC <- dist2AQ_NS$NIC + 65000
# NIC was not a q-value river

# for q values

colnames(sitecoords)[1] <- "Site.ID"
d5q <- as.data.frame(cbind(d5q, sitecoords$Site.ID))
colnames(d5q)[11] <- "Site.ID"
colnames(d5q)[1:10] <- as.list(as.character(NSQ$Code))

dist2AQ_NS <- join(d5q, sitecoords, type="left")

```


## Nova Scotia - pick the years you want and summarize
```{r}
NSinv <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS Inventory.csv")
names(NSinv)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")

dist2AQ_sub_NS <- subset(NSinv, Year >1998 & Year<2016 & is.na(Lat)==FALSE)
dist2AQ_sub_NS <- ddply(.data=dist2AQ_sub_NS, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d5, dist2AQ_sub_NS, type="left")
# q value
dist2AQ <- join(d5q, dist2AQ_sub_NS, type="left")

dist2AQ_NS <- subset(dist2AQ, is.na(totalfish)==FALSE)



# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub_NS <- subset(NSinv, Year >2001 & Year<2013 & is.na(Lat)==FALSE)
dist2AQ_sub_NS <- ddply(.data=dist2AQ_sub_NS, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))
dist2AQ <- join(d5, dist2AQ_sub_NS, type="left")
dist2AQ_NS <- subset(dist2AQ, is.na(totalfish)==FALSE)
```


## Nova Scotia - Calculate propagule pressure for each river. 
```{r}
dist2AQ_NS[,1:25] <- apply(dist2AQ_NS[,1:25], 2, function(x) as.character(x))
dist2AQ_NS[,1:25] <- apply(dist2AQ_NS[,1:25], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ_NS$P1 <- dist2AQ_NS$totalfish/dist2AQ_NS$APR
dist2AQ_NS$P2 <- dist2AQ_NS$totalfish/dist2AQ_NS$BAD
dist2AQ_NS$P3 <- dist2AQ_NS$totalfish/dist2AQ_NS$BRR
dist2AQ_NS$P4 <- dist2AQ_NS$totalfish/dist2AQ_NS$BRA
dist2AQ_NS$P5 <- dist2AQ_NS$totalfish/dist2AQ_NS$GAK
dist2AQ_NS$P6 <- dist2AQ_NS$totalfish/dist2AQ_NS$GRA
dist2AQ_NS$P7 <- dist2AQ_NS$totalfish/dist2AQ_NS$HAR
dist2AQ_NS$P8 <- dist2AQ_NS$totalfish/dist2AQ_NS$IND
dist2AQ_NS$P9 <- dist2AQ_NS$totalfish/dist2AQ_NS$LAH
dist2AQ_NS$P10 <- dist2AQ_NS$totalfish/dist2AQ_NS$LIS
dist2AQ_NS$P11 <- dist2AQ_NS$totalfish/dist2AQ_NS$MGR
dist2AQ_NS$P12 <- dist2AQ_NS$totalfish/dist2AQ_NS$MER
dist2AQ_NS$P13 <- dist2AQ_NS$totalfish/dist2AQ_NS$MET
dist2AQ_NS$P14 <- dist2AQ_NS$totalfish/dist2AQ_NS$MID
dist2AQ_NS$P15 <- dist2AQ_NS$totalfish/dist2AQ_NS$NIC
dist2AQ_NS$P16 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRV
dist2AQ_NS$P17 <- dist2AQ_NS$totalfish/dist2AQ_NS$PAR
dist2AQ_NS$P18 <- dist2AQ_NS$totalfish/dist2AQ_NS$SAC
dist2AQ_NS$P19 <- dist2AQ_NS$totalfish/dist2AQ_NS$SAD
dist2AQ_NS$P20 <- dist2AQ_NS$totalfish/dist2AQ_NS$SKY
dist2AQ_NS$P21 <- dist2AQ_NS$totalfish/dist2AQ_NS$STW
dist2AQ_NS$P22 <- dist2AQ_NS$totalfish/dist2AQ_NS$STA
dist2AQ_NS$P23 <- dist2AQ_NS$totalfish/dist2AQ_NS$SMA
dist2AQ_NS$P24 <- dist2AQ_NS$totalfish/dist2AQ_NS$TUS
dist2AQ_NS$P25 <- dist2AQ_NS$totalfish/dist2AQ_NS$WHY

# q values
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.character(x))
dist2AQ_NS[,1:10] <- apply(dist2AQ_NS[,1:10], 2, function(x) as.numeric(x))

dist2AQ_NS$P1 <- dist2AQ_NS$totalfish/dist2AQ_NS$ANW
dist2AQ_NS$P2 <- dist2AQ_NS$totalfish/dist2AQ_NS$ESK
dist2AQ_NS$P3 <- dist2AQ_NS$totalfish/dist2AQ_NS$GAK
dist2AQ_NS$P4 <- dist2AQ_NS$totalfish/dist2AQ_NS$LAH
dist2AQ_NS$P5 <- dist2AQ_NS$totalfish/dist2AQ_NS$MED
dist2AQ_NS$P6 <- dist2AQ_NS$totalfish/dist2AQ_NS$MGR
dist2AQ_NS$P7 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRH
dist2AQ_NS$P8 <- dist2AQ_NS$totalfish/dist2AQ_NS$NRV
dist2AQ_NS$P9 <- dist2AQ_NS$totalfish/dist2AQ_NS$SMA
dist2AQ_NS$P10 <- dist2AQ_NS$totalfish/dist2AQ_NS$STW


# sum all pressures for total propagule pressure at a river
prop.press_NS <- apply(as.matrix(dist2AQ_NS[,30:54]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NS <- data.frame(code=nsrivers[,4], lat=nsrivers[,3], long = nsrivers[,2], prop.press = prop.press_NS)

write.csv(prop.press_NS, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure NS_all years_2017-01-06.csv")


# q values
# sum all pressures for total propagule pressure at a river
prop.press_NS_q <- apply(as.matrix(dist2AQ_NS[,15:24]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NS_q <- data.frame(code=NSQ$Code, lat=NSQ$Lat, long = NSQ$Long, prop.press = prop.press_NS_q, q=NSQ$Q)

write.csv(prop.press_NS_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure NS_Q values_2016-12-07.csv")
```


## Nova Scotia - plot propagule pressure
```{r}
dist2AQ_NS_plot <- arrange(subset(dist2AQ_NS, select=c(Site.ID, Lat, Long, totalfish)), -totalfish)
prop.press_NS <- arrange(prop.press_NS, -prop.press)

plot3 <- ggplot() + 
  ggtitle("Aquaculture sites") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.7, -59.5), ylim=c(43.2, 48)) + ### sets boundaries
  geom_point(data=dist2AQ_NS_plot, aes(Long, Lat, size=totalfish), fill="red", shape=21, colour="black") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="Total fish", range = c(0.5,10), limits=c(0,4250000), breaks=c(1,10000, 50000,75000,1000000, 2000000, 4250000))

plot4 <- ggplot() + 
  ggtitle("Propagule pressure (1999-2015)") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend=FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.6, -59.5), ylim=c(43.2, 48)) + ### sets boundaries +
  geom_point(data=prop.press_NS, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="\u03A3(years stocked/dist)")

gA <- ggplotGrob(plot3)
gB <- ggplotGrob(plot4)
grid.newpage()
grid.draw(cbind(gA, gB))



## q values

ggplot() + 
  geom_smooth(data=prop.press_NS_q, aes(prop.press, q), method="lm", se=TRUE) +
  geom_point(data=prop.press_NS_q, aes(prop.press, q)) +
  geom_label_repel(data=prop.press_NS_q, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  xlab("Propagule pressure") +
  ylab("Q value") 

ggplot() + geom_text(data=prop.press_NS, aes(long, lat, label=code))

```





---------------------------------------------------------------------------------------------------------------------
# NEW BRUNSWICK CAGE SITE DISTANCES TEMPLATE CODE ---------------------------------------------------------------------------------------------------------------------

## New Brunswick - read in shapefiles, create raster file
```{r}
## http://ftp.geogratis.gc.ca/pub/nrcan_rncan/vector/canvec/shp/Hydro/
# NB.low <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/canvec_250K_NB_Hydro_shp/waterbody_2.shp", layer="waterbody_2")
# GOM <- readOGR(dsn = "C:/Users/keyserf/Documents/R/canvec/PhysioRegions_WGS84.shp", layer="PhysioRegions_WGS84")
# GOMclip <- gDifference(GOM, NB.low)
# GOMclip <- SpatialPolygonsDataFrame(GOMclip, data=as.data.frame(x=1))

# NB.BOF <- crop(GOM, extent(-67.3, -64.5, 44.5, 47.08))
# NB.BOF2 <- crop(NB.low, extent(-67.3, -64.5, 44.5, 47.1)) ### This makes stripes through grand manan??

NB <- getData("GADM", country="CAN", level=2)
NB.BOF <- crop(NB, extent(-67.3, -64.5, 44.5, 46))
#NB.prov <-crop(NB, extent(-67.85, -63.7, 44.5, 48.1))
plot(NB.BOF)
# creating raster
r <- raster(ncol=1100, nrow=850)
extent(r) <- extent(NB.BOF)
NBrast <- rasterize(NB.BOF, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive).
NBrast@data@values <- ifelse(is.na(NBrast@data@values)=="FALSE", 10000, 1)

plot(NBrast)
# if shoreline needed:
# NBline <- readOGR("C:/Users/keyserf/Documents/R/canvec/canvec_250K_NB_Land_shp/shoreline_1.shp", "shoreline_1")

# create transition layer for raster (likelihood of presence within cell). 
tr4 <- transition(1/NBrast, transitionFunction=mean, directions=8)
tr4c <- geoCorrection(tr4, type="c")

plot(raster(tr4c))


# for q values
# creating raster
r <- raster(ncol=972, nrow=1188) # 1 grid cell = 3km2
extent(r) <- extent(NB.prov)
NBprovrast <- rasterize(NB.prov, r, fun="first")

# Change values in raster so that land is impassable (i.e. distances would be massive).
NBprovrast@data@values <- ifelse(is.na(NBprovrast@data@values)=="FALSE", 10000, 1)

# create transition layer for raster (likelihood of presence within cell). 
tr4q <- transition(1/NBprovrast, transitionFunction=mean, directions=8)
tr4cq <- geoCorrection(tr4q, type="c")

plot(raster(tr4cq))

```


## New Brunswick - AQ site coordinates and river mouths
```{r}
# site coords

# read in sites from annual NB stocking. Adjust years as desired. Min for NB is 1998, max is 2016. 
NB_stocking <- read.csv("C:/Users/keyserf/Documents/Data/R output/NB_stocking.csv")
sitecoords <- unique(subset(NB_stocking, is.na(lat)=="FALSE", select=c("Site.ID","lat", "long")))
x <- sitecoords$long
y <- sitecoords$lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

## New Brunswick river mouths
morris <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Morris et al 2008 data.csv", header=TRUE)

nbrivers <- as.data.frame(unique(morris$River[morris$ProvState=="NB"]))
names(nbrivers) <- c("river")
coords_clean <- rbind(c(45.545066, -66.011293), 
               c(45.422197, -65.402976),
               c(45.262844, -65.781699),
               c(45.179130, -66.987045),
               c(45.131204, -67.068731),
               c(45.199799, -67.261215),
               c(45.118038, -66.876022),
               c(47.074048, -65.399438),
               c(45.570888, -65.774480),
               c(45.957255, -66.618207),
               c(45.502517, -66.072903),
               c(45.167935, -67.194878),
               c(45.610963, -64.957627),
               c(45.206954, -67.147044))
nbrivers <- cbind(nbrivers, coords_clean)

names(nbrivers) <- c("River", "lat", "long")

plot(NBrast)
plot(NB.low, add=TRUE)
points(nbrivers[,3], nbrivers[,2], col="red")
nbrivers[,2:3] <- rbind(c(45.25795, -66.04133),# BIB
                    c(45.40349, -65.40872), # BSR
                    c(45.25354, -65.79461), # BKR
                    c(45.14328, -66.97758), # BOC
                    c(45.11682, -67.02819), # CHS
                    c(45.18298, -67.27490), # DNS
                    c(45.12123, -66.91432), # MDR
                    c(NA, NA),              # MIR
                    c(45.12123, -66.91432), # MTB
                    c(45.24913, -66.04765), # NSH
                    c(45.24913, -66.04765), # SJR
                    c(45.16092, -67.19266), # SCR
                    c(45.58872, -64.93427), # USR
                    c(45.17416, -67.15471)) # WAR

nbrivers2 <- subset(nbrivers, is.na(lat)=="FALSE")
nbrivers2$code <- c("BIB", "BSR", "BKR", "BOC", "CHS", "DNS", "MDR", "MTB", "NSH", "SJR", "SCR", "USR", "WAR")


# for q-values

NBQ <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/NS Q values.csv", header=TRUE) 
head(NBQ)

names(NBQ) <- c("Code", "Q", "Distance")

qsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Moore_Salmon_Coords.csv")

NBQ <- join(NBQ, qsitecoords, type="left")
NBQ <- NBQ[!is.na(NBQ$Lat)==TRUE,]
NBQ <- subset(NBQ, Site %in% c("Big Salmon", "Jacquet", "Miramichi", "Nashwaak", "Tobique"))

NBQ[1, 5:6] <- c(-65.40428, 45.41445)
# NBQ[2, 5:6] <- c(-66.02681, 47.93944)
# NBQ[3, 5:6] <- c(-65.34352, 47.08349)
NBQ[4, 5:6] <- c(-66.03602, 45.24463)
NBQ[5, 5:6] <- c(-66.03602, 45.24463)

# plot(NB.prov, xlim=c(-66, -67), ylim=c(47.5, 48.5))
# plot(NB.low, add=TRUE)
# text(NBQ[,5], NBQ[,6], col="red")
# click()

# remove Gulf sites because no NB aquaculture on that side, and unreliable to combine NS and NB inventory data. 
NBQ <- NBQ[c(1,4:5),]

```


## New Brunswick - calculate distance matrix
```{r}
# calculate least-cost distance between siterast (site location) and testrast (escaped fish location)
d4 <- costDistance(tr4c, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(nbrivers2[,3]), as.numeric(nbrivers2[,2])))

d4 

# for Q value analysis
# d4q <- costDistance(tr4cq, fromCoords = cbind(as.numeric(siterast[,1]), as.numeric(siterast[,2])), toCoords = cbind(as.numeric(NBQ[,5]), as.numeric(NBQ[,6])))

# d4q
```


## New Brunswick - merge with site coords and inventory data
```{r}
d4 <- as.data.frame(cbind(d4, sitecoords$Site.ID))
colnames(d4)[14] <- "Site.ID"
colnames(d4)[1:13] <- as.list(as.character(nbrivers2$code))

# for q values

d4q <- as.data.frame(cbind(d4q, sitecoords$Site.ID))
colnames(d4q)[4] <- "Site.ID"
colnames(d4q)[1:3] <- as.list(as.character(NBQ$Code))

```


## New Brunswick - pick the years you want and summarize
```{r}
dist2AQ_sub <- subset(NB_stocking, Year >1998 & Year<2016 & is.na(lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, lat, long),
                     summarize,
                     totalfish=sum(totalfish))

dist2AQ <- join(d4, dist2AQ_sub, type="left")
# for qvalues
dist2AQ <- join(d4q, dist2AQ_sub, type="left")

dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)



# for distance only (no inventory numbers, just site y/n)
dist2AQ_sub <- subset(NB_stocking, Year >2001 & Year<2013 & is.na(lat)==FALSE)
dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, lat, long),
                     summarize,
                     totalfish=length(unique(Year)))
dist2AQ <- join(d4q, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

# Add extra distance for TOB and NSH since they are upstream. 116km for NSH and 293 km for TOB.
dist2AQ$TOB <- dist2AQ$TOB + 293000
dist2AQ$NSH <- dist2AQ$NSH + 116000
```


## New Brunswick - Calculate propagule pressure for each river. 
```{r}
dist2AQ[,1:13] <- apply(dist2AQ[,1:13], 2, function(x) as.character(x))
dist2AQ[,1:13] <- apply(dist2AQ[,1:13], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BIB
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$BSR
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$BKR
dist2AQ$P4 <- dist2AQ$totalfish/dist2AQ$BOC
dist2AQ$P5 <- dist2AQ$totalfish/dist2AQ$CHS
dist2AQ$P6 <- dist2AQ$totalfish/dist2AQ$DNS
dist2AQ$P7 <- dist2AQ$totalfish/dist2AQ$MDR
dist2AQ$P8 <- dist2AQ$totalfish/dist2AQ$MTB
dist2AQ$P9 <- dist2AQ$totalfish/dist2AQ$NSH
dist2AQ$P10 <- dist2AQ$totalfish/dist2AQ$SJR
dist2AQ$P11 <- dist2AQ$totalfish/dist2AQ$SCR
dist2AQ$P12 <- dist2AQ$totalfish/dist2AQ$USR
dist2AQ$P13 <- dist2AQ$totalfish/dist2AQ$WAR


## for q values
dist2AQ[,1:3] <- apply(dist2AQ[,1:3], 2, function(x) as.character(x))
dist2AQ[,1:3] <- apply(dist2AQ[,1:3], 2, function(x) as.numeric(x))

# For each AQ site, caclulate total fish/distance from river
## original calculation
dist2AQ$P1 <- dist2AQ$totalfish/dist2AQ$BSR
dist2AQ$P2 <- dist2AQ$totalfish/dist2AQ$NSH
dist2AQ$P3 <- dist2AQ$totalfish/dist2AQ$TOB



# sum all pressures for total propagule pressure at a river
prop.press_NB_all <- apply(as.matrix(dist2AQ[,18:30]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NB_all <- data.frame(code=nbrivers2$code, lat=nbrivers2[,2], long = nbrivers2[,3], prop.press = prop.press_NB_all)

write.csv(prop.press_NB_all, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NB_lin_all years_2016-12-02.csv")


# for qvalues
# sum all pressures for total propagule pressure at a river
prop.press_NB_q <- apply(as.matrix(dist2AQ[,8:10]), 2, function(x) sum(x, na.rm=TRUE))

# match to river mouth coords
prop.press_NB_q <- data.frame(code=NBQ$Code, lat=NBQ[,6], long = NBQ[,5], prop.press = prop.press_NB_q, q=NBQ$Q)

write.csv(prop.press_NB_q, "C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NB_q values_2016-12-07.csv")

```


## New Brunswick - plot propagule pressure
```{r}
dist2AQ_sub_plot <- subset(dist2AQ_sub, totalfish > 0)
dist2AQ_sub_plot$lat <- as.numeric(dist2AQ_sub_plot$lat)
dist2AQ_sub_plot$long <- as.numeric(dist2AQ_sub_plot$long)

dist2AQ_sub_plot <- arrange(dist2AQ_sub_plot, -totalfish)
prop.press_NB_all <- arrange(prop.press_NB_all, -prop.press)

### get shapefiles in <Maritimes and NL maps.R>


plot1 <- ggplot() + 
  ggtitle("Aquaculture sites") +
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  coord_map(xlim=c(-67.3, -64.3), ylim=c(44.5, 46)) + ### sets boundaries
  theme_bw() + ### my favourite theme settings here and below (makes land white)
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  geom_point(data=dist2AQ_sub_plot, aes(long, lat, size=totalfish), fill="red", shape=21, colour="black") +    scale_size_continuous(name="Total fish", range = c(0.5,8), limits=c(1,2500000), breaks=c(100, 1000, 10000, 100000, 1000000, 2500000))



plot2 <- ggplot() + 
  ggtitle("Propagule pressure (2000-2012)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=PE.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  #geom_spatial(data=NS.low, aes(fill=ctry_en)) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_NB_all, aes(long, lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  theme_bw() + ### my favourite theme settings here and below (makes land white)
  coord_map(xlim=c(-67.4, -64.3), ylim=c(44.5, 46)) + ### sets boundaries
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_size_continuous(name="\u03A3(total fish/dist)", range = c(0.5,8), limits=c(100,6000), breaks=c(500, 1000, 2000, 4000, 6000))

gA <- ggplotGrob(plot1)
gB <- ggplotGrob(plot2)
grid.newpage()
grid.draw(cbind(gA, gB))
### PNG 1500*600

## q values

ggplot() + 
  geom_smooth(data=prop.press_NB_q, aes(prop.press, q), method="lm", se=TRUE) +
  geom_point(data=prop.press_NB_q, aes(prop.press, q)) +
  geom_label_repel(data=prop.press_NB_q, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  xlab("Propagule pressure") +
  ylab("Q value") 



### TRYING HEATMAP

# ?rasterize
# test <- rasterize(c(dist2AQ_sub_plot$long, dist2AQ_sub_plot$lat), r, fun=sum(dist2AQ_sub_plot$totalfish))
# 
# test <- dist2AQ_sub_plot
# 
# coordinates(test) <- ~long+lat
# 
# proj4string(test) <- CRS("+proj=longlat +ellps=GRS80 +no_defs") # set it to lat-long
# test <- spTransform(test,CRS("+proj=longlat +ellps=GRS80 +no_defs"))
# gridded(test) <- TRUE
# r2 <- raster(test)
# projection(r2) <- CRS("+proj=longlat +ellps=GRS80 +no_defs")
# 
# hpars<-read.table("https://sites.google.com/site/arunsethuraman1/teaching/hpars.dat?revision=1")#Read in the density data
# 
# head(hpars)
# positions <- data.frame(lon=rnorm(20000, mean=-75.1803458, sd=0.05), lat=rnorm(10000,mean=39.98352197, sd=0.05))
# 
# dist2AQ_sub_plot$adj <- dist2AQ_sub_plot$totalfish/1000
# test <- data.frame(lat=rep(dist2AQ_sub_plot$lat, round(dist2AQ_sub_plot$adj,0)), long=rep(dist2AQ_sub_plot$long, round(dist2AQ_sub_plot$adj, 0)))
# 
# 
# can <- readOGR("C:/Users/keyserf/Documents/R/canvec/canada.shp", layer="canada")
# can <- fortify(can)
# 
# usa <- readOGR("C:/Users/keyserf/Documents/R/canvec/usa.shp", layer="usa")
# usa <- fortify(usa)
# 
# ggplot() + 
#   geom_polygon(data=can, aes(long, lat, group=group)) +
#   geom_polygon(data=usa, aes(long, lat, group=group)) +
#   coord_map(xlim=c(-68, -66), ylim=c(44.25, 45.5)) +
#   geom_density2d(data = test, aes(x = long, y = lat), size = 0.3) + 
#   stat_density2d(data = test, aes(x = long, y = lat, fill = ..level.., alpha = ..level..), size = 0.01, 
#     bins = 16, geom = "polygon") + 
#   scale_fill_gradient(low = "green", high = "red") + 
#   scale_alpha(range = c(0, 0.3), guide = FALSE)
# ?geom_density2d
# 
# ggplot() +
#   geom_density2d(data = test, aes(x = long, y = lat), size = 0.3) + 
#   #stat_density2d(data = test, aes(x = long, y = lat, fill = ..level.., alpha = ..level..), size = 0.01, 
#     bins = 16, geom = "polygon") + 
#   scale_fill_gradient(low = "green", high = "red") + 
#   scale_alpha(range = c(0, 0.3), guide = FALSE) +
#   geom_spatial(can) +
#   geom_spatial(usa) +
#   coord_map(xlim=c(-68, -66), ylim=c(44.25, 45.5))


```

## all q values together with distance-only pressure
```{r}
qvals <- rbind(prop.press_NB_q, prop.press_NS_q)

names(qsites)


prop.press_NL_q <- read.csv("C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_qvalues_2005-2012_2016-12-06.csv")

prop.press_NL_q <- data.frame(code=qsites$Code, lat=qsites$Lat, long=qsites$Long, prop.press=qsites$prop.press, q=qsites$Q)

prop.press_NL_q <- join(prop.press_NL_q, qsites, type="left")



qvals$prov <- c(rep("NB", 3), rep("NS", 10), rep("NL", 15))

qvals <- subset(qvals, !code %in% c("TOB", "NSH"))

model_all <- lm(data=qvals, q~prop.press)
summary(model_all)
qvals[,7:9] <- predict(qvals, object=model_all, interval=c("confidence"), level=0.95)

qvals[,10:12] <- predict(qvals, object=model_all, interval=c("confidence"), level=0.97)
qvals$out <- ifelse(qvals$q < qvals$V11 | qvals$q > qvals$V12, "out", "in")

statlabel <- paste0("slope = ", round(coefficients(model_all)[2], 4), "              adj. Rsq. = ", round(summary(model_all)$adj.r.squared, 4), "              p-value = ", round(anova(model_all)[1,5],4))


ggplot() + 
  geom_smooth(data=prop.press_NL_q, aes(prop.press.prop.press, Q), colour="black", method="lm", se=FALSE) +
  geom_point(data=prop.press_NL_q, aes(prop.press.prop.press, Q), colour="black", size=3, alpha=0.5) +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V7)) +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V8), lty="dashed") +
  #geom_line(data=qvals[qvals$prov %in% c("NS", "NL"),], aes(prop.press, V9), lty="dashed") +
  #geom_label_repel(data=qvals, aes(prop.press, q, label=code)) +
  theme_classic() + 
  theme(panel.background=element_rect(colour="black")) +
  # scale_shape_manual(values=c(21,22,23), labels=c("NL (2005-2012)", "NS (2002-2012)"))+
  # scale_fill_discrete(labels=c("NL (2005-2012)", "NS (2002-2012)"))+
  xlab("Propagule pressure") +
  ylab("Q value") +
  geom_text_repel(data=prop.press_NL_q, aes(prop.press.prop.press, Q, label=Code), size=3)+
  ggtitle("Newfoundland 2005-2012")
  #geom_text(data=NULL, aes(0.0045, 0.27, label=paste0("slope = ", round(coefficients(model_all)[2], 4), "\nadj. Rsq. = ", round(summary(model_all)$adj.r.squared, 4), "\np-value = ", round(anova(model_all)[1,5],4))), size=4, hjust=0, ) +
  #facet_wrap(~prov, scales="free_x") +
  #ggtitle(statlabel) +
  #scale_x_continuous()
  
sfa <- read.csv("C:/Users/keyserf/Documents/Data/R output/Propagule Pressure_NL_sfa rivers_2005-2015_2017-01-16.csv")
hybrids <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Hybrid Proportions Output.csv")
names(hybrids)
colnames(sfa)[9]<-"River"

hybrids <- join(hybrids, sfa, type="left")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pHybNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pHybNC), method="lm", se=FALSE) + 
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pHybNC, label=River), size=3)+
  xlab("Propagule pressure")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pFarmNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pFarmNC), method="lm", se=FALSE) +
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pFarmNC, label=River), size=3)+
  xlab("Propagule pressure")

ggplot() + geom_point(data=hybrids, aes(Propagule.pressure, pWildNC)) + 
  geom_smooth(data=hybrids, aes(Propagule.pressure, pWildNC), method="lm", se=FALSE) +
  theme_classic() +
  theme(panel.background=element_rect(colour="black")) +
  geom_text_repel(data=hybrids, aes(Propagule.pressure, pWildNC, label=River), size=3)+
  xlab("Propagule pressure")



```



### ALL PROVS COMBINED
```{r}
atlcan <- getData("GADM", country="CAN", level=2)
atlcan <- crop(atlcan, extent(-68, -59, 42, 48))

plot(atlcan)

maritimes <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Maritimes coordinates.csv")

maritimes <- subset(maritimes, Long<0)

NSsitecoords <- read.csv("C:/Users/keyserf/Documents/Data/Inventory data/NS I&T/NS IT sites_FK_EP_FK.csv", header=TRUE)
sitecoords <- unique(subset(NSsitecoords, is.na(Lat)=="FALSE", select=c("Site.ID","Lat", "Long")))
x <- sitecoords$Long
y <- sitecoords$Lat
xy <- cbind(x, y)
siterast <- as.matrix(xy)

siterast[13,] <- c(-65.74858, 44.65102)
siterast[1,] <- c(-64.32808,  44.41282)
siterast[6,] <- c(-60.84400, 45.67315)
siterast[10,] <- c(-60.84400, 45.67315)
siterast[2,] <- c(-60.97440, 45.99829)

sitecoords$prov <- "NS"

NB_stocking <- read.csv("C:/Users/keyserf/Documents/Data/R output/NB_stocking.csv")
sitecoords2 <- unique(subset(NB_stocking, is.na(lat)=="FALSE", select=c("Site.ID","lat", "long")))
x <- sitecoords2$long
y <- sitecoords2$lat
xy2 <- cbind(x, y)
siterast2 <- as.matrix(xy2)

names(sitecoords2) <- c("Site.ID", "Lat", "Long")
sitecoords2$prov <- "NB"

sitecoords_all <- rbind(sitecoords, sitecoords2)


# Get shapefile
atlcan <- getData("GADM", country="CAN", level=3)
extent(atlcan)

# crop it
atlcan <- crop(atlcan, extent(-68, -59, 41.67693, 50))

#build raster file
r <- raster(ncols=700, nrow=526)
extent(r) <- extent(atlcan)
MARrast <- rasterize(atlcan, r, fun="first")

#save it in case of changes
MARrast2 <- MARrast

#change land values to make them impassable
MARrast2@data@values <- ifelse(is.na(MARrast2@data@values)=="FALSE", 100000, 1)

#canso causeway is impassable
MARrast2@data@values <- ifelse(coordinates(MARrast2)[,1] > -61.42577 & coordinates(MARrast2)[,1] < -61.414002 & coordinates(MARrast2)[,2] > 45.641238 & coordinates(MARrast2)[,2] < 45.647156, 1000000, MARrast2@data@values)

#transition layers
trmar <- transition(1/MARrast2, transitionFunction=mean, directions=8)
trmarc <- geoCorrection(trmar, type="c")

#remove the rivers that are on land by making a list of good rivers
bad<-data.frame(extract(x = MARrast2, y = SpatialPoints(coords = cbind(maritimes$Long, maritimes$Lat), proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))))
bad$Name <- maritimes$Name
get_good <- which(bad[,1] == 1)

#calculate least-cost distance
dmar2 <- costDistance(trmarc, fromCoords = cbind(as.numeric(sitecoords_all$Long), as.numeric(sitecoords_all$Lat)), 
                      toCoords = cbind(as.numeric(maritimes$Long[get_good]), as.numeric(maritimes$Lat[get_good])))

#set colnames in matrix to be the good rivers from maritimes df
colnames(dmar2) <- maritimes$Name[get_good]

#remove the "pond" columns
dmar3 <- dmar2[,(dmar2[1, ] < 10000000)]

#cbind the AQ site IDs
dmar3 <- as.data.frame(cbind(dmar3, sitecoords_all$Site.ID))
colnames(dmar3)[104] <- "Site.ID"

#get the true water sites by stealing the column names.
maritimes3 <- as.character(colnames(dmar3)[1:103])
maritimes$Name <- as.character(maritimes$Name)
maritimes2 <- subset(maritimes, Name %in% maritimes3)
arrange(maritimes2, Name)$Name

dist2AQ_NB <- subset(NB_stocking, Year >1999 & Year<2013 & is.na(lat)==FALSE)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")
dist2AQ_NS <- subset(NSinv, Year >1999 & Year<2013 & is.na(Lat)==FALSE)

names(dist2AQ_NB) <- c("X", "Site.ID", "Year", "totalfish", "Long", "Lat", "Area")
names(dist2AQ_NS)

dist2AQ_NB <- dist2AQ_NB[,c(1,2,3,4,6,5)]

dist2AQ_sub <- rbind(dist2AQ_NB, dist2AQ_NS)
dist2AQ_sub <- dist2AQ_sub[,2:6]
#dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))

dist2AQ <- join(dmar3, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)


dist2AQ[,1:103] <- apply(dist2AQ[,1:103], 2, function(x) as.character(x))
dist2AQ[,1:103] <- apply(dist2AQ[,1:103], 2, function(x) as.numeric(x))

dist2AQ[dist2AQ == 0] <- 1000

# for byyear calcs, change totalfish to 1 (1 year)
dist2AQ$totalfish <- 1

# For each AQ site, caclulate total fish/distance from river
## original calculation
test <- c(dist2AQ$totalfish/dist2AQ[,1:103])
dist2AQ <- cbind(dist2AQ, test)

# sum all pressures for total propagule pressure at a river
prop.press_MILLIONRIVERS <- apply(as.matrix(dist2AQ[,108:210]), 2, function(x) sum(x, na.rm=TRUE))

# for each year
prop.press_2000 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2000, 109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2001 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2001,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2002<- apply(as.matrix(dist2AQ[dist2AQ$Year==2002,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2003<- apply(as.matrix(dist2AQ[dist2AQ$Year==2003,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2004<- apply(as.matrix(dist2AQ[dist2AQ$Year==2004,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2005<- apply(as.matrix(dist2AQ[dist2AQ$Year==2005,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2006<- apply(as.matrix(dist2AQ[dist2AQ$Year==2006,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2007<- apply(as.matrix(dist2AQ[dist2AQ$Year==2007,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2008<- apply(as.matrix(dist2AQ[dist2AQ$Year==2008,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2009<- apply(as.matrix(dist2AQ[dist2AQ$Year==2009,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2010<- apply(as.matrix(dist2AQ[dist2AQ$Year==2010,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2011<- apply(as.matrix(dist2AQ[dist2AQ$Year==2011,  109:211]), 2, function(x) sum(x, na.rm=TRUE))
prop.press_2012<- apply(as.matrix(dist2AQ[dist2AQ$Year==2012,  109:211]), 2, function(x) sum(x, na.rm=TRUE))


prop.press_byyear <- data.frame(prop.press=c(prop.press_2000, prop.press_2001, prop.press_2002, prop.press_2003, prop.press_2004, prop.press_2005, prop.press_2006, prop.press_2007, prop.press_2008, prop.press_2009, prop.press_2010, prop.press_2011, prop.press_2012), year=rep(2000:2012, each=103), Name=rep(maritimes2$Name, 13), Lat=rep(maritimes2$Lat, 13), Long=rep(maritimes2$Long, 13))

write.csv(prop.press_byyear, "C:/Users/keyserf/Documents/Data/R output/prop.press_byyear_2017-01-20.csv")

# match to river mouth coords
prop.press_MILLIONRIVERS <- data.frame(Name = maritimes2$Name, Lat=maritimes2$Lat, Long =maritimes2$Long, prop.press = prop.press_MILLIONRIVERS, sfa=maritimes2$SFA)

write.csv(prop.press_MILLIONRIVERS, "C:/Users/keyserf/Documents/Data/R output/prop.press_maritimes_2017-01-20.csv")

prop.press_MILLIONRIVERS <- arrange(prop.press_MILLIONRIVERS, -prop.press)

ggplot() + 
  ggtitle("Propagule pressure (2000-2012)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_MILLIONRIVERS, aes(Long, Lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  coord_map(xlim=c(-68, -59.5), ylim=c(43.3, 48)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  scale_size_continuous(name="\u03A3(years stocked/dist)", range = c(0.5,8))


View(dist2AQ[1:20,c(103:108,211)])

prop.press_byyear <- arrange(prop.press_byyear, -prop.press)

ggplot() + 
  ggtitle("Propagule pressure (by year)")+
  geom_spatial(data=NB.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=PE.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  geom_spatial(data=NS.low, aes(fill=ctry_en), show.legend = FALSE) + ### canvec spatialpolygonsdataframe
  scale_fill_manual(values=c("grey"), guide=FALSE) + ### fills geom_spatials with grey
  geom_polygon(data=GOMclip, aes(long, lat, group=group), fill="grey") + ### Gulf of Maine shapefile to get Grand Manan & Maine
  #geom_path(data=CA.df, aes(long, lat, group=group),colour="black") + ### plots black outline on provinces
  annotate(geom="rect", xmin=-60, xmax=-59.5, ymin=47.5, ymax= 48, fill="grey") + ### these annotates hide white space!
  annotate(geom="rect", xmin=-64, xmax=-59.5, ymin=43.2, ymax= 44, fill="grey") +
  annotate(geom="rect", xmin=-61, xmax=-59.5, ymin=44, ymax= 45, fill="grey") +
  geom_point(data=prop.press_byyear, aes(Long, Lat, size=prop.press), fill="yellow", shape=21, colour="black") +
  coord_map(xlim=c(-68, -59.5), ylim=c(43.3, 48)) + ### sets boundaries
  theme_classic() + ### favourite theme settings plus makes sure land is white
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  scale_size_continuous(name="\u03A3(1/dist)", range = c(0.5,8)) +
  facet_wrap(~year, nrow=2)



levels(prop.press_MILLIONRIVERS$sfa) <- c("SFA 18", "SFA 19", "SFA 20", "SFA 21", "SFA 22", "SFA 23", "SFA 15", "SFA 15", "SFA 16", "SFA 17")

prop.press_MILLIONRIVERS$sfa <- factor(prop.press_MILLIONRIVERS$sfa, c("SFA 15", "SFA 16", "SFA 17", "SFA 18",
                                                                       "SFA 19", "SFA 20", "SFA 21", "SFA 22", "SFA 23"))


prop.press_sfa$Name <- factor(prop.press_sfa$Name, levels=prop.press_sfa$Name[order(prop.press_sfa$Number)], ordered=TRUE)
prop.press_MILLIONRIVERS$Name <- factor(prop.press_MILLIONRIVERS$Name, levels=prop.press_MILLIONRIVERS$Name[order(prop.press_MILLIONRIVERS$Long)], ordered=TRUE)

ggplot() + geom_point(data=prop.press_MILLIONRIVERS, aes(prop.press, Name)) + facet_grid(sfa~., scales="free_y", space="free") +
  theme_bw() + 
  theme(panel.background = element_blank(), panel.border=element_rect(colour="black", fill=NA)) +
  xlab("Propagule pressure (2000-2012)") +
  ylab("River name")




```

### Assigning DU's
```{r}
sfalist <- read.csv("C:/Users/keyserf/Documents/Data/Rivers/Salmon Fishing Areas and Rivers.csv")

# Get shapefile
atlcan <- getData("GADM", country="CAN", level=1)
extent(atlcan)

# crop it
can <- crop(atlcan, extent(-77, -52, 43, 59))
can <- fortify(can)

colnames(sfalist)[c(2,5,6,7,8)] <- c("SFA", "Number", "Long", "Pos", "Lat")
sfalist$Long <- -sfalist$Long

sfalist <- sfalist[sfalist$Long<0,]

sfalist$COSEWIC.DU <- as.character(sfalist$COSEWIC.DU)

ggplot() + #geom_polygon(data=can, aes(long, lat, group=group)) +
  geom_point(data=sfalist[sfalist$SFA%in%c("Q8", "Q9"),], aes(Long, Lat, colour=SFA)) +
  #geom_text_repel(data=sfalist[sfalist$SFA%in%c("Q8","Q9"),], aes(Long, Lat, colour=SFA, label=River.name)) +
  coord_map(xlim=c(-61, -58)), ylim=c(50, 51))

test <- subset(sfalist, Province =="Labrador" | SFA=="Q9" & Long > -61.60047)
test <- subset(sfalist, SFA=="Q9")

ggplot() + geom_point(data=test, aes(Long, Lat, colour=SFA)) +
  #geom_text_repel(data=sfalist, aes(Long, Lat, colour=SFA, label=River.name))+
  coord_map()

min(sfalist$Long[sfalist$SFA=="Q9"])

## DU 7
sfalist$COSEWIC.DU <- ifelse(sfalist$Long > -61.370021 & sfalist$Long < -58.131350 & sfalist$SFA %in% c("Q8", "Q9"), "DU-7", sfalist$COSEWIC.DU)

# DU 8
sfalist$COSEWIC.DU <- ifelse(sfalist$Long > -69.405171 & sfalist$Long < -61.60047 & sfalist$Lat> 48 & sfalist$Lat < 51 & sfalist$SFA %in% c("Q8", "Q7"), "DU-8", sfalist$COSEWIC.DU)

#DU 2
sfalist$COSEWIC.DU <- ifelse(sfalist$Province =="Labrador" | sfalist$Long > -58.131351 & sfalist$SFA %in% c("Q8", "Q7", "Q9"), "DU-2", sfalist$COSEWIC.DU)

ggplot() + geom_point(data=sfalist, aes(Long,Lat, colour=COSEWIC.DU)) + coord_map()

str(sfalist)

```

### reports
```{r}

reports <- read.csv("C:/Users/keyserf/Documents/Data/Escape events and reports/Escapee reports_2017-01-13.csv")

reports <- reports[,c(1:12)]

ddply(.data=reports, .(Year),
      summarize, 
      nreports = length(unique(River)))

reports$Year.adj <- as.numeric(as.character(reports$Year))

new <- subset(reports, Year.adj > 2007)

## add bradbury sampling sites (BDN, GAR, LTR, FBN, SMB)

brad2015 <- ddply(.data=bradprops2015, .(River),
                  summarize,
                  totalfarmed = sum(Esc),
                  totalsamp = sum(total))

brad2015[is.na(brad2015)] <- 0

brad2015$propfarmed <- brad2015$totalfarmed / brad2015$totalsamp

brad2015$River[brad2015$River == "Northwest River"] <-  "North West Brook 1"
brad2015$River[brad2015$River == "Simm's Brook"] <-  "Simmons Brook"

colnames(brad2015)[2] <- "TotalFarmed"
colnames(brad2015)[3] <- "TotalCombined"

brad2015$ProvState <- "NL"
brad2015$Year.adj <- 2015

brad2015 <- brad2015[,c(1:3,5:6)]

new <- join(new, brad2015, type="full")

nsrivers <- nsrivers[,c(1,3,2,4)]

marreports <- rbind(nbrivers2, nsrivers)

nlrivers <- sched[,c(3,6,7)]
names(nlrivers) <- c("River", "long", "lat")
nlrivers$code <- NA


atlreports <- rbind(marreports, nlrivers)

atlreports$River <- as.character(atlreports$River)

atlreports[10,1] <- "St. John River"
atlreports[22,1] <- "Lahave"
atlreports[29,1] <- "North (CB)"


new <- join(new, atlreports, type="left")
new[new$River=="Clyburn",14] <- 46.661677
new[new$River=="Clyburn",15] <- -60.397694

new[,c(1,14:16)]

new$PropFarmed <- as.numeric(new$TotalFarmed) / as.numeric(new$TotalCombined)

newreports <- unique(new[,c(1,14:15)])
newreports[newreports$River=="Magaguadavic",2:3] <- c(45.122017, -66.910076)
newreports[newreports$River=="Conne River",2:3] <- c(45.867332, -55.801525)


ggplot() + geom_point(data=new, aes(long, lat, size=as.numeric(PropFarmed))) + coord_map()

names(annual)
NLinv <- annual[,c(1,2,5,6)]
names(NLinv) <- c("X", "Site.ID", "Lat", "Long")
NLinv$prov <- "NL"

sitecoords_atl <- rbind(sitecoords_all, NLinv)
sitecoords_atl <- unique(sitecoords_atl[,2:5])
sitecoords_atl <- sitecoords_atl[is.na(sitecoords_atl$Long)==FALSE,]

sitecoords_atl[132,3:2] <- c(-55.86193, 47.73514) 
sitecoords_atl[150,3:2] <- c(-55.82891, 47.54275)
sitecoords_atl[161,3:2] <- c(-55.82891, 47.54275)

allatl <- getData("GADM", country="CAN", level=2)
allatl <- crop(allatl, extent(-68, -53, 42, 49))

#build raster file
r <- raster(ncols=1200, nrows=700)
extent(r) <- extent(allatl)
ATLrast <- rasterize(allatl, r, fun="first")

#save it in case of changes
ATLrast2 <- ATLrast
plot(ATLrast2)

#change land values to make them impassable
ATLrast2@data@values <- ifelse(is.na(ATLrast2@data@values)=="FALSE", 100000, 1)

#canso causeway is impassable
ATLrast2@data@values <- ifelse(coordinates(ATLrast2)[,1] > -61.42577 & coordinates(ATLrast2)[,1] < -61.414002 & coordinates(ATLrast2)[,2] > 45.641238 & coordinates(ATLrast2)[,2] < 45.647156, 1000000, ATLrast2@data@values)

#transition layers
tratl <- transition(1/ATLrast2, transitionFunction=mean, directions=8)
tratlc <- geoCorrection(tratl, type="c")

datl_new <- costDistance(tratlc, fromCoords = cbind(as.numeric(sitecoords_atl$Long), as.numeric(sitecoords_atl$Lat)), 
                      toCoords = cbind(as.numeric(newreports$long), as.numeric(newreports$lat)))

datl_new <- cbind(datl_new, sitecoords_atl$Site.ID, sitecoords_atl$prov)
datl_new <- as.data.frame(datl_new)
colnames(datl_new)[11] <- "Site.ID"

datl_new <- cbind(datl_new, sitecoords_atl$prov)
colnames(datl_new)[12] <- "prov"

dist2AQ_NB <- subset(NB_stocking, Year >2007 & is.na(lat)==FALSE)

NSsitecoords <- subset(NSsitecoords, select=c(Site.ID, Lat, Long))
NSsitecoords <- unique(NSsitecoords)

NSinv <- join(NSinv, NSsitecoords, type="left")
dist2AQ_NS <- subset(NSinv, Year >2007 & is.na(Lat)==FALSE)

names(dist2AQ_NB) <- c("X", "Site.ID", "Year", "totalfish", "Long", "Lat", "Area")
names(dist2AQ_NS)

dist2AQ_NB <- dist2AQ_NB[,c(1,2,3,4,6,5)]
dist2AQ_NB$prov <- "NB"
dist2AQ_NS$prov <- "NS"

dist2AQ_NL <- annual
names(dist2AQ_NL) <- c("X", "Site.ID", "Year", "totalfish", "Lat", "Long")
dist2AQ_NL$prov <- "NL"

dist2AQ_sub <- rbind(dist2AQ_NB, dist2AQ_NS, dist2AQ_NL)
dist2AQ_sub <- dist2AQ_sub[,2:7]
#dist2AQ_sub <- ddply(.data=dist2AQ_sub, .(Site.ID, Lat, Long),
                     summarize,
                     totalfish=length(unique(Year)))

dist2AQ <- join(datl_new, dist2AQ_sub, type="left")
dist2AQ <- subset(dist2AQ, is.na(totalfish)==FALSE)

dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.character(x))
dist2AQ[,1:15] <- apply(dist2AQ[,1:15], 2, function(x) as.numeric(x))

dist2AQ[dist2AQ == 0] <- 1000

# for byyear calcs, change totalfish to 1 (1 year)
dist2AQ$totalfish <- 1

# For each AQ site, caclulate total fish/distance from river
## original calculation
test <- c(dist2AQ$totalfish/dist2AQ[,1:10])
dist2AQ <- cbind(dist2AQ, test)

# sum all pressures for total propagule pressure at a river
prop.press_atlreports <- apply(as.matrix(dist2AQ[,17:26]), 2, function(x) sum(x, na.rm=TRUE))

# for each year
prop.pressatl_2008 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2008, 17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2009 <- apply(as.matrix(dist2AQ[dist2AQ$Year==2009,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2010<- apply(as.matrix(dist2AQ[dist2AQ$Year==2010,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2011<- apply(as.matrix(dist2AQ[dist2AQ$Year==2011,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2012<- apply(as.matrix(dist2AQ[dist2AQ$Year==2012,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2013<- apply(as.matrix(dist2AQ[dist2AQ$Year==2013,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2014<- apply(as.matrix(dist2AQ[dist2AQ$Year==2014,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2015<- apply(as.matrix(dist2AQ[dist2AQ$Year==2015,  17:26]), 2, function(x) sum(x, na.rm=TRUE))
prop.pressatl_2016<- apply(as.matrix(dist2AQ[dist2AQ$Year==2016,  17:26]), 2, function(x) sum(x, na.rm=TRUE))



prop.press_atl_byyear <- data.frame(prop.press=c(prop.pressatl_2008, prop.pressatl_2009, prop.pressatl_2010, prop.pressatl_2011, prop.pressatl_2012, prop.pressatl_2013, prop.pressatl_2014, prop.pressatl_2015, prop.pressatl_2016), Year=rep(2008:2016, each=10), River=rep(newreports$River, 9), lat=rep(newreports$lat, 9), long=rep(newreports$long, 9))

prop.press_atl_byyear <- join(prop.press_atl_byyear, newreports, type="left")


new2 <- new
colnames(new2)[c(3,13)] <- c("year.desc", "Year")

prop.press_atl_byyear <- join(prop.press_atl_byyear, new2, type="left", by=c("River", "Year"))

prop.press_atl_byyear$PropFarmed <- as.numeric(prop.press_atl_byyear$PropFarmed)

prop.press_atl_byyear$detect <- 0
prop.press_atl_byyear$detect[prop.press_atl_byyear$TotalFarmed > 0] <- 1
prop.press_atl_byyear$detect[is.na(prop.press_atl_byyear$TotalFarmed)] <- NA

prop.press_atl_byyear$sProp.press <- scale(prop.press_atl_byyear$prop.press)
          
scaleList <- list(scale = attr(prop.press_atl_byyear$sProp.press, "scaled:scale"),
                            center = attr(prop.press_atl_byyear$sProp.press, "scaled:center"))


mod <- glmer(detect~sProp.press+1|River,data=prop.press_atl_byyear,family=binomial(link="logit"))
sdata <-  scale(seq(from=0,to=0.0015,by=0.00001),scale=scaleList$scale,center=scaleList$center)
newdata <- data.frame(expand.grid(unique(as.character(prop.press_atl_byyear$River)),sdata),stringsAsFactors = F)
colnames(newdata)=c("River","sProp.press")

prediction <- predict(mod,newdata)
newdata <- cbind(newdata,AICcmodavg::predictSE(mod,newdata,se.fit=T)%>%data.frame())
newdata$fixedprop.press <- newdata$prop.press* scaleList$scale + scaleList$center 

newdata$prop.press <- newdata$sProp.press
plotdata <- filter(newdata,River=="Big Salmon")

ggplot()+
  geom_point(data=prop.press_atl_byyear,aes(x=prop.press,y=detect))+
  geom_point(data=newdata,aes(x=fixedprop.press,y=fit))+
  theme_bw()

ggplot(prop.press_atl_byyear,aes(x=prop.press,y=detect))+geom_point()+theme_bw()

ggplot() + geom_point(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, colour=as.factor(Year))) +
  #geom_boxplot(data=prop.press_atl_byyear, aes(detect, prop.press)) +
  
  theme_bw()
  
#geom_smooth(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, colour=as.factor(Year)), method="lm") + 
  #geom_text_repel(data=prop.press_atl_byyear, aes(prop.press, PropFarmed, label=River, colour=as.factor(Year)), size=2)

write.csv(prop.press_atl_byyear, "C:/Users/keyserf/Documents/Data/R output/prop.press_atl_byyear_2017-01-20.csv")

          
          
## bulk years together
### fix names and classes first
colnames(prop.press_atl_byyear)[4:5] <- c("Lat", "Long")
str(prop.press_atl_byyear)
prop.press_atl_byyear[,8:10] <- apply(prop.press_atl_byyear[,8:10], 2, function(x) as.numeric(x)) 

# NA's in TotalWild, TotalFarmed and TotalCombined indicate that a propagule pressure was calculated for that year, but that there were no reports of escapees

## I checked, and it's correct to simply add together the PP's to get the overall PP!

prop.press_atl <- ddply(.data=prop.press_atl_byyear, .(River, Lat, Long),
                        summarize,
                        totalfarmed = sum(TotalFarmed, na.rm=T),
                        totalsamp = sum(TotalCombined,na.rm=T),
                        totalprop.press = sum(prop.press))

prop.press_atl$propfarmed <- prop.press_atl$totalfarmed / prop.press_atl$totalsamp

ggplot() + geom_point(data=prop.press_atl, aes(totalprop.press, propfarmed)) +
  theme_bw() +
  geom_smooth(data=prop.press_atl, aes(totalprop.press, propfarmed)) + 
  geom_smooth(data=prop.press_atl, aes(totalprop.press, propfarmed), method="lm", colour="red") + 
  geom_text_repel(data=prop.press_atl, aes(totalprop.press, propfarmed, label=River), size=2)
  

yearssampled <- ddply(.data=new2, .(River),
                      summarize,
                      effort = length(unique(Year)))

## Bring over bradprops2015 from Bradbury sampling 2015 script too. 

brad2015 <- ddply(.data=bradprops2015, .(River),
                  summarize,
                  totalfarmed = sum(Esc),
                  totalsamp = sum(total))

brad2015[is.na(brad2015)] <- 0

brad2015$propfarmed <- brad2015$totalfarmed / brad2015$totalsamp


```


